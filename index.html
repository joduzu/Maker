<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced SCT  Tool Builder</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f5f7f9; padding: 40px; }
        .maker-container { max-width: 1200px; margin: 0 auto; background: white; box-shadow: 0 0 20px rgba(0, 0, 0, 0.1); border-radius: 12px; padding: 30px; }
        .maker-header { text-align: center; margin-bottom: 30px; border-bottom: 1px solid #e9ecef; padding-bottom: 20px; }
        .deployment-modalities-card .card-header { display: flex; flex-direction: column; gap: 4px; }
        .deployment-modalities-options { display: flex; flex-wrap: wrap; gap: 12px; }
        .modality-option { border: 1px solid #d0d7ff; border-radius: 50px; padding: 10px 18px; display: flex; align-items: center; gap: 10px; cursor: pointer; transition: all 0.2s ease; background: #f8f9ff; }
        .modality-option:hover { box-shadow: 0 6px 16px rgba(99, 102, 241, 0.15); transform: translateY(-2px); }
        .modality-option input { display: none; }
        .modality-option .modality-icon { width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.9rem; }
        .modality-option .modality-label { font-weight: 600; color: #1f2937; }
        .modality-option.embedded .modality-icon { background: linear-gradient(135deg, #2563eb, #3b82f6); }
        .modality-option.coupled .modality-icon { background: linear-gradient(135deg, #f59e0b, #fbbf24); }
        .modality-option.self-sustained .modality-icon { background: linear-gradient(135deg, #16a34a, #22c55e); }
        .modality-option.selected { border-color: transparent; background: linear-gradient(135deg, rgba(79, 70, 229, 0.2), rgba(99, 102, 241, 0.2)); }
        .subsection-item {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            padding: 16px;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            background: #fff;
            cursor: move;
            transition: all 0.2s ease;
        }

        .subsection-item.dragging {
            opacity: 0.5;
            background: #f0f0f0;
            transform: scale(0.98);
        }

        .subsection-item.drag-over {
            border-top: 3px solid #0d6efd;
        }

        .subsection-drag-handle {
            display: flex;
            align-items: flex-start;
            padding-top: 8px;
            color: #6c757d;
            font-size: 1.2rem;
            cursor: grab;
            user-select: none;
        }

        .subsection-drag-handle:active {
            cursor: grabbing;
        }

        .subsection-content-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0;
        }

        .subsection-collapse-header {
            background: linear-gradient(90deg, #eef2ff 0%, #f7f9ff 100%);
            padding: 12px 16px;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid #e0e7ff;
            margin-bottom: 0;
        }

        .subsection-collapse-header:hover {
            background: linear-gradient(90deg, #e0e7ff 0%, #eef2ff 100%);
        }

        .subsection-collapse-header[aria-expanded="true"] {
            background: linear-gradient(90deg, #4f46e5 0%, #6366f1 100%);
            border-color: #4f46e5;
        }

        .subsection-collapse-header[aria-expanded="true"] .subsection-collapse-title,
        .subsection-collapse-header[aria-expanded="true"] .collapse-toggle-icon {
            color: white !important;
        }

        .subsection-collapse-title {
            color: #4338ca;
            font-size: 1rem;
            margin: 0;
        }

        .collapse-toggle-icon {
            transition: transform 0.2s ease;
            color: #4338ca;
            font-size: 0.9rem;
        }

        .subsection-collapse-header[aria-expanded="true"] .collapse-toggle-icon {
            transform: rotate(180deg);
        }

        .subsection-collapse-body {
            padding: 16px;
            padding-top: 12px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            border: 1px solid #e0e7ff;
            border-top: none;
            border-radius: 0 0 8px 8px;
            background: white;
        }

        .subsection-item .rich-text-editor { flex: 1; }
        .subsection-actions { display: flex; justify-content: flex-end; }
        .subsection-actions .btn { min-width: 120px; }
        .section-content-editor { margin-top: 10px; }
        .section-content-editor .editor-content { min-height: 160px; }
        .standard-name-group input { font-weight: 600; }
        .weight-input { width: 100px; }
        .accordion-button:not(.collapsed) { color: #fff; background-color: #0d6efd; }
        .accordion-button:not(.collapsed)::after { filter: brightness(0) invert(1); }
        .section-header-controls { display: flex; align-items: center; gap: 15px; }
        .rich-text-editor { flex-grow: 1; }
        .editor-toolbar { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 8px; }
        .editor-toolbar .btn { padding: 4px 8px; }
        .editor-content { border: 1px solid #ced4da; border-radius: 8px; min-height: 80px; padding: 10px; background-color: #fff; transition: border-color 0.2s ease, box-shadow 0.2s ease; }
        .editor-content:focus, .editor-content.focus { outline: none; border-color: #0d6efd; box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25); }
        .editor-content.empty::before { content: attr(data-placeholder); color: #6c757d; pointer-events: none; }

        /* Table styles in editor */
        .editor-content table {
            border-collapse: collapse;
            width: 100%;
            margin: 10px 0;
            border: 1px solid #dee2e6;
            position: relative;
        }

        .editor-content table.resizable {
            resize: both;
            overflow: auto;
            display: inline-table;
        }

        .editor-content th,
        .editor-content td {
            border: 1px solid #dee2e6;
            padding: 8px;
            min-width: 50px;
            position: relative;
        }

        /* Link styles in editor */
        .editor-content a {
            color: #0d6efd;
            text-decoration: underline;
            cursor: pointer;
        }

        .editor-content a:hover {
            color: #0a58ca;
            text-decoration: underline;
        }

        .editor-content th {
            background-color: #f8f9fa;
            font-weight: 600;
            text-align: left;
        }

        .editor-content td {
            background-color: white;
        }

        [data-theme="dark"] .editor-content table {
            border-color: var(--border-color);
        }

        [data-theme="dark"] .editor-content th {
            background-color: #2d2d2d;
        }

        [data-theme="dark"] .editor-content td {
            background-color: var(--bg-card);
            border-color: var(--border-color);
        }

        .table-resize-handle {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 10px;
            height: 10px;
            cursor: nwse-resize;
            background: linear-gradient(135deg, transparent 50%, #0d6efd 50%);
        }
        .builder-deployment-editor { border: 1px solid #dee2f7; border-radius: 10px; background: #f8f9ff; padding: 12px 16px; }
        .builder-deployment-editor summary { cursor: pointer; display: flex; align-items: center; gap: 8px; font-weight: 600; color: #1f3a93; }
        .builder-deployment-editor summary::-webkit-details-marker { display: none; }
        .builder-deployment-editor .badge { font-size: 0.75rem; letter-spacing: 0.02em; }
        .builder-deployment-body { margin-top: 12px; display: flex; flex-direction: column; gap: 14px; }
        .builder-modality-editor { border: 1px dashed #c7d2fe; border-radius: 10px; padding: 12px; background: #ffffff; transition: opacity 0.2s ease; }
        .builder-modality-editor.inactive { opacity: 0.45; }
        .builder-modality-editor .badge { font-size: 0.75rem; }
        .builder-modality-columns { display: grid; gap: 12px; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); }
        .builder-modality-columns textarea { min-height: 90px; }
        .builder-deployment-summary { display: inline-flex; align-items: center; gap: 6px; }
        .author-credit { font-size: 0.9rem; color: #6c757d; margin-top: 8px; }
        .author-credit a { color: #0d6efd; text-decoration: none; }
        .author-credit a:hover { text-decoration: underline; }
        @media (max-width: 991.98px) {
            body { padding: 24px; }
            .maker-container { padding: 24px 20px; }
            .deployment-modalities-options { gap: 10px; }
            .section-header-controls { flex-wrap: wrap; justify-content: flex-start; }
        }
        @media (max-width: 767.98px) {
            body { padding: 16px; }
            .maker-container { padding: 20px 16px; border-radius: 10px; box-shadow: 0 0 12px rgba(0, 0, 0, 0.08); }
            .deployment-modalities-card .card-header { align-items: flex-start; }
            .deployment-modalities-options { flex-direction: column; }
            .modality-option { width: 100%; justify-content: space-between; }
            .builder-modality-columns { grid-template-columns: 1fr; }
            .section-header-controls { flex-direction: column; align-items: stretch; gap: 10px; }
            .subsection-actions { flex-direction: column; gap: 10px; }
            .subsection-actions .btn { width: 100%; }
        }

        /* Enhanced Features CSS */

        /* Dark Mode Support */
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f5f7f9;
            --bg-card: #ffffff;
            --text-primary: #1f2937;
            --text-secondary: #6c757d;
            --border-color: #e9ecef;
            --shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            --input-bg: #ffffff;
            --input-border: #ced4da;
        }

        [data-theme="dark"] {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --bg-card: #252525;
            --text-primary: #e4e4e7;
            --text-secondary: #a1a1aa;
            --border-color: #3f3f46;
            --shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            --input-bg: #2d2d2d;
            --input-border: #3f3f46;
        }

        [data-theme="dark"] body {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
        }

        [data-theme="dark"] .maker-container,
        [data-theme="dark"] .card,
        [data-theme="dark"] .accordion-item {
            background-color: var(--bg-card);
            color: var(--text-primary);
            border-color: var(--border-color);
        }

        [data-theme="dark"] .form-control,
        [data-theme="dark"] .form-select,
        [data-theme="dark"] .editor-content {
            background-color: var(--input-bg);
            color: var(--text-primary);
            border-color: var(--input-border);
        }

        [data-theme="dark"] .text-muted {
            color: var(--text-secondary) !important;
        }

        [data-theme="dark"] .card-header {
            background-color: #2d2d2d;
            border-color: var(--border-color);
        }

        [data-theme="dark"] .accordion-button {
            background-color: var(--bg-card);
            color: var(--text-primary);
        }

        [data-theme="dark"] .modal-content {
            background-color: var(--bg-card);
            color: var(--text-primary);
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast-notification {
            background: white;
            border-radius: 8px;
            padding: 16px 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 300px;
            max-width: 400px;
            animation: slideIn 0.3s ease-out;
        }

        [data-theme="dark"] .toast-notification {
            background: #2d2d2d;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        }

        .toast-notification.success { border-left: 4px solid #22c55e; }
        .toast-notification.error { border-left: 4px solid #ef4444; }
        .toast-notification.info { border-left: 4px solid #3b82f6; }
        .toast-notification.warning { border-left: 4px solid #f59e0b; }

        .toast-notification .toast-icon {
            font-size: 1.5rem;
        }

        .toast-notification.success .toast-icon { color: #22c55e; }
        .toast-notification.error .toast-icon { color: #ef4444; }
        .toast-notification.info .toast-icon { color: #3b82f6; }
        .toast-notification.warning .toast-icon { color: #f59e0b; }

        .toast-notification .toast-content {
            flex: 1;
        }

        .toast-notification .toast-close {
            background: none;
            border: none;
            color: #6c757d;
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Progress Bar */
        .completion-progress {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        [data-theme="dark"] .completion-progress {
            background: var(--bg-card);
        }

        .progress-bar-container {
            width: 100%;
            height: 24px;
            background: #e9ecef;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        [data-theme="dark"] .progress-bar-container {
            background: #3f3f46;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #0d6efd, #0dcaf0);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 10px;
            color: white;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .progress-text {
            text-align: center;
            font-weight: 600;
            color: #0d6efd;
        }

        /* Header Toolbar */
        .header-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            background: white;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            flex-wrap: wrap;
            gap: 12px;
        }

        [data-theme="dark"] .header-toolbar {
            background: var(--bg-card);
        }

        .header-toolbar-left,
        .header-toolbar-right {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .save-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.9rem;
            color: #6c757d;
        }

        .save-indicator i {
            font-size: 0.6rem;
        }

        .save-indicator.saved i {
            color: #22c55e;
        }

        .save-indicator.saving i {
            color: #f59e0b;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Search Container */
        .search-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        [data-theme="dark"] .search-container {
            background: var(--bg-card);
        }

        .search-results {
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
        }

        .search-result-item {
            padding: 12px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .search-result-item:hover {
            background: #f8f9fa;
            border-color: #0d6efd;
        }

        [data-theme="dark"] .search-result-item {
            border-color: var(--border-color);
        }

        [data-theme="dark"] .search-result-item:hover {
            background: #2d2d2d;
        }

        .search-result-item .result-title {
            font-weight: 600;
            color: #0d6efd;
            margin-bottom: 4px;
        }

        .search-result-item .result-context {
            font-size: 0.9rem;
            color: #6c757d;
        }

        .highlight {
            background: #fff3cd;
            padding: 2px 4px;
            border-radius: 3px;
            font-weight: 600;
        }

        [data-theme="dark"] .highlight {
            background: #856404;
            color: #fff;
        }

        /* Modals */
        .modal-lg {
            max-width: 800px;
        }

        .template-item {
            padding: 12px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
        }

        .template-item:hover {
            background: #f8f9fa;
            border-color: #0d6efd;
        }

        [data-theme="dark"] .template-item {
            border-color: var(--border-color);
        }

        [data-theme="dark"] .template-item:hover {
            background: #2d2d2d;
        }

        .template-info {
            flex: 1;
        }

        .template-name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .template-date {
            font-size: 0.85rem;
            color: #6c757d;
        }

        .template-actions {
            display: flex;
            gap: 8px;
        }

        .keyboard-shortcuts-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 12px;
        }

        .shortcut-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        [data-theme="dark"] .shortcut-item {
            background: #2d2d2d;
        }

        .shortcut-key {
            background: white;
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid #dee2e6;
            font-family: monospace;
            font-size: 0.9rem;
        }

        [data-theme="dark"] .shortcut-key {
            background: #1a1a1a;
            border-color: #3f3f46;
        }

        /* Validation Indicators */
        .validation-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
            padding: 4px 10px;
            border-radius: 20px;
            margin-left: 10px;
        }

        .validation-indicator.valid {
            background: #d1fae5;
            color: #065f46;
        }

        .validation-indicator.invalid {
            background: #fee2e2;
            color: #991b1b;
        }

        .validation-indicator.partial {
            background: #fef3c7;
            color: #92400e;
        }

        [data-theme="dark"] .validation-indicator.valid {
            background: #065f46;
            color: #d1fae5;
        }

        [data-theme="dark"] .validation-indicator.invalid {
            background: #991b1b;
            color: #fee2e2;
        }

        [data-theme="dark"] .validation-indicator.partial {
            background: #92400e;
            color: #fef3c7;
        }

        /* Section Management Styles */
        .section-management-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin-bottom: 10px;
            background: white;
            transition: all 0.2s ease;
            cursor: move;
            cursor: grab;
        }

        .section-management-item:active {
            cursor: grabbing;
        }

        .section-management-item.dragging {
            opacity: 0.5;
            background: #f0f0f0;
            transform: scale(0.98);
        }

        .section-management-item.drag-over {
            border-top: 3px solid #0d6efd;
            border-radius: 8px 8px 0 0;
        }

        [data-theme="dark"] .section-management-item {
            background: var(--bg-card);
            border-color: var(--border-color);
        }

        [data-theme="dark"] .section-management-item.dragging {
            background: #1a1a1a;
        }

        .section-management-item:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .section-management-item .drag-handle {
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            font-size: 1.2rem;
            cursor: grab;
            padding: 5px;
        }

        .section-management-item .drag-handle:active {
            cursor: grabbing;
        }

        .section-management-item .section-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #0d6efd, #0dcaf0);
            color: white;
            font-size: 1.2rem;
        }

        .section-management-item .section-info {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .section-management-item .section-name {
            font-weight: 600;
            color: var(--text-primary);
            min-width: 150px;
        }

        .section-management-item .section-weight-edit {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-management-item .section-weight-edit input {
            width: 80px;
        }

        .section-management-item .section-actions {
            display: flex;
            gap: 8px;
        }

        .section-management-item.deletable {
            border-color: #dc3545;
            background: #fff5f5;
        }

        [data-theme="dark"] .section-management-item.deletable {
            background: #3a1a1a;
            border-color: #dc3545;
        }

        /* Modal for adding sections */
        .modal-body .form-group {
            margin-bottom: 15px;
        }

        /* Responsive Adjustments */
        @media (max-width: 767.98px) {
            .header-toolbar {
                flex-direction: column;
                align-items: stretch;
            }

            .header-toolbar-left,
            .header-toolbar-right {
                width: 100%;
                justify-content: space-between;
            }

            .toast-container {
                left: 10px;
                right: 10px;
            }

            .toast-notification {
                min-width: auto;
            }

            .keyboard-shortcuts-list {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="maker-container">
        <div class="maker-header">
            <h2>üõ†Ô∏è Advanced SCT Tool Builder</h2>
            <p class="text-muted">Customize every part of your tool. The generated HTML will be fully functional and match the original experience.</p>
            <p class="author-credit">Author by: <a href="mailto:joduzu@gmail.com">Jorge Durand Zurdo</a></p>
        </div>

        <!-- Toast Container -->
        <div class="toast-container" id="toast-container" role="alert" aria-live="polite"></div>

        <!-- Progress Bar -->
        <div class="completion-progress" id="completion-progress" style="display: none;">
            <div class="progress-bar-container">
                <div class="progress-bar-fill" id="progress-bar-fill" style="width: 0%"></div>
            </div>
            <div class="progress-text" id="progress-text">0% Complete</div>
        </div>

        <!-- Header Toolbar -->
        <div class="header-toolbar">
            <div class="header-toolbar-left">
                <button class="btn btn-sm btn-outline-secondary" id="btn-dark-mode" aria-label="Toggle dark mode">
                    <i class="fas fa-moon"></i>
                </button>
                <span class="save-indicator" id="save-indicator">
                    <i class="fas fa-circle"></i>
                    <span id="save-status">Not saved yet</span>
                </span>
            </div>
            <div class="header-toolbar-right">
                <button class="btn btn-sm btn-primary" id="btn-save-draft" aria-label="Save draft">
                    <i class="fas fa-save me-1"></i>Save Draft
                </button>
                <button class="btn btn-sm btn-info" id="btn-export-config" aria-label="Export configuration to PDF">
                    <i class="fas fa-file-pdf me-1"></i>Export Config
                </button>
                <button class="btn btn-sm btn-secondary" id="btn-templates" aria-label="Manage templates" data-bs-toggle="modal" data-bs-target="#templatesModal">
                    <i class="fas fa-folder me-1"></i>Templates
                </button>
                <button class="btn btn-sm btn-outline-secondary" id="btn-shortcuts" aria-label="Show keyboard shortcuts" data-bs-toggle="modal" data-bs-target="#shortcutsModal">
                    <i class="fas fa-keyboard"></i>
                </button>
            </div>
        </div>

        <!-- Search Container -->
        <div class="search-container" id="search-container">
            <div class="input-group">
                <span class="input-group-text"><i class="fas fa-search"></i></span>
                <input type="text" class="form-control" id="search-standards" placeholder="Search standards by name or content... (Ctrl+F)" aria-label="Search standards">
                <button class="btn btn-outline-secondary" id="btn-clear-search" aria-label="Clear search">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="search-results" id="search-results"></div>
        </div>

        <div class="card my-4 deployment-modalities-card" id="deployment-modalities-card">
            <div class="card-header">
                <h5 class="mb-0">Supported Deployment Modalities</h5>
                <small class="text-muted">Select the deployment profiles your SCT can support.</small>
            </div>
            <div class="card-body">
                <div class="row g-3 align-items-end">
                    <div class="col-12 col-md-5 col-lg-4">
                        <label for="sctName" class="form-label">Name of the SCT</label>
                        <input type="text" class="form-control" id="sctName" placeholder="e.g. Rehabilitation">
                    </div>
                    <div class="col-12 col-md-7 col-lg-8">
                        <div class="deployment-modalities-options" id="deployment-modalities-options"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card my-4">
            <div class="card-header"><h5 class="mb-0">Assign Section Weights (%)</h5></div>
            <div class="card-body">
                <div class="row" id="weights-container"></div>
                <div class="alert alert-info mt-3" id="weight-sum-alert">Total weight sum: <span id="weight-sum">0</span>%. Must equal 100%.</div>
            </div>
        </div>

        <div class="card my-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Section Management</h5>
                <button class="btn btn-success btn-sm" id="btn-add-section"><i class="fas fa-plus me-2"></i>Create New Section</button>
            </div>
            <div class="card-body">
                <p class="text-muted mb-3">Create custom sections (e.g., CLINICAL, LOGISTICS, WASH) or delete existing ones. You can also update section weights on the fly.</p>
                <div id="section-management-list" class="list-group"></div>
            </div>
        </div>

        <div class="accordion" id="sections-accordion"></div>

        <div class="mt-4">
            <div class="d-grid gap-2">
                <button class="btn btn-primary btn-lg" id="btn-make"><i class="fas fa-magic me-2"></i>Generate Complete HTML Tool</button>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-success flex-fill" id="btn-save-maker"><i class="fas fa-save me-2"></i>Save Maker State</button>
                    <button class="btn btn-outline-info flex-fill" id="btn-load-maker"><i class="fas fa-upload me-2"></i>Load Maker State</button>
                </div>
            </div>
            <p class="text-muted text-center mt-2 mb-0"><small>Save your maker configuration to continue editing later</small></p>
        </div>
    </div>

    <!-- Hidden file input for loading maker state -->
    <input type="file" id="maker-file-input" accept=".html" style="display: none;">

    <!-- Modal for Adding New Section -->
    <div class="modal fade" id="addSectionModal" tabindex="-1" aria-labelledby="addSectionModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addSectionModalLabel">Create New Section</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="new-section-key" class="form-label">Section Key (unique identifier)</label>
                        <input type="text" class="form-control" id="new-section-key" placeholder="e.g., clinical-standards">
                        <small class="text-muted">Use lowercase with hyphens (e.g., clinical-standards, wash-standards)</small>
                    </div>
                    <div class="mb-3">
                        <label for="new-section-title" class="form-label">Section Title</label>
                        <input type="text" class="form-control" id="new-section-title" placeholder="e.g., CLINICAL STANDARDS">
                    </div>
                    <div class="mb-3">
                        <label for="new-section-icon" class="form-label">Icon (FontAwesome class)</label>
                        <input type="text" class="form-control" id="new-section-icon" placeholder="e.g., fa-stethoscope">
                        <small class="text-muted">Browse icons at <a href="https://fontawesome.com/icons" target="_blank">fontawesome.com</a></small>
                    </div>
                    <div class="mb-3">
                        <label for="new-section-weight" class="form-label">Weight (%)</label>
                        <input type="number" class="form-control" id="new-section-weight" value="0" min="0" max="100">
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="new-section-has-subsections" checked>
                            <label class="form-check-label" for="new-section-has-subsections">
                                Has Subsections
                            </label>
                        </div>
                    </div>
                    <div class="mb-3" id="subsections-input-container">
                        <label for="new-section-subsections" class="form-label">Subsections (one per line)</label>
                        <textarea class="form-control" id="new-section-subsections" rows="5" placeholder="Enter each subsection on a new line"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="btn-create-section">Create Section</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
    const DEPLOYMENT_MODALITIES = [
        { key: 'embedded', label: 'Embedded', icon: 'fa-hospital', accentClass: 'embedded' },
        { key: 'coupled', label: 'Coupled', icon: 'fa-link', accentClass: 'coupled' },
        { key: 'self-sustained', label: 'Self-Sustained', icon: 'fa-campground', accentClass: 'self-sustained' }
    ];

    const DEPLOYMENT_MODALITY_DETAILS = {
        'embedded': {
            'CORE STANDARD': {
                'Self-sufficiency': {
                    requirements: [
                        'Host provides necessary operational support',
                        'Availability of SCT-specific clinical devices and supplies',
                        'Appropriateness and accessibility of space for SCT',
                        'Clear list and provision of necessary supplies by SCT',
                        'Management of supplies between host and SCT',
                        'Host provides accommodation for SCT staff',
                        'Accommodation on site'
                    ],
                    mitigation: [
                        'Ensure agreements detail operational support specifics, including utilities and basic supplies',
                        'SCT to provide its own specialized equipment and negotiate storage and maintenance with host',
                        'If inadequate, plan modifications or look for alternative spaces within the facility',
                        'SCT to maintain an independent supply chain and inventory control',
                        'Set up a joint management system to track usage and replenishment',
                        'If not, team to arrange their own accommodation',
                        'If off-site, organise necessary transport and additional budget'
                    ]
                },
                'Human Resources': {
                    requirements: [
                        'Host supports SCT with additional personnel if needed',
                        'Specialized SCT care staff available',
                        'Health professionals provided to work alongside SCT'
                    ],
                    mitigation: [
                        'Develop joint staffing plans that include host personnel training and integration',
                        'Deploy autonomous teams and integrate host staff as feasible',
                        'Assess capacity and provide additional training if needed'
                    ]
                },
                'Team field management and operations': {
                    requirements: [
                        'Agreement on staff roles and integration',
                        'Staff: Facility provides medical leadership and oversight for SCT target patients',
                        'SCT staff expected to work daylight hours only'
                    ],
                    mitigation: [
                        'Formalize roles and responsibilities in operational guidelines',
                        'Collaborate with host to establish a focal point for SCT',
                        'Adapt staffing and security plans for extended hours if necessary'
                    ]
                },
                'Support national health system and patient referral': {
                    requirements: [
                        'Compliance with SCT\'s clinical specialty requirements',
                        'Identified referral pathway for patients requiring higher levels of care'
                    ],
                    mitigation: [
                        'SCT to conduct pre-deployment site visits to ensure space meets specific needs',
                        'Establish and clarify referral pathways and protocols for deteriorating patients'
                    ]
                },
                'Coordination': {
                    requirements: [
                        'Intensive coordination within host for integration'
                    ],
                    mitigation: [
                        'Establish a dedicated liaison team to handle integration and daily coordination'
                    ]
                },
                'Medical records and reporting': {
                    requirements: [
                        'Maintenance and sharing of clinical documentation'
                    ],
                    mitigation: [
                        'Implement shared digital systems for seamless data flow'
                    ]
                }
            },
            'LOGISTICS': {
                'Safety and Security': {
                    requirements: [
                        'Safety and security risk assessment collaboration',
                        'Responsibilities for safety and security measures',
                        'Facility demonstrates due diligence for the safety and security of personnel and patients',
                        'Evacuation procedures in place',
                        'Updated safety and security plan'
                    ],
                    mitigation: [
                        'Jointly develop a comprehensive safety and security plan',
                        'SCT and host to conduct regular safety drills and update emergency response plans',
                        'Review and enhance security protocols',
                        'Ensure teams are briefed on evacuation procedures',
                        'Participate in creating or revising the safety plan to meet current needs'
                    ]
                },
                'Pharmacy supply chain and medical stock management': {
                    requirements: [
                        'Oxygen Supply: Facility provides oxygen if required',
                        'Sterilization: Facility provides sterilization of equipment',
                        'Ward management: Sufficient beds and bedding for surge in patients',
                        'Pharmacy drugs: Facility provides access to recommended medicines',
                        'Diagnostics and Equipment: Facility provides necessary equipment and supplies for pre-emergency level of care',
                        'SCT is self-sufficient with pharmaceuticals, medical consumables, and medical equipment'
                    ],
                    mitigation: [
                        'Ensure reliable oxygen supply through deployment of cylinders or concentrators',
                        'Bring sterile supplies and consider portable sterilization solutions if necessary',
                        'Deploy additional beds and mattresses or source locally',
                        'Ensure adequate supply if local availability is insufficient',
                        'SCT provides additional equipment and consumables if necessary',
                        'Secure additional sources and stockpile critical supplies'
                    ]
                },
                'Power and Fuel': {
                    requirements: [
                        'Power and Fuel: Facility provides sufficient, safe, and sustainable fuel and power supply',
                        'Appropriate lighting within the facility for clinical care and support services'
                    ],
                    mitigation: [
                        'Ensure backup generators are available and fuel supply chains are secure',
                        'Deploy portable lighting solutions if necessary'
                    ]
                },
                'Communications': {
                    requirements: [
                        'Communications: Facility can transmit data and voice communications effectively',
                        'Redundancy in communications in case of failure'
                    ],
                    mitigation: [
                        'Set up additional communication channels such as satellite phones or radios',
                        'Establish multiple communication methods to ensure redundancy'
                    ]
                },
                'Transportation and fleet': {
                    requirements: [
                        'Facility coordinates transportation of equipment and personnel'
                    ],
                    mitigation: [
                        'Arrange external transport services if necessary'
                    ]
                },
                'Food': {
                    requirements: [
                        'Facility provides sufficient food for all staff, inpatients, and caregivers',
                        'Food available in proximity of the facility'
                    ],
                    mitigation: [
                        'Plan for initial self-sufficiency and establish local supply chains',
                        'Stockpile essential supplies or negotiate with local providers'
                    ]
                },
                'Warehouse Management': {
                    requirements: [
                        'Effective warehouse management processes',
                        'Secure storage space for deployed equipment and consumables'
                    ],
                    mitigation: [
                        'Develop contingency plans for supply chain disruptions',
                        'Consider portable secure storage solutions; ensure safety and proper stock management'
                    ]
                },
                'Donation Management': {
                    requirements: [
                        'Policies in place for managing donations'
                    ],
                    mitigation: [
                        'Establish guidelines and a system for managing and distributing donations'
                    ]
                },
                'Facility structure, environment & ventilation': {
                    requirements: [
                        'Facility is structurally sound',
                        'Adequate ventilation provided'
                    ],
                    mitigation: [
                        'Engage with the facility to conduct or request a formal structural assessment if needed',
                        'Implement temporary solutions such as portable air filtration units if needed'
                    ]
                },
                'Site assessment and planning': {
                    requirements: [
                        'Site assessed and configured according to local conditions'
                    ],
                    mitigation: [
                        'Reassess and modify site layout to adapt to local conditions as necessary'
                    ]
                },
                'Sequential Build': {
                    requirements: [
                        'Essential areas and services prioritized for urgent care during facility setup'
                    ],
                    mitigation: [
                        'Ensure critical services are prioritized and operational first'
                    ]
                },
                'Mobilization': {
                    requirements: [
                        'Host can mobilize resources in short time to ensure readiness'
                    ],
                    mitigation: [
                        'Pre-arrange resources and staff for rapid deployment'
                    ]
                },
                'Demobilization': {
                    requirements: [
                        'Effective demobilization plans to minimize disruption'
                    ],
                    mitigation: [
                        'Develop comprehensive demobilization strategies that include community engagement'
                    ]
                }
            },
            'CLINICAL': {
                'TRIAGE': {
                    requirements: [
                        'Clear admission criteria for SCT target patients'
                    ],
                    mitigation: [
                        'Ensure agreement on admission criteria with local health authorities'
                    ]
                },
                'IMAGING': {
                    requirements: [
                        'Imaging: Facility provides necessary imaging solutions'
                    ],
                    mitigation: [
                        'Secure alternative imaging solutions if not available'
                    ]
                }
            },
            'WASH': {
                'Water Supply': {
                    requirements: [
                        'Continuous access to potable water for medical and personal needs',
                        'Water supply being tested continuously'
                    ],
                    mitigation: [
                        'Consider options such as water purification systems and secure water storage solutions',
                        'Coordinate with local authorities or WASH clusters for provision if untested'
                    ]
                },
                'Hygiene': {
                    requirements: [
                        'Staff and patients can practice hand hygiene adequately',
                        'Personal hygiene facilities, including showers',
                        'Host provides laundry service for patients and staff'
                    ],
                    mitigation: [
                        'Provide additional handwashing stations and supplies',
                        'Install temporary hygiene facilities if necessary'
                    ]
                },
                'Environmental Cleaning': {
                    requirements: [
                        'Documented procedures for cleaning to maintain a hygienic environment'
                    ],
                    mitigation: [
                        'Develop and implement standardized cleaning protocols'
                    ]
                },
                'Healthcare Waste Management': {
                    requirements: [
                        'Appropriate waste management in place for healthcare waste'
                    ],
                    mitigation: [
                        'Implement safe waste handling and disposal procedures; coordinate with local waste management; SCT may need to bring their own containers and disposal solutions'
                    ]
                },
                'Sanitation': {
                    requirements: [
                        'Sufficient and safe sanitation facilities for excreta and grey and storm water management'
                    ],
                    mitigation: [
                        'Deploy portable sanitation units and support the development of faecal sludge and waste water management plans'
                    ]
                },
                'Vector and Pest Control': {
                    requirements: [
                        'Effective vector and pest control measures in place'
                    ],
                    mitigation: [
                        'Introduce pest control measures suited to the local environment'
                    ]
                },
                'Dead Body Management': {
                    requirements: [
                        'Host manages dead bodies in a safe, dignified, and culturally appropriate manner'
                    ],
                    mitigation: [
                        'Provide training and resources for proper dead body management'
                    ]
                }
            }
        },
        'coupled': {
            'CORE STANDARD': {
                'Self-sufficiency': {
                    requirements: [
                        'SCT complements host by adding infrastructure and shares some operational support elements (e.g., power, water, waste management)',
                        'SCT provides all internal infrastructure including equipment, consumables, lighting, etc.',
                        'SCT provides additional infrastructure on the same site and ensures proper layout and setup',
                        'SCT independently provides all necessary clinical devices, consumables, and equipment',
                        'SCT manages its own supplies but coordinates with host for shared support elements',
                        'SCT arranges its own accommodation',
                        'SCT arranges transport for off-site accommodation'
                    ],
                    mitigation: [
                        'Formalize shared operational support responsibilities and boundaries in a written agreement',
                        'Ensure clear agreements on the division of responsibilities for internal infrastructure and shared support elements',
                        'Ensure portable and adaptable structures are available and can be deployed quickly',
                        'Ensure a robust logistics plan for continuous supply and replenishment',
                        'Use technology for real-time tracking and management of supplies',
                        'Ensure adequate and safe accommodation arrangements are in place',
                        'Ensure secure and reliable transport arrangements'
                    ]
                },
                'Human Resources': {
                    requirements: [
                        'SCT provides its own staff but collaborates with host for some support functions',
                        'SCT provides its own specialized staff',
                        'SCT coordinates with host for collaborative care functions'
                    ],
                    mitigation: [
                        'Implement integration protocols for collaborative functions, including training and orientation',
                        'Ensure seamless integration with host\'s medical leadership',
                        'Conduct joint training and integration sessions'
                    ]
                },
                'Team field management and operations': {
                    requirements: [
                        'Protocols in place for integrating SCT and host staff for shared support services',
                        'SCT provides specialized staff and coordinates with host for overall medical leadership',
                        'SCT provides 24/7 staffing as needed'
                    ],
                    mitigation: [
                        'Set up joint training sessions and regular coordination meetings',
                        'Ensure all required diagnostics and equipment are deployed and functional',
                        'Ensure adequate training and orientation for all staff'
                    ]
                },
                'Support national health system and patient referral': {
                    requirements: [
                        'Facilities provided by SCT are quickly deployable and adaptable for specialized care',
                        'SCT coordinates with host to ensure effective referral pathways for patients needing higher care'
                    ],
                    mitigation: [
                        'Plan for logistical support in setting up and adapting SCT facilities',
                        'Refine patient cohorting with local health authorities'
                    ]
                },
                'Coordination': {
                    requirements: [
                        'High-level coordination between SCT and host for shared support services'
                    ],
                    mitigation: [
                        'Create a joint task force to oversee integration and address issues as they arise'
                    ]
                },
                'Medical records and reporting': {
                    requirements: [
                        'SCT implements its own documentation systems but ensures compatibility with host systems'
                    ],
                    mitigation: [
                        'Regularly review and update communication protocols to ensure efficiency'
                    ]
                }
            },
            'LOGISTICS': {
                'Safety and Security': {
                    requirements: [
                        'Safety and security responsibilities shared, with SCT ensuring internal security and host managing site security',
                        'SCT and host collaborate on safety drills and emergency response plans',
                        'SCT coordinates with host for overall site security',
                        'SCT coordinates with host on evacuation plans',
                        'SCT ensures its own safety plans are compatible with host\'s safety protocols'
                    ],
                    mitigation: [
                        'Define and regularly update safety and security protocols and responsibilities',
                        'Set up a quick-response team and clear escalation paths for dealing with emergencies',
                        'Ensure comprehensive safety and security plans are in place',
                        'Ensure clear and effective evacuation protocols are established',
                        'Ensure safety plans are regularly updated and communicated'
                    ]
                },
                'Pharmacy supply chain and medical stock management': {
                    requirements: [
                        'SCT coordinates with host for oxygen supply but provides backup cylinders or concentrators',
                        'SCT provides its own sterilization solutions and coordinates with host facility',
                        'SCT provides additional beds and bedding within its area',
                        'SCT ensures its own supply of necessary medicines',
                        'SCT independently provides all necessary diagnostics and equipment',
                        'SCT manages its own pharmaceutical and medical stock supplies'
                    ],
                    mitigation: [
                        'Deploy additional cylinders or concentrators as needed',
                        'Deploy portable sterilization units as needed',
                        'Install temporary hygiene facilities if necessary',
                        'Deploy portable imaging equipment as needed',
                        'Ensure sustainable sourcing and stockpile critical supplies',
                        'Ensure sustainable supply chain management'
                    ]
                },
                'Power and Fuel': {
                    requirements: [
                        'SCT coordinates with host for power supply but ensures backup generators and fuel supply',
                        'SCT provides all necessary lighting within its own infrastructure'
                    ],
                    mitigation: [
                        'Ensure proper staffing and security arrangements for extended hours',
                        'Deploy backup generators and secure fuel supply chains'
                    ]
                },
                'Communications': {
                    requirements: [
                        'SCT provides its own communication systems but ensures integration with host systems',
                        'SCT ensures redundancy in its communication systems'
                    ],
                    mitigation: [
                        'Ensure adequate lighting solutions are deployed',
                        'Ensure multiple communication methods are available; deploy backup communication systems'
                    ]
                },
                'Transportation and fleet': {
                    requirements: [
                        'SCT provides its own transportation solutions'
                    ],
                    mitigation: [
                        'Ensure effective coordination of transportation and logistics'
                    ]
                },
                'Food': {
                    requirements: [
                        'SCT ensures its own food supplies for its staff and patients',
                        'SCT ensures food availability through local suppliers'
                    ],
                    mitigation: [
                        'Ensure sustainable food supply arrangements are in place',
                        'Negotiate with local providers and stockpile as necessary'
                    ]
                },
                'Warehouse Management': {
                    requirements: [
                        'SCT manages its own warehouse and ensures effective supply chain processes',
                        'SCT provides its own secure storage solutions'
                    ],
                    mitigation: [
                        'Ensure effective supply chain and stock management',
                        'Deploy portable storage units as needed'
                    ]
                },
                'Donation Management': {
                    requirements: [
                        'SCT coordinates donation management'
                    ],
                    mitigation: [
                        'Ensure clear protocols for handling and distribution of donations'
                    ]
                },
                'Facility Structure, Environment & Ventilation': {
                    requirements: [
                        'SCT coordinates with host to ensure structural integrity',
                        'SCT ensures proper ventilation within its infrastructure'
                    ],
                    mitigation: [
                        'Ensure all structures are safe and meet operational requirements',
                        'Deploy portable ventilation units as necessary'
                    ]
                },
                'Site Assessment and Planning': {
                    requirements: [
                        'SCT conducts thorough site assessments'
                    ],
                    mitigation: [
                        'Ensure site configurations meet operational needs'
                    ]
                },
                'Sequential Build': {
                    requirements: [
                        'SCT ensures essential services are operational first'
                    ],
                    mitigation: [
                        'Plan and implement sequential build strategies'
                    ]
                },
                'Mobilization': {
                    requirements: [
                        'SCT ensures rapid deployment of resources'
                    ],
                    mitigation: [
                        'Plan for quick mobilization and effective resource deployment'
                    ]
                },
                'Demobilization': {
                    requirements: [
                        'SCT coordinates demobilization plans'
                    ],
                    mitigation: [
                        'Ensure demobilization strategies are well-planned and executed'
                    ]
                }
            },
            'CLINICAL': {
                'TRIAGE': {
                    requirements: [
                        'SCT and host agree on admission criteria and coordinate patient management'
                    ],
                    mitigation: [
                        'Ensure adequate stock of bedding and negotiate with local suppliers'
                    ]
                },
                'IMAGING': {
                    requirements: [
                        'SCT provides portable imaging solutions within its area'
                    ],
                    mitigation: [
                        'Ensure rapid transfer capabilities are in place'
                    ]
                }
            },
            'WASH': {
                'Water Supply': {
                    requirements: [
                        'SCT coordinates with host for water supply but provides backup solutions if needed',
                        'SCT ensures water quality testing and coordinates with host for regular checks'
                    ],
                    mitigation: [
                        'Deploy water purification and storage solutions',
                        'Implement regular water quality testing protocols'
                    ]
                },
                'Hygiene': {
                    requirements: [
                        'SCT provides its own hand hygiene facilities',
                        'SCT provides its own hygiene facilities within its infrastructure',
                        'SCT provides its own laundry facilities'
                    ],
                    mitigation: [
                        'Deploy portable handwashing stations as needed',
                        'Deploy temporary hygiene facilities as necessary',
                        'Deploy portable laundry units as necessary'
                    ]
                },
                'Environmental Cleaning': {
                    requirements: [
                        'SCT ensures additional cleaning protocols'
                    ],
                    mitigation: [
                        'Implement additional environmental cleaning procedures'
                    ]
                },
                'Healthcare Waste Management': {
                    requirements: [
                        'SCT coordinates with host for waste treatment but provides backup solutions if needed'
                    ],
                    mitigation: [
                        'Deploy portable waste handling and disposal systems'
                    ]
                },
                'Sanitation': {
                    requirements: [
                        'SCT provides additional sanitation solutions but coordinates with host for faecal sludge treatment and or disposal and provides backup solutions if needed'
                    ],
                    mitigation: [
                        'Implement additional sanitation facilities and management plans'
                    ]
                },
                'Vector and Pest Control': {
                    requirements: [
                        'SCT ensures additional vector control solutions'
                    ],
                    mitigation: [
                        'Implement comprehensive vector control strategies'
                    ]
                },
                'Dead Body Management': {
                    requirements: [
                        'SCT ensures additional dead body management solutions'
                    ],
                    mitigation: [
                        'Deploy resources and training for proper dead body management'
                    ]
                }
            }
        },
        'self-sustained': {}
    };

    function escapeHTML(value = '') {
        return String(value ?? '')
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
    }

    function stripHTML(value = '') {
        return String(value || '').replace(/<[^>]*>/g, ' ').replace(/\s+/g, ' ').trim();
    }

    function normalizeStandardName(value = '') {
        return stripHTML(value)
            .toLowerCase()
            .replace(/&amp;/g, 'and')
            .replace(/[^a-z0-9]+/g, ' ')
            .trim();
    }

    function extractTitleTextFromHTML(html, fallbackIndex = 0) {
        const temp = document.createElement('div');
        temp.innerHTML = html || '';
        const text = (temp.textContent || '').trim();
        const separators = [':', '‚Äì', '-', '‚Äî'];
        let title = text;
        for (const sep of separators) {
            const idx = text.indexOf(sep);
            if (idx > -1) {
                title = text.slice(0, idx).trim();
                break;
            }
        }
        if (!title) {
            title = `Standard ${fallbackIndex + 1}`;
        }
        return title;
    }

    function findModalityDetailSource(modalityKey, sectionKey, standardTitle, source = DEPLOYMENT_MODALITY_DETAILS) {
        if (!modalityKey || !sectionKey) return null;
        const modalityData = source[modalityKey];
        if (!modalityData) return null;
        const mappedSection = SECTION_KEY_TO_MODALITY_SECTION[sectionKey];
        if (!mappedSection) return null;
        const sectionData = modalityData[mappedSection];
        if (!sectionData) return null;
        const normalizedTitle = normalizeStandardName(standardTitle);
        let bestMatch = null;
        for (const [name, details] of Object.entries(sectionData)) {
            const normalizedName = normalizeStandardName(name);
            if (!normalizedName) continue;
            if (normalizedTitle && normalizedName === normalizedTitle) {
                bestMatch = details;
                break;
            }
            if (!bestMatch && normalizedTitle && (normalizedName.includes(normalizedTitle) || normalizedTitle.includes(normalizedName))) {
                bestMatch = details;
            }
        }
        return bestMatch;
    }

    function generateSubsectionKey(sectionKey) {
        return `${sectionKey}-${Math.random().toString(36).slice(2, 10)}`;
    }

    const builderDeploymentOverrides = {};

    function ensureDeploymentOverride(sectionKey, itemKey, titleText = '') {
        if (!builderDeploymentOverrides[sectionKey]) {
            builderDeploymentOverrides[sectionKey] = {};
        }
        if (!builderDeploymentOverrides[sectionKey][itemKey]) {
            builderDeploymentOverrides[sectionKey][itemKey] = {};
            DEPLOYMENT_MODALITIES.forEach(modality => {
                const defaults = findModalityDetailSource(modality.key, sectionKey, titleText) || {};
                const requirements = Array.isArray(defaults.requirements) ? defaults.requirements.join('\n') : (defaults.requirements || '');
                const mitigation = Array.isArray(defaults.mitigation) ? defaults.mitigation.join('\n') : (defaults.mitigation || '');
                builderDeploymentOverrides[sectionKey][itemKey][modality.key] = {
                    requirements,
                    mitigation
                };
            });
        }
        return builderDeploymentOverrides[sectionKey][itemKey];
    }

    function buildBuilderDeploymentEditor(sectionKey, itemKey, titleText) {
        const overrides = ensureDeploymentOverride(sectionKey, itemKey, titleText);
        const modalityEditors = DEPLOYMENT_MODALITIES.map(modality => {
            const modalityData = overrides[modality.key] || { requirements: '', mitigation: '' };
            return `
                <div class="builder-modality-editor" data-modality="${modality.key}">
                    <div class="builder-modality-header mb-2">
                        <span class="badge bg-light text-primary"><i class="fas ${modality.icon} me-1"></i>${escapeHTML(modality.label)}</span>
                    </div>
                    <div class="builder-modality-columns">
                        <div>
                            <label class="form-label">Requirements</label>
                            <textarea class="form-control deployment-prefill-textarea" data-section="${sectionKey}" data-item-key="${itemKey}" data-modality="${modality.key}" data-field="requirements" rows="3">${escapeHTML(modalityData.requirements || '')}</textarea>
                        </div>
                        <div>
                            <label class="form-label">Mitigation</label>
                            <textarea class="form-control deployment-prefill-textarea" data-section="${sectionKey}" data-item-key="${itemKey}" data-modality="${modality.key}" data-field="mitigation" rows="3">${escapeHTML(modalityData.mitigation || '')}</textarea>
                        </div>
                    </div>
                </div>
            `;
        }).join('');

        return `
            <details class="builder-deployment-editor" data-section="${sectionKey}" data-item-key="${itemKey}" data-title="${escapeHTML(titleText)}" open>
                <summary>
                    <span class="builder-deployment-summary">
                        <i class="fas fa-clipboard-list text-primary"></i>
                        <span class="builder-deployment-summary-title">${escapeHTML(titleText)}</span>
                        <span class="badge bg-light text-secondary">Deployment Prefill</span>
                    </span>
                </summary>
                <div class="builder-deployment-body">
                    ${modalityEditors}
                </div>
            </details>
        `;
    }

    function splitStandardContent(html, fallbackIndex = 0, knownTitle = '') {
        const raw = String(html || '').trim();
        const fallbackTitle = `Standard ${fallbackIndex + 1}`;
        // Only use separators with spaces to avoid splitting words like "pre-deployment" or "context-based"
        // Prioritize separators with spaces, then colons with spaces, and only use standalone dashes/colons as last resort
        const separators = [': ', ' ‚Äì ', ' ‚Äî ', ' - ', ': ', '‚Äì', '‚Äî'];
        if (!raw) {
            const titleText = knownTitle || fallbackTitle;
            return { titleHTML: knownTitle || '', bodyHTML: '', titleText };
        }

        let titleHTML = raw;
        let bodyHTML = raw;
        let matched = false;

        // Try to match separators, but skip if the match is within a word (for hyphens)
        for (const sep of separators) {
            const idx = raw.indexOf(sep);
            if (idx > -1) {
                // For standalone hyphens without spaces, check if they're part of a compound word
                if (sep === '-' || sep === '‚Äì' || sep === '‚Äî') {
                    // Check if there are word characters immediately before and after (indicating a compound word)
                    const charBefore = idx > 0 ? raw[idx - 1] : ' ';
                    const charAfter = idx + sep.length < raw.length ? raw[idx + sep.length] : ' ';
                    const isCompoundWord = /[a-zA-Z0-9]/.test(charBefore) && /[a-zA-Z0-9]/.test(charAfter);

                    if (isCompoundWord) {
                        // This is a compound word like "pre-deployment", skip it
                        continue;
                    }
                }

                titleHTML = raw.slice(0, idx);
                bodyHTML = raw.slice(idx + sep.length).trim() || raw;
                matched = true;
                break;
            }
        }

        const titleSource = matched ? titleHTML : (knownTitle || raw);
        let titleText = extractTitleTextFromHTML(titleSource || '', fallbackIndex) || knownTitle || fallbackTitle;

        const shouldStripBody = matched || Boolean(knownTitle);
        if (shouldStripBody && titleText) {
            const cleaned = stripLeadingTitleFromHTML(bodyHTML, titleText);
            bodyHTML = cleaned.html;
            if (!matched && cleaned.removed) {
                matched = true;
            }
        }

        return { titleHTML: titleSource || '', bodyHTML, titleText };
    }

    function stripLeadingTitleFromHTML(html, titleText) {
        const container = document.createElement('div');
        container.innerHTML = String(html || '');
        const normalizedTitle = normalizeStandardName(titleText);
        if (!normalizedTitle) {
            return { html: container.innerHTML.trim(), removed: false };
        }

        let removed = false;
        const shouldRemoveNode = (node) => {
            if (!node) return false;
            if (node.nodeType === Node.TEXT_NODE) {
                const normalized = normalizeStandardName(node.textContent || '');
                return normalized === '' || normalized === normalizedTitle;
            }
            if (node.nodeType === Node.ELEMENT_NODE) {
                const tag = node.tagName.toLowerCase();
                if (tag === 'br') {
                    return true;
                }
                const normalized = normalizeStandardName(node.textContent || '');
                if (!normalized) {
                    return true;
                }
                return normalized === normalizedTitle;
            }
            return false;
        };

        while (container.firstChild) {
            const node = container.firstChild;
            if (shouldRemoveNode(node)) {
                container.removeChild(node);
                removed = true;
                continue;
            }
            const normalized = normalizeStandardName(node.textContent || '');
            if (normalized === normalizedTitle) {
                container.removeChild(node);
                removed = true;
                continue;
            }
            break;
        }

        return { html: container.innerHTML.trim(), removed };
    }

    function setupDeploymentPrefillEditors(root = document) {
        root.querySelectorAll('.deployment-prefill-textarea').forEach(textarea => {
            if (textarea.dataset.prefillInitialized === 'true') {
                return;
            }
            textarea.dataset.prefillInitialized = 'true';
            textarea.addEventListener('input', event => {
                const field = event.currentTarget.dataset.field;
                const section = event.currentTarget.dataset.section;
                const itemKey = event.currentTarget.dataset.itemKey;
                const modality = event.currentTarget.dataset.modality;
                if (!field || !section || !itemKey || !modality) {
                    return;
                }
                const wrapper = event.currentTarget.closest('.builder-deployment-editor');
                const title = wrapper ? (wrapper.dataset.title || '') : '';
                ensureDeploymentOverride(section, itemKey, title);
                if (!builderDeploymentOverrides[section][itemKey][modality]) {
                    builderDeploymentOverrides[section][itemKey][modality] = { requirements: '', mitigation: '' };
                }
                builderDeploymentOverrides[section][itemKey][modality][field] = event.currentTarget.value;
            });
        });
    }

    function updateBuilderModalityEditorsVisibility() {
        document.querySelectorAll('.builder-modality-editor').forEach(editor => {
            const modality = editor.dataset.modality;
            if (!modality) return;
            editor.classList.toggle('inactive', !builderSelectedModalities.has(modality));
        });
    }

    function addSubsectionItem(sectionKey, subContent = '', options = {}) {
        const container = options.container || document.getElementById(`subsections-${sectionKey}`);
        if (!container) return null;
        const index = typeof options.index === 'number' ? options.index : container.querySelectorAll('.subsection-item').length;
        const itemKey = options.itemKey || generateSubsectionKey(sectionKey);
        const parsedContent = splitStandardContent(subContent, index, options.titleText);
        const titleText = options.titleText || parsedContent.titleText || `Standard ${index + 1}`;
        ensureDeploymentOverride(sectionKey, itemKey, titleText);
        const collapseId = `collapse-maker-${sectionKey}-${itemKey}`;
        const subsectionHTML = `
            <div class="subsection-item" data-section="${sectionKey}" data-item-key="${itemKey}" data-default-index="${index}" data-title="${escapeHTML(titleText)}" draggable="true">
                <div class="subsection-drag-handle" title="Drag to reorder">
                    <i class="fas fa-grip-vertical"></i>
                </div>
                <div class="subsection-content-wrapper">
                    <div class="subsection-collapse-header" data-bs-toggle="collapse" data-bs-target="#${collapseId}" role="button" aria-expanded="true">
                        <div class="d-flex justify-content-between align-items-center w-100">
                            <strong class="subsection-collapse-title">${escapeHTML(titleText)}</strong>
                            <i class="fas fa-chevron-down collapse-toggle-icon"></i>
                        </div>
                    </div>
                    <div id="${collapseId}" class="collapse show">
                        <div class="subsection-collapse-body">
                            <div class="standard-name-group mb-2">
                                <label class="form-label">Standard Name</label>
                                <input type="text" class="form-control standard-title-input" data-section="${sectionKey}" data-item-key="${itemKey}" value="${escapeHTML(titleText)}" placeholder="Enter the standard title">
                            </div>
                            ${getEditorTemplate(parsedContent.bodyHTML)}
                            ${buildBuilderDeploymentEditor(sectionKey, itemKey, titleText)}
                            <div class="subsection-actions">
                                <button class="btn btn-danger btn-sm remove-item" type="button"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        container.insertAdjacentHTML('beforeend', subsectionHTML);
        const newItem = container.lastElementChild;
        setupRichTextEditors(newItem);
        setupDeploymentPrefillEditors(newItem);
        setupSubsectionDragAndDrop(newItem);
        updateBuilderModalityEditorsVisibility();
        const titleInput = newItem.querySelector('.standard-title-input');
        if (titleInput) {
            const updateTitle = () => {
                const defaultIndex = parseInt(newItem.dataset.defaultIndex, 10);
                const fallbackTitle = Number.isFinite(defaultIndex)
                    ? `Standard ${defaultIndex + 1}`
                    : `Standard ${index + 1}`;
                const value = titleInput.value.trim() || fallbackTitle;
                newItem.dataset.title = value;

                // Update collapse header title
                const collapseTitle = newItem.querySelector('.subsection-collapse-title');
                if (collapseTitle) {
                    collapseTitle.textContent = value;
                }

                const details = newItem.querySelector('.builder-deployment-editor');
                if (details) {
                    details.dataset.title = value;
                }
                const summaryTitle = newItem.querySelector('.builder-deployment-summary-title');
                if (summaryTitle) {
                    summaryTitle.textContent = value;
                }
                ensureDeploymentOverride(sectionKey, itemKey, value);
            };
            titleInput.addEventListener('input', updateTitle);
            updateTitle();
        }
        const removeBtn = newItem.querySelector('.remove-item');
        if (removeBtn) {
            removeBtn.onclick = () => {
                if (activeEditor && newItem.contains(activeEditor)) {
                    activeEditor = null;
                    savedRange = null;
                }
                const key = newItem.dataset.itemKey;
                if (builderDeploymentOverrides[sectionKey] && key && builderDeploymentOverrides[sectionKey][key]) {
                    delete builderDeploymentOverrides[sectionKey][key];
                }
                newItem.remove();
            };
        }
        return newItem;
    }

    const SECTION_KEY_TO_MODALITY_SECTION = {
        'core-standards': 'CORE STANDARD',
        'clinical-standards': 'CLINICAL',
        'logistic-standards': 'LOGISTICS',
        'wash-standards': 'WASH'
    };

    let builderSelectedModalities = new Set(['embedded', 'coupled']);

    const TOOL_CONFIG = {
        'info': { title: 'INFO', icon: 'fa-info-circle', hasSubsections: false, weight: 0, enabled: true, editableContent: true },
        'definition': { title: 'DEFINITION', icon: 'fa-book', hasSubsections: false, weight: 0, enabled: true, editableContent: true },
        'org-detail': { title: 'ORGANIZATIONAL DETAIL', icon: 'fa-building', hasSubsections: false, weight: 0, enabled: true, editableContent: true },
        'guiding-principles': { title: 'GUIDING PRINCIPLES', icon: 'fa-star', hasSubsections: true, weight: 2, enabled: true, subsections: ['Safe Care - Written statement on behalf the organization', 'Equitable Care - Written statement on behalf the organization', 'Ethical Care - Written statement on behalf the organization', 'Accountable Response - Written statement on behalf the organization', 'Appropriate Response - Written statement on behalf the organization', 'Coordinated Response - Written statement on behalf the organization'] },
        'core-standards': { title: 'CORE STANDARDS', icon: 'fa-cogs', hasSubsections: true, weight: 18, enabled: true, subsections: ['Administration & Organizational Management', 'Human Resources', 'Professional Licensing & Conduct', 'Training of Teams', 'Coordination of EMTs', 'Records and Reporting'] },
        'clinical-standards': { 
            title: 'CLINICAL STANDARDS', icon: 'fa-stethoscope', hasSubsections: true, weight: 20, enabled: true, 
            subsections: [
                '<strong>Length of stay</strong> - Minimum length of stay',
                '<strong>Team size and configuration</strong> - SCTs should be adequately sized and appropriately configured for their tasking, 1 Community Health Worker (CHW) or equivalent per 25 patients',
                '<strong>Staff skills</strong> - The AWD outpatient team configuration requires staff who are experienced in outbreak context and are IPC trained',
                '<strong>Staff qualifications and experience</strong> - Staff must be competent in rapid evaluation of all patients, determining the degree of dehydration, implementing the treatment plan, managing oral rehydration, performing patient registration/record keeping, and initiating referral/transfer for cases needing higher levels of care. They must also be experienced in health promotion and providing basic psychosocial support',
                '<strong>Services Provided</strong> - Capacity (Minimum) 50 outpatients/day. ORP Places 10 ORP places (seats for rehydration under temporary observation). Opening Hours Daylight hours. Modality of Deployment Self-sustained or coupled to an existing health-care facility',
                '<strong>Screening</strong> - Assess level of dehydration. Assess indications and provide immediate isolation, if indicated. Recognize indications for and initiate referral',
                '<strong>Triage</strong> - The focus of triage in the outpatient setting is the rapid assessment of disease severity, primarily the level of dehydration. Treatment emphasizes rapid and appropriate rehydration to prevent death.',
                '<strong>Stabilization</strong> - Stabilization specifically refers to oral rehydration therapy in the outpatient context',
                '<strong>Treatment</strong> - Treatment is provided for cases that do not require inpatient care. This includes Oral Rehydration Treatment according to the level of dehydration (Treatment Plan A).',
                '<strong>Observation</strong> - Provide temporary observation.',
                '<strong>Referral</strong> - Recognize indications for and initiate referral of patients requiring higher levels of care. They must have clear SOPs on initiating and receiving referrals',
                '<strong>Isolation</strong> - Assess indications and provide immediate isolation, if indicated. They must maintain temporary isolation capacity',
                '<strong>Patient Education</strong> - Educate patients on the proper preparation of Oral Rehydration Solution (ORS), and provide basic psychosocial support',
                '<strong>Distribution</strong> - Distribute ORS sachets and water treatment products'
            ]
        },
        'logistic-standards': {
            title: 'LOGISTIC STANDARDS', icon: 'fa-truck', hasSubsections: true, weight: 10, enabled: true,
            subsections: [
                'Power and Fuel: EMTs must ensure sufficient, safe, sustainable and context appropriate fuel, power supply and lighting for their facilities, clinical care and support services.',
                'Communications: EMTs must have the ability to transmit by voice and data to the local and national coordination structures with at least one level of redundancy in case of failure.',
                'Transportation and fleet: EMTs must effectively coordinate the transportation of equipment and personnel to the scene and throughout the deployment.',
                'Food: EMTs must provide food requirements for all staff, inpatients and caregivers.',
                'Warehouse Management: EMTs have warehouse management processes and procedures that address preparedness requirements and an ability to respond in the field to manage consistent availability of supplies.',
                'Pharmacy supply chain and medical stock Management: EMTs are self-sufficient with enough pharmaceutical, medical consumables and medical equipment to deliver patient care.',
                'Donation Management: EMTs should have policies in place compliant with national and international standards, for anticipated donation of medical consumables, pharmaceuticals, equipment and/or their entire field facility.',
                'Safety and security: EMTs must demonstrate due diligence for the safety and security of their personnel and patients during deployment by putting in place management plans and practical measures appropriate to the operational context and communicate plans to those concerned.',
                'Facility structure, environment & ventilation: EMTs must be able to provide suitable and acceptable facilities for clinical care and staff needs.',
                'Site assessment and planning: EMTs are able to assess possible site locations and adapt their configuration to local conditions, including the possibility to work within or reinforce existing health facilities.',
                'Sequential build: EMTs must prioritize the establishment of their facility in a way that areas and services necessary for urgent patient care are established first while the rest of the facility is completed, allowing certain functions to be operational before deployment is fully completed.',
                'Mobilization: EMTs must be able to mobilize in the shortest possible time ensuring general and institutional interventions to support their operational readiness status.',
                'Demobilization: EMTs should have plans and procedures for coordinated demobilization that maximizes the time of operation and minimizes disruption, supporting recovery of normal local health services and local environmental impacts.'
            ]
        },
        'wash-standards': {
            title: 'WASH STANDARDS', icon: 'fa-hand-holding-water', hasSubsections: true, weight: 10, enabled: true,
            subsections: [
                'Water Supply: EMTs must ensure that patients, caregivers and staff have sufficient safe drinking water at all times, distributed through appropriate water collection points and facilities, to enable medical, personal hygiene, drinking, cooking, cleaning and laundry activities.',
                'Hygiene: EMTs should ensure that staff and patients can practice hand hygiene throughout the facility by promoting access to culturally appropriate materials and places for handwashing, as well as adequate access to showers, safe spaces and materials for personal and menstrual hygiene.',
                'Environmental cleaning: EMT facilities and the immediate environment should always be kept clean and hygienic. EMTs should have documented procedures and appropriate materials for immediate, routine and terminal cleaning to reduce risks of infection.',
                'Healthcare Waste Management: EMTs are responsible for the safe management and disposal of health waste generated at their facilities. Safe health-care waste management involves multiple steps: minimization, segregation, collection, storage, treatment and final disposal.',
                'Sanitation: EMTs must ensure that patients, staff and caregivers have accessible, appropriate, safe and sufficient facilities and well-documented procedures in place for management of excreta and grey and storm water to limit disease transmission.',
                'Vector and Pest Control: EMTs should ensure that patients, staff and caregivers are protected from disease vectors and pests by using appropriate equipment and methods adapted to the local context.',
                'Dead Body Management: EMTs need to be able to manage dead bodies in a way that is dignified, culturally appropriate, safe and according to public health practices.'
            ]
        },
        'summary': { title: 'SUMMARY', icon: 'fa-file-alt', hasSubsections: false, weight: 0, enabled: true, editableContent: true }
    };

    let activeEditor = null;
    let savedRange = null;
    const SECTION_CONTENT = {};

    function storeSelection(editor) {
        const selection = window.getSelection();
        if (!selection || selection.rangeCount === 0) return;
        const range = selection.getRangeAt(0);
        if (editor && editor.contains(range.commonAncestorContainer)) {
            savedRange = range.cloneRange();
        }
    }

    function restoreSelection(editor) {
        if (!savedRange || !editor || !editor.contains(savedRange.commonAncestorContainer)) {
            savedRange = null;
            if (editor) {
                editor.focus();
            }
            return;
        }
        const selection = window.getSelection();
        selection.removeAllRanges();
        selection.addRange(savedRange);
        editor.focus();
    }

    function renderDeploymentModalitiesSelector() {
        const container = document.getElementById('deployment-modalities-options');
        if (!container) return;
        container.innerHTML = '';
        DEPLOYMENT_MODALITIES.forEach(modality => {
            const isChecked = builderSelectedModalities.has(modality.key);
            container.insertAdjacentHTML('beforeend', `
                <label class="modality-option ${modality.accentClass} ${isChecked ? 'selected' : ''}" data-key="${modality.key}">
                    <input type="checkbox" class="deployment-modality-checkbox" data-key="${modality.key}" ${isChecked ? 'checked' : ''}>
                    <span class="modality-icon"><i class="fas ${modality.icon}"></i></span>
                    <span class="modality-label">${modality.label}</span>
                </label>
            `);
        });

        container.querySelectorAll('.deployment-modality-checkbox').forEach(input => {
            input.onchange = (event) => {
                const key = event.currentTarget.dataset.key;
                if (event.currentTarget.checked) {
                    builderSelectedModalities.add(key);
                } else {
                    builderSelectedModalities.delete(key);
                }
                const label = event.currentTarget.closest('.modality-option');
                if (label) {
                    label.classList.toggle('selected', event.currentTarget.checked);
                }
                updateBuilderModalityEditorsVisibility();
            };
        });

        updateBuilderModalityEditorsVisibility();
    }

    function getEditorTemplate(content = '', placeholder = 'Describe the standard...') {
        return `
            <div class="rich-text-editor">
                <div class="editor-toolbar">
                    <button type="button" class="btn btn-outline-secondary btn-sm format-btn" data-command="bold" title="Bold"><i class="fas fa-bold"></i></button>
                    <button type="button" class="btn btn-outline-secondary btn-sm format-btn" data-command="italic" title="Italic"><i class="fas fa-italic"></i></button>
                    <button type="button" class="btn btn-outline-secondary btn-sm format-btn" data-command="underline" title="Underline"><i class="fas fa-underline"></i></button>
                    <button type="button" class="btn btn-outline-secondary btn-sm format-btn" data-command="insertUnorderedList" title="Bulleted list"><i class="fas fa-list-ul"></i></button>
                    <button type="button" class="btn btn-outline-secondary btn-sm format-btn" data-command="insertOrderedList" title="Numbered list"><i class="fas fa-list-ol"></i></button>
                    <button type="button" class="btn btn-outline-secondary btn-sm insert-link-btn" title="Insert hyperlink"><i class="fas fa-link"></i></button>
                    <button type="button" class="btn btn-outline-secondary btn-sm insert-table-btn" title="Insert table"><i class="fas fa-table"></i></button>
                    <button type="button" class="btn btn-outline-secondary btn-sm format-btn" data-command="removeFormat" title="Clear formatting"><i class="fas fa-eraser"></i></button>
                </div>
                <div class="editor-content form-control" contenteditable="true" data-placeholder="${placeholder}">${content}</div>
            </div>
        `;
    }

    function buildDeploymentModalitiesCardHTML(selectedKeys = [], sctNameValue = '') {
        const selectedSet = new Set(selectedKeys);
        const optionsHTML = DEPLOYMENT_MODALITIES.map(modality => {
            const isSelected = selectedSet.has(modality.key);
            return `
            <div class="form-check modality-pill ${modality.accentClass} ${isSelected ? 'selected' : ''}">
                <input class="form-check-input deployment-modality-toggle" type="checkbox" id="modality-${modality.key}" data-modality="${modality.key}" ${isSelected ? 'checked' : ''}>
                <label class="form-check-label" for="modality-${modality.key}">
                    <span class="modality-pill-icon"><i class="fas ${modality.icon}"></i></span>
                    <span class="modality-pill-label">${modality.label}</span>
                </label>
            </div>
        `;
        }).join('');

        const escapedName = escapeHTML(sctNameValue);

        return `
            <div class="card section-card deployment-modalities-card">
                <div class="section-header">
                    <h5>Supported deployment modalities</h5>
                    <p class="text-muted small mb-0">Select the deployment profiles your SCT can support.</p>
                </div>
                <div class="card-body">
                    <div class="row g-3 align-items-end">
                        <div class="col-12 col-md-5 col-lg-4">
                            <label for="sctName" class="form-label">Name of the SCT</label>
                            <input type="text" class="form-control" id="sctName" value="${escapedName}" placeholder="e.g. Rehabilitation">
                        </div>
                        <div class="col-12 col-md-7 col-lg-8">
                            <div class="deployment-modality-grid">
                                ${optionsHTML}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    function buildDeploymentSummaryBannerHTML(selectedKeys = [], headingText = 'HID SCT Tool') {
        const selectedModalities = DEPLOYMENT_MODALITIES.filter(modality => selectedKeys.includes(modality.key));
        const pillsHTML = selectedModalities.map(modality => `
            <span class="deployment-summary-pill ${modality.accentClass || ''}">
                <i class="fas ${modality.icon || 'fa-clipboard'}"></i>
                ${escapeHTML(modality.label)}
            </span>
        `).join('');
        const hiddenClass = selectedModalities.length ? '' : ' d-none';
        return `
            <div class="deployment-summary-banner${hiddenClass}" id="deploymentSummaryBanner">
                <div class="deployment-summary-info">
                    <h2 class="deployment-summary-title" id="deploymentSummaryTitle">${escapeHTML(headingText)}</h2>
                    <p class="deployment-summary-subtitle" id="deploymentSummarySubtitle">Supported deployment modalities</p>
                </div>
                <div class="deployment-summary-pill-group" id="deploymentSummaryPills">${pillsHTML}</div>
            </div>
        `;
    }

    function buildDeploymentModalityDetailsHTML(selectedKeys = []) {
        const selectionSet = new Set(selectedKeys);

        const cardsHTML = DEPLOYMENT_MODALITIES.map(modality => {
            const modalityDetails = DEPLOYMENT_MODALITY_DETAILS[modality.key];
            let sectionsHTML = '';

            if (modalityDetails && Object.keys(modalityDetails).length > 0) {
                sectionsHTML = Object.entries(modalityDetails).map(([sectionName, subsections]) => {
                    const subsectionHTML = Object.entries(subsections || {}).map(([subsectionName, data]) => {
                        const requirements = (data && data.requirements ? data.requirements : []).map(item => `<li>${escapeHTML(item)}</li>`).join('') || '<li class="text-muted">No requirements provided.</li>';
                        const mitigations = (data && data.mitigation ? data.mitigation : []).map(item => `<li>${escapeHTML(item)}</li>`).join('') || '<li class="text-muted">No mitigation guidance provided.</li>';
                        return `
                            <div class="modality-subsection">
                                <h6 class="modality-subsection-title">${escapeHTML(subsectionName)}</h6>
                                <div class="modality-subsection-columns">
                                    <div>
                                        <span class="label-pill requirements-pill">Requirements</span>
                                        <ul class="mb-0">${requirements}</ul>
                                    </div>
                                    <div>
                                        <span class="label-pill mitigation-pill">Mitigation</span>
                                        <ul class="mb-0">${mitigations}</ul>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');

                    return `
                        <div class="modality-detail-section">
                            <div class="modality-section-header">
                                <span class="section-pill">${escapeHTML(sectionName)}</span>
                            </div>
                            <div class="modality-section-body">
                                ${subsectionHTML}
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                sectionsHTML = '<p class="text-muted mb-0">Operational detail data not yet defined for this modality.</p>';
            }

            const isSelected = selectionSet.has(modality.key);
            return `
                <div class="card section-card modality-detail-card ${modality.accentClass} ${isSelected ? '' : 'd-none'}" data-modality="${modality.key}">
                    <div class="card-body">
                        <div class="modality-card-header">
                            <div class="modality-card-icon"><i class="fas ${modality.icon}"></i></div>
                            <div>
                                <h5 class="mb-1">${escapeHTML(modality.label)} Deployment Profile</h5>
                                <p class="text-muted mb-0">Key operational requirements and mitigation strategies.</p>
                            </div>
                        </div>
                        <div class="modality-card-content">
                            ${sectionsHTML}
                        </div>
                    </div>
                </div>
            `;
        }).join('');

        if (!cardsHTML.trim()) {
            return '';
        }

        return `<div class="modality-details-container">${cardsHTML}</div>`;
    }

    function renderMakerUI() {
        const sectionsContainer = document.getElementById('sections-accordion');
        const weightsContainer = document.getElementById('weights-container');
        sectionsContainer.innerHTML = ''; weightsContainer.innerHTML = '';
        renderDeploymentModalitiesSelector();

        Object.entries(TOOL_CONFIG).forEach(([key, config]) => {
            if (config.editableContent && !SECTION_CONTENT[key]) {
                const template = document.getElementById(`template-${key}`);
                SECTION_CONTENT[key] = template ? template.innerHTML.trim() : '';
            }

            let sectionBody = '';
            if (config.hasSubsections) {
                sectionBody = `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h5 class="mb-0">Standards / Subsections (HTML allowed)</h5>
                    <div>
                        <button class="btn btn-outline-secondary btn-sm collapse-all-standards" data-section="${key}" title="Collapse all"><i class="fas fa-compress-alt me-1"></i>Collapse All</button>
                        <button class="btn btn-outline-secondary btn-sm expand-all-standards" data-section="${key}" title="Expand all"><i class="fas fa-expand-alt me-1"></i>Expand All</button>
                    </div>
                </div>
                <div id="subsections-${key}" class="subsections-container"></div>
                <button class="btn btn-outline-success mt-2 add-item" data-section="${key}"><i class="fas fa-plus me-2"></i>Add Standard</button>`;
            } else if (config.editableContent) {
                sectionBody = `<h5>Tab content (HTML allowed)</h5>
                <div class="section-content-editor" data-section="${key}">
                    ${getEditorTemplate(SECTION_CONTENT[key] || '', 'Edit the content for this tab...')}
                </div>`;
            } else {
                sectionBody = `<div class="alert alert-light">This section's content is fixed and will be inserted automatically in the final tool.</div>`;
            }

            const sectionHTML = `
                <div class="accordion-item" id="accordion-item-${key}">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-${key}">
                            <div class="section-header-controls w-100">
                                <span class="me-auto">Configure: ${config.title}</span>
                                <div class="form-check form-switch">
                                    <input class="form-check-input section-enable-switch" type="checkbox" data-key="${key}" ${config.enabled ? 'checked' : ''}>
                                    <label class="form-check-label">Enable</label>
                                </div>
                            </div>
                        </button>
                    </h2>
                    <div id="collapse-${key}" class="accordion-collapse collapse" data-bs-parent="#sections-accordion">
                        <div class="accordion-body">
                            <div class="mb-3">
                                <label class="form-label">Section Title</label>
                                <input type="text" class="form-control section-title-input" data-key="${key}" value="${config.title}">
                            </div>
                            ${sectionBody}
                        </div>
                    </div>
                </div>`;
            sectionsContainer.insertAdjacentHTML('beforeend', sectionHTML);

            if (config.hasSubsections) {
                const container = document.getElementById(`subsections-${key}`);
                const subsections = Array.isArray(config.subsections) ? config.subsections : [];
                subsections.forEach((entry, index) => {
                    if (entry && typeof entry === 'object' && entry.content !== undefined) {
                        addSubsectionItem(key, entry.content, { container, index, itemKey: entry.itemKey, titleText: entry.titleText });
                    } else {
                        addSubsectionItem(key, entry, { container, index });
                    }
                });
            }

            if (config.weight > 0) {
                const weightHTML = `<div class="col-md-4 mb-3" id="weight-div-${key}"><label class="form-label">${config.title}</label><input type="number" class="form-control weight-input" data-key="${key}" value="${config.weight}" min="0" ${!config.enabled ? 'disabled' : ''}></div>`;
                weightsContainer.insertAdjacentHTML('beforeend', weightHTML);
            }
        });
        updateWeightSum();
        addEventListeners();
        setupRichTextEditors();

        const firstItem = sectionsContainer.querySelector('.accordion-item');
        if (firstItem) {
            const firstButton = firstItem.querySelector('.accordion-button');
            const firstCollapse = firstItem.querySelector('.accordion-collapse');
            if (firstButton && firstCollapse) {
                firstButton.classList.remove('collapsed');
                firstButton.setAttribute('aria-expanded', 'true');
                firstCollapse.classList.add('show');
            }
        }
    }

    // Section Management Functions
    function renderSectionManagementList() {
        const listContainer = document.getElementById('section-management-list');
        if (!listContainer) return;

        listContainer.innerHTML = '';

        Object.entries(TOOL_CONFIG).forEach(([key, config]) => {
            if (config.weight > 0) { // Only show sections with weights
                const itemHTML = `
                    <div class="section-management-item" data-section-key="${key}" draggable="true">
                        <div class="drag-handle" title="Drag to reorder">
                            <i class="fas fa-grip-vertical"></i>
                        </div>
                        <div class="section-icon">
                            <i class="fas ${config.icon}"></i>
                        </div>
                        <div class="section-info">
                            <span class="section-name">${config.title}</span>
                            <div class="section-weight-edit">
                                <label class="form-label mb-0 me-2">Weight:</label>
                                <input type="number" class="form-control form-control-sm inline-weight-input"
                                    data-section-key="${key}" value="${config.weight}" min="0" max="100">
                                <span class="ms-1">%</span>
                            </div>
                        </div>
                        <div class="section-actions">
                            <button class="btn btn-sm btn-outline-primary edit-section-btn" data-section-key="${key}" title="Edit Section">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger delete-section-btn" data-section-key="${key}" title="Delete Section">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                listContainer.insertAdjacentHTML('beforeend', itemHTML);
            }
        });

        // Add event listeners for inline weight editing
        document.querySelectorAll('.inline-weight-input').forEach(input => {
            input.addEventListener('input', (e) => {
                const sectionKey = e.target.dataset.sectionKey;
                const newWeight = parseInt(e.target.value) || 0;

                // Update TOOL_CONFIG
                if (TOOL_CONFIG[sectionKey]) {
                    TOOL_CONFIG[sectionKey].weight = newWeight;
                }

                // Update the weight input in the weights container
                const weightInput = document.querySelector(`.weight-input[data-key="${sectionKey}"]`);
                if (weightInput) {
                    weightInput.value = newWeight;
                }

                updateWeightSum();
            });
        });

        // Add event listeners for delete buttons
        document.querySelectorAll('.delete-section-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const sectionKey = e.currentTarget.dataset.sectionKey;
                deleteSection(sectionKey);
            });
        });

        // Add drag-and-drop event listeners
        setupDragAndDrop();
    }

    let draggedElement = null;

    function setupDragAndDrop() {
        const items = document.querySelectorAll('.section-management-item');

        items.forEach(item => {
            item.addEventListener('dragstart', handleDragStart);
            item.addEventListener('dragend', handleDragEnd);
            item.addEventListener('dragover', handleDragOver);
            item.addEventListener('drop', handleDrop);
            item.addEventListener('dragleave', handleDragLeave);
        });
    }

    function handleDragStart(e) {
        draggedElement = this;
        this.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/html', this.innerHTML);
    }

    function handleDragEnd(e) {
        this.classList.remove('dragging');

        // Remove all drag-over classes
        document.querySelectorAll('.section-management-item').forEach(item => {
            item.classList.remove('drag-over');
        });
    }

    function handleDragOver(e) {
        if (e.preventDefault) {
            e.preventDefault();
        }

        e.dataTransfer.dropEffect = 'move';

        if (this !== draggedElement) {
            this.classList.add('drag-over');
        }

        return false;
    }

    function handleDragLeave(e) {
        this.classList.remove('drag-over');
    }

    function handleDrop(e) {
        if (e.stopPropagation) {
            e.stopPropagation();
        }

        if (draggedElement !== this) {
            // Get the section keys
            const draggedKey = draggedElement.dataset.sectionKey;
            const targetKey = this.dataset.sectionKey;

            // Reorder sections in TOOL_CONFIG
            reorderSections(draggedKey, targetKey);

            // Re-render both section management list and main UI
            renderSectionManagementList();
            renderMakerUI();
        }

        return false;
    }

    function reorderSections(draggedKey, targetKey) {
        // Get all section keys in current order
        const keys = Object.keys(TOOL_CONFIG);

        // Find indices
        const draggedIndex = keys.indexOf(draggedKey);
        const targetIndex = keys.indexOf(targetKey);

        if (draggedIndex === -1 || targetIndex === -1) return;

        // Remove dragged item and insert before target
        keys.splice(draggedIndex, 1);
        const newTargetIndex = keys.indexOf(targetKey);
        keys.splice(newTargetIndex, 0, draggedKey);

        // Recreate TOOL_CONFIG in new order
        const newConfig = {};
        keys.forEach(key => {
            newConfig[key] = TOOL_CONFIG[key];
        });

        // Replace TOOL_CONFIG
        Object.keys(TOOL_CONFIG).forEach(key => delete TOOL_CONFIG[key]);
        Object.assign(TOOL_CONFIG, newConfig);
    }

    // Drag and drop for subsection items (standards within sections)
    let draggedSubsection = null;

    function setupSubsectionDragAndDrop(item) {
        item.addEventListener('dragstart', function(e) {
            draggedSubsection = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
        });

        item.addEventListener('dragend', function(e) {
            this.classList.remove('dragging');
            document.querySelectorAll('.subsection-item').forEach(item => {
                item.classList.remove('drag-over');
            });
        });

        item.addEventListener('dragover', function(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';

            // Only allow drop if same section
            if (draggedSubsection && this !== draggedSubsection) {
                const draggedSection = draggedSubsection.dataset.section;
                const targetSection = this.dataset.section;

                if (draggedSection === targetSection) {
                    this.classList.add('drag-over');
                }
            }

            return false;
        });

        item.addEventListener('dragleave', function(e) {
            this.classList.remove('drag-over');
        });

        item.addEventListener('drop', function(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }

            if (draggedSubsection && draggedSubsection !== this) {
                const draggedSection = draggedSubsection.dataset.section;
                const targetSection = this.dataset.section;

                // Only reorder if within same section
                if (draggedSection === targetSection) {
                    const container = this.parentNode;
                    const allItems = Array.from(container.querySelectorAll('.subsection-item'));
                    const draggedIndex = allItems.indexOf(draggedSubsection);
                    const targetIndex = allItems.indexOf(this);

                    if (draggedIndex < targetIndex) {
                        // Insert after target
                        this.parentNode.insertBefore(draggedSubsection, this.nextSibling);
                    } else {
                        // Insert before target
                        this.parentNode.insertBefore(draggedSubsection, this);
                    }

                    // Update data-default-index for all items in this section
                    const updatedItems = Array.from(container.querySelectorAll('.subsection-item'));
                    updatedItems.forEach((item, index) => {
                        item.dataset.defaultIndex = index;
                    });
                }
            }

            return false;
        });
    }

    function deleteSection(sectionKey) {
        if (!TOOL_CONFIG[sectionKey]) return;

        if (!confirm(`Are you sure you want to delete the section "${TOOL_CONFIG[sectionKey].title}"?`)) {
            return;
        }

        // Remove from TOOL_CONFIG
        delete TOOL_CONFIG[sectionKey];

        // Remove from UI
        const accordionItem = document.getElementById(`accordion-item-${sectionKey}`);
        if (accordionItem) accordionItem.remove();

        const weightDiv = document.getElementById(`weight-div-${sectionKey}`);
        if (weightDiv) weightDiv.remove();

        // Re-render section management list and update weight sum
        renderSectionManagementList();
        updateWeightSum();
    }

    function createNewSection() {
        const key = document.getElementById('new-section-key').value.trim();
        const title = document.getElementById('new-section-title').value.trim();
        const icon = document.getElementById('new-section-icon').value.trim();
        const weight = parseInt(document.getElementById('new-section-weight').value) || 0;
        const hasSubsections = document.getElementById('new-section-has-subsections').checked;
        const subsectionsText = document.getElementById('new-section-subsections').value.trim();

        // Validation
        if (!key) {
            alert('Please enter a section key');
            return;
        }

        if (TOOL_CONFIG[key]) {
            alert('A section with this key already exists. Please use a unique key.');
            return;
        }

        if (!title) {
            alert('Please enter a section title');
            return;
        }

        // Parse subsections
        let subsections = [];
        if (hasSubsections && subsectionsText) {
            subsections = subsectionsText.split('\n').filter(line => line.trim() !== '');
        }

        // Create new section config
        const newSection = {
            title: title,
            icon: icon || 'fa-cog',
            hasSubsections: hasSubsections,
            weight: weight,
            enabled: true,
            subsections: hasSubsections ? subsections : undefined,
            editableContent: !hasSubsections
        };

        // Add to TOOL_CONFIG
        TOOL_CONFIG[key] = newSection;

        // Close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('addSectionModal'));
        modal.hide();

        // Clear form
        document.getElementById('new-section-key').value = '';
        document.getElementById('new-section-title').value = '';
        document.getElementById('new-section-icon').value = '';
        document.getElementById('new-section-weight').value = '0';
        document.getElementById('new-section-subsections').value = '';

        // Re-render UI
        renderMakerUI();
        renderSectionManagementList();
    }

    function addEventListeners() {
        document.querySelectorAll('.add-item').forEach(btn => btn.onclick = e => {
            const section = e.currentTarget.dataset.section;
            addSubsectionItem(section, '');
        });
        document.querySelectorAll('.weight-input').forEach(input => input.oninput = updateWeightSum);
        document.querySelectorAll('.section-enable-switch').forEach(toggle => toggle.onchange = e => {
            const key = e.currentTarget.dataset.key;
            const weightInput = document.querySelector(`.weight-input[data-key="${key}"]`);
            if (weightInput) weightInput.disabled = !e.currentTarget.checked;
            document.getElementById(`accordion-item-${key}`).style.opacity = e.currentTarget.checked ? '1' : '0.5';
            updateWeightSum();
        });
        document.getElementById('btn-make').onclick = generateHTML;

        // Collapse/Expand all standards buttons
        document.querySelectorAll('.collapse-all-standards').forEach(btn => {
            btn.onclick = (e) => {
                const section = e.currentTarget.dataset.section;
                const container = document.getElementById(`subsections-${section}`);
                if (container) {
                    const collapses = container.querySelectorAll('.collapse');
                    collapses.forEach(collapse => {
                        const bsCollapse = bootstrap.Collapse.getInstance(collapse) || new bootstrap.Collapse(collapse, { toggle: false });
                        bsCollapse.hide();
                    });
                }
            };
        });

        document.querySelectorAll('.expand-all-standards').forEach(btn => {
            btn.onclick = (e) => {
                const section = e.currentTarget.dataset.section;
                const container = document.getElementById(`subsections-${section}`);
                if (container) {
                    const collapses = container.querySelectorAll('.collapse');
                    collapses.forEach(collapse => {
                        const bsCollapse = bootstrap.Collapse.getInstance(collapse) || new bootstrap.Collapse(collapse, { toggle: false });
                        bsCollapse.show();
                    });
                }
            };
        });

        // Section Management Event Listeners
        const btnAddSection = document.getElementById('btn-add-section');
        if (btnAddSection) {
            btnAddSection.onclick = () => {
                const modal = new bootstrap.Modal(document.getElementById('addSectionModal'));
                modal.show();
            };
        }

        const btnCreateSection = document.getElementById('btn-create-section');
        if (btnCreateSection) {
            btnCreateSection.onclick = createNewSection;
        }

        // Toggle subsections input based on checkbox
        const hasSubsectionsCheckbox = document.getElementById('new-section-has-subsections');
        if (hasSubsectionsCheckbox) {
            hasSubsectionsCheckbox.addEventListener('change', (e) => {
                const subsectionsContainer = document.getElementById('subsections-input-container');
                subsectionsContainer.style.display = e.target.checked ? 'block' : 'none';
            });
        }
    }

    function setupRichTextEditors(root = document) {
        root.querySelectorAll('.editor-content').forEach(editor => {
            if (editor.dataset.editorInitialized === 'true') {
                return;
            }
            editor.dataset.editorInitialized = 'true';

            const updatePlaceholderState = () => {
                const text = editor.innerText.trim();
                editor.classList.toggle('empty', text.length === 0);
            };

            const handleInput = () => {
                updatePlaceholderState();
                storeSelection(editor);
            };

            const handleFocus = () => {
                activeEditor = editor;
                editor.classList.add('focus');
                storeSelection(editor);
            };

            const handleBlur = () => {
                editor.classList.remove('focus');
                if (activeEditor === editor) {
                    activeEditor = null;
                    savedRange = null;
                }
            };

            const persistSelection = () => storeSelection(editor);

            updatePlaceholderState();

            editor.addEventListener('input', handleInput);
            editor.addEventListener('focus', handleFocus);
            editor.addEventListener('blur', handleBlur);
            editor.addEventListener('keyup', persistSelection);
            editor.addEventListener('mouseup', persistSelection);

            editor._updatePlaceholder = updatePlaceholderState;
        });

        root.querySelectorAll('.format-btn').forEach(btn => {
            if (btn.dataset.editorHandlerAttached === 'true') {
                return;
            }
            btn.dataset.editorHandlerAttached = 'true';

            btn.addEventListener('mousedown', e => {
                e.preventDefault();
                const command = btn.dataset.command;
                const value = btn.dataset.value || null;
                const container = btn.closest('.subsection-item') || btn.closest('.section-content-editor') || btn.closest('.rich-text-editor');
                const editor = container ? container.querySelector('.editor-content') : null;
                if (!editor) {
                    return;
                }
                if (activeEditor !== editor) {
                    activeEditor = editor;
                }
                restoreSelection(editor);
                document.execCommand(command, false, value);
                editor._updatePlaceholder?.();
                storeSelection(editor);
            });
        });

        // Handle table insertion
        root.querySelectorAll('.insert-table-btn').forEach(btn => {
            if (btn.dataset.tableHandlerAttached === 'true') {
                return;
            }
            btn.dataset.tableHandlerAttached = 'true';

            btn.addEventListener('click', e => {
                e.preventDefault();
                const container = btn.closest('.subsection-item') || btn.closest('.section-content-editor') || btn.closest('.rich-text-editor');
                const editor = container ? container.querySelector('.editor-content') : null;
                if (!editor) {
                    return;
                }

                // Prompt for table dimensions
                const rows = prompt('Number of rows:', '3');
                const cols = prompt('Number of columns:', '3');

                if (!rows || !cols || isNaN(rows) || isNaN(cols)) {
                    return;
                }

                const numRows = parseInt(rows);
                const numCols = parseInt(cols);

                if (numRows < 1 || numCols < 1 || numRows > 20 || numCols > 10) {
                    alert('Please enter valid dimensions (rows: 1-20, columns: 1-10)');
                    return;
                }

                // Create table element programmatically
                const table = document.createElement('table');
                table.className = 'resizable';
                table.style.width = 'auto';

                const tbody = document.createElement('tbody');

                // Add header row
                const headerRow = document.createElement('tr');
                for (let c = 0; c < numCols; c++) {
                    const th = document.createElement('th');
                    th.contentEditable = 'true';
                    th.textContent = `Header ${c + 1}`;
                    headerRow.appendChild(th);
                }
                tbody.appendChild(headerRow);

                // Add data rows
                for (let r = 0; r < numRows - 1; r++) {
                    const row = document.createElement('tr');
                    for (let c = 0; c < numCols; c++) {
                        const td = document.createElement('td');
                        td.contentEditable = 'true';
                        td.textContent = 'Cell';
                        row.appendChild(td);
                    }
                    tbody.appendChild(row);
                }

                table.appendChild(tbody);

                // Insert table at cursor
                editor.focus();
                if (activeEditor !== editor) {
                    activeEditor = editor;
                }
                restoreSelection(editor);

                // Use range to insert the table
                const selection = window.getSelection();
                if (selection.rangeCount > 0) {
                    const range = selection.getRangeAt(0);
                    range.deleteContents();
                    range.insertNode(table);

                    // Add a paragraph after the table
                    const p = document.createElement('p');
                    p.innerHTML = '<br>';
                    range.collapse(false);
                    range.insertNode(p);

                    // Move cursor to the new paragraph
                    range.setStart(p, 0);
                    range.collapse(true);
                    selection.removeAllRanges();
                    selection.addRange(range);
                }

                editor._updatePlaceholder?.();
                storeSelection(editor);

                // Make table resizable
                makeTablesResizable(editor);
            });
        });

        // Handle hyperlink insertion
        root.querySelectorAll('.insert-link-btn').forEach(btn => {
            if (btn.dataset.linkHandlerAttached === 'true') {
                return;
            }
            btn.dataset.linkHandlerAttached = 'true';

            btn.addEventListener('click', e => {
                e.preventDefault();
                const container = btn.closest('.subsection-item') || btn.closest('.section-content-editor') || btn.closest('.rich-text-editor');
                const editor = container ? container.querySelector('.editor-content') : null;
                if (!editor) {
                    return;
                }

                editor.focus();
                if (activeEditor !== editor) {
                    activeEditor = editor;
                }
                restoreSelection(editor);

                const selection = window.getSelection();
                let selectedText = '';
                let existingLink = null;

                // Check if we're clicking on an existing link
                if (selection.rangeCount > 0) {
                    const range = selection.getRangeAt(0);
                    let node = range.commonAncestorContainer;

                    // Find if we're inside a link
                    while (node && node !== editor) {
                        if (node.nodeType === Node.ELEMENT_NODE && node.tagName === 'A') {
                            existingLink = node;
                            break;
                        }
                        node = node.parentNode;
                    }

                    selectedText = selection.toString();
                }

                // If editing existing link
                if (existingLink) {
                    const currentUrl = existingLink.href;
                    const currentText = existingLink.textContent;

                    const action = confirm('Do you want to edit this link? Click OK to edit, Cancel to remove.');

                    if (action) {
                        // Edit link
                        const newUrl = prompt('Enter URL:', currentUrl);
                        if (newUrl !== null && newUrl.trim()) {
                            existingLink.href = newUrl.trim();
                            showToast('Link updated', 'success');
                        }
                    } else {
                        // Remove link
                        const text = document.createTextNode(existingLink.textContent);
                        existingLink.parentNode.replaceChild(text, existingLink);
                        showToast('Link removed', 'info');
                    }

                    editor._updatePlaceholder?.();
                    storeSelection(editor);
                    return;
                }

                // Insert new link
                const url = prompt('Enter URL:', 'https://');
                if (!url || !url.trim() || url === 'https://') {
                    return;
                }

                const linkText = selectedText || prompt('Enter link text:', url);
                if (!linkText) {
                    return;
                }

                // Create the link
                const link = document.createElement('a');
                link.href = url.trim();
                link.textContent = linkText;
                link.target = '_blank';
                link.rel = 'noopener noreferrer';

                // Insert the link
                if (selection.rangeCount > 0) {
                    const range = selection.getRangeAt(0);
                    range.deleteContents();
                    range.insertNode(link);

                    // Add a space after the link
                    const space = document.createTextNode(' ');
                    range.collapse(false);
                    range.insertNode(space);

                    // Move cursor after the space
                    range.setStartAfter(space);
                    range.collapse(true);
                    selection.removeAllRanges();
                    selection.addRange(range);
                }

                editor._updatePlaceholder?.();
                storeSelection(editor);
                showToast('Link inserted', 'success');
            });
        });
    }

    function makeTablesResizable(editor) {
        const tables = editor.querySelectorAll('table.resizable');
        tables.forEach(table => {
            if (table.dataset.resizableInitialized === 'true') {
                return;
            }
            table.dataset.resizableInitialized = 'true';

            // Make table manually resizable
            table.style.resize = 'both';
            table.style.overflow = 'auto';
            table.style.display = 'inline-table';
        });
    }

    function updateWeightSum() {
        const sum = Array.from(document.querySelectorAll('.weight-input:not(:disabled)')).reduce((acc, input) => acc + (parseInt(input.value) || 0), 0);
        const alertDiv = document.getElementById('weight-sum-alert');
        document.getElementById('weight-sum').textContent = sum;
        alertDiv.classList.toggle('alert-danger', sum !== 100);
        alertDiv.classList.toggle('alert-info', sum === 100);
    }
    
    function generateHTML() {
        // 1. Gather all customizations from the maker UI
        const finalConfig = {};
        const debugInfo = { sections: {}, modalities: [] };

        document.querySelectorAll('.section-title-input').forEach(input => {
            const key = input.dataset.key;
            finalConfig[key] = {
                ...TOOL_CONFIG[key],
                title: input.value,
                enabled: document.querySelector(`.section-enable-switch[data-key="${key}"]`).checked,
                weight: (function () {
                    const weightInput = document.querySelector(`.weight-input[data-key="${key}"]`);
                    const value = weightInput ? weightInput.value : '0';
                    return parseInt(value || '0', 10);
                })()
            };

            debugInfo.sections[key] = {
                title: finalConfig[key].title,
                enabled: finalConfig[key].enabled,
                hasSubsections: finalConfig[key].hasSubsections
            };

            if (finalConfig[key].hasSubsections) {
                const items = Array.from(document.querySelectorAll(`#subsections-${key} .subsection-item`));
                finalConfig[key].subsections = items.map((item, index) => {
                    const editor = item.querySelector('.editor-content');
                    const content = editor ? editor.innerHTML.trim() : '';
                    const itemKey = item.dataset.itemKey || generateSubsectionKey(key);
                    const titleInput = item.querySelector('.standard-title-input');
                    const defaultIndex = parseInt(item.dataset.defaultIndex, 10);
                    const fallbackTitle = Number.isFinite(defaultIndex)
                        ? `Standard ${defaultIndex + 1}`
                        : `Standard ${index + 1}`;
                    let titleText = titleInput ? titleInput.value.trim() : '';
                    if (!titleText && item.dataset.title) {
                        titleText = item.dataset.title.trim();
                    }
                    if (!titleText) {
                        titleText = fallbackTitle;
                    }
                    item.dataset.title = titleText;
                    const summaryTitle = item.querySelector('.builder-deployment-summary-title');
                    if (summaryTitle) {
                        summaryTitle.textContent = titleText;
                    }
                    const details = item.querySelector('.builder-deployment-editor');
                    if (details) {
                        details.dataset.title = titleText;
                    }
                    ensureDeploymentOverride(key, itemKey, titleText);

                    console.log(`Captured subsection ${key}[${index}]:`, {
                        titleText,
                        contentLength: content.length,
                        contentPreview: content.substring(0, 100)
                    });

                    return { content, itemKey, titleText };
                });

                debugInfo.sections[key].subsectionCount = finalConfig[key].subsections.length;
            }
            if (finalConfig[key].editableContent) {
                const editor = document.querySelector(`#accordion-item-${key} .section-content-editor .editor-content`);
                const content = editor ? editor.innerHTML.trim() : '';
                finalConfig[key].content = content;

                console.log(`Captured editable content for ${key}:`, {
                    contentLength: content.length,
                    contentPreview: content.substring(0, 100)
                });
            }
        });

        const selectedModalities = Array.from(document.querySelectorAll('.deployment-modality-checkbox'))
            .filter(cb => cb.checked)
            .map(cb => cb.dataset.key);

        debugInfo.modalities = selectedModalities;
        console.log('Selected deployment modalities:', selectedModalities);

        const sctNameField = document.getElementById('sctName');
        const rawSctName = sctNameField ? sctNameField.value.trim() : '';
        const headingText = rawSctName
            ? (rawSctName.toLowerCase().endsWith('sct tool') ? rawSctName : rawSctName + ' SCT Tool')
            : 'HID SCT Tool';

        console.log('SCT Name:', rawSctName, '-> Heading:', headingText);

        const deploymentModalitiesCardHTML = buildDeploymentModalitiesCardHTML(selectedModalities, rawSctName);
        const deploymentModalityDetailsHTML = buildDeploymentModalityDetailsHTML(selectedModalities);
        const deploymentSummaryBannerHTML = buildDeploymentSummaryBannerHTML(selectedModalities, headingText);
        const defaultModalityState = {};
        DEPLOYMENT_MODALITIES.forEach(modality => {
            defaultModalityState[modality.key] = selectedModalities.includes(modality.key);
        });

        console.log('Default Modality State for generated tool:', defaultModalityState);
        console.log('Full debug info:', debugInfo);

        const enabledSections = Object.entries(finalConfig).filter(([, config]) => config.enabled);

        // 2. Build Sidebar and Tab Panes
        let sidebarLinks = enabledSections.map(([key, config]) => `
            <li class="nav-item"><a class="nav-link" href="#${key}" data-bs-toggle="tab"><i class="fas ${config.icon}"></i> ${config.title}</a></li>`).join('');

        const escapeHTML = (value = '') => value
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');

        const stripHTML = (value = '') => value.replace(/<[^>]*>/g, ' ').replace(/\s+/g, ' ').trim();

        const normalizeStandardName = (value = '') => stripHTML(value)
            .toLowerCase()
            .replace(/&amp;/g, 'and')
            .replace(/[^a-z0-9]+/g, ' ')
            .trim();

        const getModalityMeta = (key) => {
            const meta = DEPLOYMENT_MODALITIES.find(modality => modality.key === key);
            return meta || { key, label: key, icon: 'fa-clipboard', accentClass: '' };
        };

        const findModalityDetail = (modalityKey, sectionKey, standardTitle) => {
            return findModalityDetailSource(modalityKey, sectionKey, standardTitle);
        };

        const buildDeploymentRequirementsBlock = (sectionKey, standardTitle, itemId, itemKey) => {
            const mappedSection = SECTION_KEY_TO_MODALITY_SECTION[sectionKey];
            if (!mappedSection || !selectedModalities || selectedModalities.length === 0) {
                return '';
            }

            ensureDeploymentOverride(sectionKey, itemKey, standardTitle);
            const modalityBlocks = selectedModalities.map(modalityKey => {
                const overridesForSection = builderDeploymentOverrides[sectionKey] || {};
                const overrideRecord = overridesForSection[itemKey] && overridesForSection[itemKey][modalityKey];
                const details = overrideRecord || findModalityDetail(modalityKey, sectionKey, standardTitle) || {};
                const meta = getModalityMeta(modalityKey);
                const requirementsValue = typeof details.requirements === 'string'
                    ? details.requirements
                    : Array.isArray(details.requirements) ? details.requirements.join('\n') : '';
                const mitigationValue = typeof details.mitigation === 'string'
                    ? details.mitigation
                    : Array.isArray(details.mitigation) ? details.mitigation.join('\n') : '';
                return `
                    <div class="modality-requirement-block ${meta.accentClass || ''}" data-section="${sectionKey}" data-item="${itemId}" data-modality="${modalityKey}">
                        <div class="modality-requirement-header">
                            <span class="modality-badge"><i class="fas ${meta.icon || 'fa-clipboard'}"></i> ${escapeHTML(meta.label)} Mode</span>
                        </div>
                        <div class="modality-requirement-columns">
                            <div>
                                <label>Requirements</label>
                                <textarea class="form-control deployment-textarea deployment-requirement-input" data-section="${sectionKey}" data-item="${itemId}" data-modality="${modalityKey}" data-field="requirements" rows="4">${escapeHTML(requirementsValue)}</textarea>
                            </div>
                            <div>
                                <label>Mitigations</label>
                                <textarea class="form-control deployment-textarea deployment-mitigation-input" data-section="${sectionKey}" data-item="${itemId}" data-modality="${modalityKey}" data-field="mitigation" rows="4">${escapeHTML(mitigationValue)}</textarea>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            if (!modalityBlocks) {
                return '';
            }

            return `
                <div class="deployment-requirements-card">
                    <div class="deployment-requirements-header">
                        <span class="deployment-requirements-title"><i class="fas fa-clipboard-check"></i> Deployment Requirements</span>
                        <small class="text-muted">Adjust operational expectations for each supported modality.</small>
                    </div>
                    <div class="deployment-requirements-body">
                        ${modalityBlocks}
                    </div>
                </div>
            `;
        };

        let tabPanes = enabledSections.map(([key, config]) => {
            let content = '';
            if (config.hasSubsections) {
        const subsectionCards = (config.subsections || []).map((subEntry, index) => {
            const entry = (subEntry && typeof subEntry === 'object' && subEntry.content !== undefined)
                ? subEntry
                : { content: subEntry };
            const parsed = splitStandardContent(entry.content || '', index, entry.titleText);
            const titleText = entry.titleText || parsed.titleText || `Standard ${index + 1}`;
            const baseId = stripHTML(`${titleText}-${index + 1}`).toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '');
            const subId = `${index + 1}-${baseId || 'item'}`.slice(0, 60);
            const safeTitle = escapeHTML(titleText);
            const itemKey = entry.itemKey || generateSubsectionKey(key);
            const deploymentBlock = buildDeploymentRequirementsBlock(key, titleText, subId, itemKey);
            return `
                <div class="compliance-card" data-section="${key}" data-item="${subId}">
                    <div class="card-inner">
                        <div class="card-header" data-bs-toggle="collapse" data-bs-target="#collapse-${key}-${subId}" role="button" aria-expanded="false">
                            <div class="d-flex justify-content-between align-items-center w-100">
                                <h5 class="subsection-title mb-0">${safeTitle}</h5>
                                <div class="d-flex align-items-center gap-2">
                                    <span class="score-badge" data-score="0">Not Started</span>
                                    <i class="fas fa-chevron-down collapse-icon"></i>
                                </div>
                            </div>
                        </div>
                        <div id="collapse-${key}-${subId}" class="collapse">
                            <div class="card-body">
                                <div class="card-description">${parsed.bodyHTML}</div>
                                ${deploymentBlock}
                                <div class="card-fields">
                                    <div class="field-group">
                                        <label>Describe evidence</label>
                                        <textarea class="form-control evidence-input" data-section="${key}" data-item="${subId}" rows="3"></textarea>
                                    </div>
                                    <div class="field-group">
                                        <label>Gaps</label>
                                        <textarea class="form-control gaps-input" data-section="${key}" data-item="${subId}" rows="3"></textarea>
                                    </div>
                                    <div class="field-group">
                                        <label>Actions</label>
                                        <textarea class="form-control action-input" data-section="${key}" data-item="${subId}" rows="3"></textarea>
                                    </div>
                                </div>
                            </div>
                            <div class="card-footer">
                                <div class="score-select-wrapper">
                                    <label>Compliance score</label>
                                    <select class="form-select score-select compliance-score" data-section="${key}" data-item="${subId}">
                                        <option value="">-</option>
                                        <option value="0" selected>0 - Not started</option>
                                        <option value="1">1 - Initial</option>
                                        <option value="2">2 - In progress</option>
                                        <option value="3">3 - Completed</option>
                                        <option value="NA">N/A</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`;
                }).join('');

                content = `
                    <section class="compliance-section">
                        <div class="section-banner">
                            <div class="banner-info">
                                <h2>${config.title}</h2>
                                <p>Compliance</p>
                            </div>
                            <div class="section-progress">
                                <span class="progress-pill" id="${key}Score">0% Complete</span>
                            </div>
                        </div>
                        <div class="subsection-list">
                            ${subsectionCards}
                        </div>
                        <div class="comments-panel">
                            <label for="${key}Comments" class="form-label">Mentor Comments &amp; Observations</label>
                            <textarea class="form-control" id="${key}Comments" rows="4"></textarea>
                        </div>
                    </section>`;
            } else if (config.editableContent) {
                let tabContent = config.content || '';
                if (key === 'org-detail') {
                    tabContent += deploymentModalitiesCardHTML + deploymentModalityDetailsHTML;
                }
                content = tabContent;
            } else {
                content = document.getElementById(`template-${key}`).innerHTML;
            }
            return `<div class="tab-pane fade" id="${key}">${content}</div>`;
        }).join('');

        sidebarLinks = sidebarLinks.replace('class="nav-link"', 'class="nav-link active"');
        tabPanes = tabPanes.replace('class="tab-pane fade"', 'class="tab-pane fade show active"');

        const weightsData = enabledSections
            .filter(([,c]) => c.weight > 0)
            .map(([k,c]) => ({ name: c.title.toUpperCase(), weight: c.weight, section: k }));

        const modalityMetadataJSON = JSON.stringify(DEPLOYMENT_MODALITIES);
        const defaultModalityStateJSON = JSON.stringify(defaultModalityState);

        const fullHTML = `
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HID SCT Self-Assessment Grid - Customized</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"><\/script>
    <style>
        :root {
            --primary: #0d6efd;
            --secondary: #6c757d;
            --success: #198754;
            --info: #0dcaf0;
            --warning: #ffc107;
            --danger: #dc3545;
            --light: #f8f9fa;
            --dark: #212529;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7f9;
            padding: 20px 0;
        }

        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            box-shadow: 0 0 20px rgba(15, 23, 42, 0.12);
            border-radius: 16px;
            overflow: hidden;
        }

        .sidebar {
            background: linear-gradient(180deg, #1f2937 0%, #111827 100%);
            color: white;
            height: 100vh;
            position: sticky;
            top: 0;
            padding-top: 20px;
            overflow-y: auto;
        }

        .sidebar .nav-link {
            color: rgba(255, 255, 255, 0.8);
            border-left: 3px solid transparent;
            padding: 10px 15px;
            margin: 5px 0;
            transition: all 0.3s ease;
        }

        .sidebar .nav-link:hover,
        .sidebar .nav-link.active {
            color: white;
            background-color: rgba(255, 255, 255, 0.1);
            border-left-color: #a855f7;
        }

        .sidebar .nav-link i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }

        .main-content {
            padding: 24px;
            max-height: 100vh;
            overflow-y: auto;
            background: #f8f9ff;
        }

        .author-credit {
            font-size: 0.9rem;
            color: #475569;
            margin-bottom: 16px;
        }

        .author-credit a {
            color: #4338ca;
            text-decoration: none;
            font-weight: 600;
        }

        .author-credit a:hover {
            text-decoration: underline;
        }

        .deployment-summary-banner {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #312e81, #6366f1);
            color: #ffffff;
            padding: 24px;
            border-radius: 18px;
            margin-bottom: 24px;
            box-shadow: 0 12px 32px rgba(79, 70, 229, 0.24);
            gap: 16px;
        }

        .deployment-summary-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .deployment-summary-title {
            font-size: 1.75rem;
            margin: 0 0 6px;
            font-weight: 700;
        }

        .deployment-summary-subtitle {
            margin: 0;
            font-size: 0.95rem;
            opacity: 0.85;
        }

        .deployment-summary-pill-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .deployment-summary-pill {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            border-radius: 999px;
            background: rgba(255, 255, 255, 0.92);
            color: #1f2937;
            font-weight: 600;
            box-shadow: 0 6px 18px rgba(15, 23, 42, 0.12);
            transition: transform 0.2s ease;
        }

        .deployment-summary-pill i {
            font-size: 0.9rem;
        }

        .deployment-summary-pill.embedded {
            background: #dbeafe;
            color: #1d4ed8;
        }

        .deployment-summary-pill.coupled {
            background: #fef3c7;
            color: #b45309;
        }

        .deployment-summary-pill.self-sustained {
            background: #dcfce7;
            color: #15803d;
        }

        .progress-sidebar {
            background-color: #ffffff;
            height: 100vh;
            position: sticky;
            top: 0;
            padding: 24px 18px;
            overflow-y: auto;
            border-left: 1px solid #e5e7eb;
        }

        .progress-bar-container {
            background-color: #eef2ff;
            border-radius: 999px;
            margin-bottom: 20px;
            height: 16px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            border-radius: 999px;
            transition: width 0.5s ease;
        }

        .section-card {
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(15, 23, 42, 0.08);
            border: none;
            border-radius: 12px;
        }

        .deployment-modalities-card .section-header {
            display: flex;
            flex-direction: column;
            gap: 4px;
            background: #f8f9ff;
            padding: 18px 20px;
            border-bottom: 1px solid #e2e8f0;
        }

        .deployment-modalities-card .card-body {
            padding: 20px;
        }

        .deployment-modality-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
        }

        .modality-pill {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            border-radius: 999px;
            background: #f8fafc;
            border: 1px solid #cbd5f5;
            transition: all 0.2s ease;
        }

        .modality-pill.selected {
            background: linear-gradient(135deg, rgba(79, 70, 229, 0.24), rgba(59, 130, 246, 0.24));
            border-color: transparent;
            box-shadow: 0 10px 24px rgba(59, 130, 246, 0.18);
        }

        .modality-pill .form-check-label {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 0;
            cursor: pointer;
            font-weight: 600;
            color: #334155;
        }

        .modality-pill input {
            display: none;
        }

        .modality-pill-icon {
            width: 34px;
            height: 34px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ffffff;
            font-size: 1rem;
        }

        .modality-pill.embedded .modality-pill-icon {
            background: linear-gradient(135deg, #2563eb, #3b82f6);
        }

        .modality-pill.coupled .modality-pill-icon {
            background: linear-gradient(135deg, #f59e0b, #fbbf24);
        }

        .modality-pill.self-sustained .modality-pill-icon {
            background: linear-gradient(135deg, #16a34a, #22c55e);
        }

        .modality-details-container {
            margin-top: 20px;
            display: grid;
            gap: 20px;
        }

        .modality-detail-card .card-body {
            padding: 24px;
        }

        .modality-card-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 18px;
        }

        .modality-card-icon {
            width: 48px;
            height: 48px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ffffff;
            font-size: 1.3rem;
            box-shadow: 0 10px 20px rgba(79, 70, 229, 0.15);
        }

        .modality-detail-card.embedded .modality-card-icon {
            background: linear-gradient(135deg, #2563eb, #3b82f6);
        }

        .modality-detail-card.coupled .modality-card-icon {
            background: linear-gradient(135deg, #f59e0b, #f97316);
        }

        .modality-detail-card.self-sustained .modality-card-icon {
            background: linear-gradient(135deg, #16a34a, #22c55e);
        }

        .modality-detail-card .modality-card-content {
            display: flex;
            flex-direction: column;
            gap: 18px;
        }

        .modality-detail-section {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 16px;
            padding: 16px 18px;
        }

        .modality-section-header {
            margin-bottom: 12px;
        }

        .section-pill {
            display: inline-block;
            background: #e0e7ff;
            color: #3730a3;
            font-weight: 600;
            padding: 4px 14px;
            border-radius: 999px;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.08em;
        }

        .modality-subsection {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 14px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 6px 18px rgba(15, 23, 42, 0.08);
        }

        .modality-subsection:last-child {
            margin-bottom: 0;
        }

        .modality-subsection-title {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 12px;
        }

        .modality-subsection-columns {
            display: grid;
            gap: 16px;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        }

        .label-pill {
            display: inline-block;
            font-size: 0.75rem;
            font-weight: 600;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            border-radius: 999px;
            padding: 3px 10px;
            margin-bottom: 8px;
        }

        .requirements-pill {
            background: rgba(59, 130, 246, 0.15);
            color: #1d4ed8;
        }

        .mitigation-pill {
            background: rgba(16, 185, 129, 0.15);
            color: #047857;
        }

        .modality-subsection ul {
            padding-left: 18px;
        }

        .modality-subsection ul li {
            margin-bottom: 6px;
        }

        .modality-subsection ul li:last-child {
            margin-bottom: 0;
        }

        .section-header {
            background-color: #f8f9ff;
            padding: 15px;
            border-bottom: 1px solid #e5e7eb;
            border-radius: 12px 12px 0 0;
        }

        .overview-card {
            text-align: center;
            padding: 20px;
            border-radius: 14px;
            margin-bottom: 20px;
            box-shadow: 0 10px 24px rgba(15, 23, 42, 0.12);
        }

        .overview-card .card-value {
            font-size: 2rem;
            font-weight: 700;
            margin: 10px 0;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
            color: white;
            padding: 15px 25px;
            border-radius: 12px;
            box-shadow: 0 12px 30px rgba(34, 197, 94, 0.3);
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        .btn-report {
            background: linear-gradient(135deg, #7c3aed, #6366f1);
            border: none;
            color: #ffffff;
            font-weight: 600;
            padding: 0.75rem 2.2rem;
            box-shadow: 0 18px 32px rgba(99, 102, 241, 0.25);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .btn-report:hover,
        .btn-report:focus {
            color: #ffffff;
            transform: translateY(-1px);
            box-shadow: 0 22px 38px rgba(99, 102, 241, 0.35);
        }

        .btn-report:disabled {
            opacity: 0.7;
            transform: none;
            box-shadow: none;
        }

        .pdf-report-root {
            position: fixed;
            top: -10000px;
            left: -10000px;
            width: 1024px;
            padding: 48px;
            background: #eef2ff;
            color: #1f2937;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            z-index: -1;
        }

        .pdf-report {
            background: #ffffff;
            border-radius: 28px;
            overflow: hidden;
            box-shadow: 0 24px 60px rgba(79, 70, 229, 0.18);
        }

        .pdf-header {
            background: linear-gradient(135deg, #5b21b6 0%, #4338ca 100%);
            color: #ffffff;
            text-align: center;
            padding: 48px 40px 40px;
        }

        .pdf-header h1 {
            margin-bottom: 0.35rem;
            font-weight: 700;
            letter-spacing: 0.04em;
        }

        .pdf-header .pdf-subtitle {
            font-size: 1.1rem;
            opacity: 0.85;
            margin-bottom: 0.25rem;
        }

        .pdf-header .pdf-date {
            font-size: 0.95rem;
            opacity: 0.75;
        }

        .pdf-body {
            padding: 40px;
            display: flex;
            flex-direction: column;
            gap: 32px;
        }

        .pdf-body section h3 {
            font-weight: 700;
            margin-bottom: 1.25rem;
            color: #312e81;
        }

        .pdf-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 18px;
        }

        .pdf-info-item {
            background: #f8f9ff;
            border-radius: 18px;
            padding: 18px;
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.7), 0 10px 28px rgba(79, 70, 229, 0.1);
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .pdf-info-label {
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.08em;
            color: #6366f1;
        }

        .pdf-info-value {
            font-size: 1.05rem;
            font-weight: 600;
            color: #1f2937;
        }

        .pdf-overview-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 18px;
            margin-bottom: 24px;
        }

        .pdf-summary-card {
            background: linear-gradient(135deg, rgba(129, 140, 248, 0.18), rgba(99, 102, 241, 0.12));
            border-radius: 20px;
            padding: 20px 24px;
            box-shadow: 0 18px 34px rgba(79, 70, 229, 0.14);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .pdf-summary-label {
            font-size: 0.85rem;
            letter-spacing: 0.06em;
            text-transform: uppercase;
            color: #4338ca;
        }

        .pdf-summary-value {
            font-size: 2.25rem;
            font-weight: 700;
            color: #1f1b4b;
        }

        .pdf-summary-table {
            width: 100%;
            border-collapse: collapse;
            background: #ffffff;
            border-radius: 18px;
            overflow: hidden;
            box-shadow: 0 16px 34px rgba(30, 64, 175, 0.12);
        }

        .pdf-summary-table th,
        .pdf-summary-table td {
            padding: 16px 18px;
            text-align: left;
        }

        .pdf-summary-table thead {
            background: #eef2ff;
            color: #3730a3;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-size: 0.85rem;
        }

        .pdf-summary-table tbody tr:nth-child(even) {
            background: #f8faff;
        }

        .pdf-summary-total td {
            font-weight: 700;
            background: #ede9fe;
        }

        .pdf-details {
            display: flex;
            flex-direction: column;
            gap: 28px;
        }

        .pdf-section-block {
            background: #f5f7ff;
            border-radius: 22px;
            padding: 26px;
            box-shadow: 0 16px 32px rgba(76, 29, 149, 0.12);
        }

        .pdf-section-block h3 {
            margin-bottom: 18px;
            color: #312e81;
        }

        .pdf-detail-card {
            background: #ffffff;
            border-radius: 18px;
            padding: 24px;
            box-shadow: 0 20px 40px rgba(79, 70, 229, 0.12);
            display: flex;
            flex-direction: column;
            gap: 18px;
            margin-bottom: 18px;
        }

        .pdf-detail-card:last-child {
            margin-bottom: 0;
        }

        .pdf-detail-card-header {
            display: flex;
            justify-content: space-between;
            gap: 18px;
            align-items: flex-start;
        }

        .pdf-detail-card-header h4 {
            margin: 0 0 6px;
            font-size: 1.1rem;
            color: #1f2937;
        }

        .pdf-detail-card-header p {
            margin: 0;
            color: #4b5563;
            line-height: 1.6;
        }

        .pdf-detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
        }

        .pdf-detail-grid h5 {
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.08em;
            color: #6366f1;
            margin-bottom: 8px;
        }

        .pdf-detail-grid p {
            margin: 0;
            color: #374151;
            line-height: 1.6;
        }

        .pdf-status-pill {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 999px;
            padding: 6px 16px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        .status-not-started {
            background: rgba(148, 163, 184, 0.28);
            color: #1f2937;
        }

        .status-initial {
            background: rgba(253, 230, 138, 0.35);
            color: #b45309;
        }

        .status-in-progress {
            background: rgba(96, 165, 250, 0.28);
            color: #1d4ed8;
        }

        .status-completed {
            background: rgba(134, 239, 172, 0.3);
            color: #047857;
        }

        .status-na {
            background: rgba(209, 213, 219, 0.35);
            color: #374151;
        }

        .pdf-empty {
            color: #9ca3af;
            font-style: italic;
        }

        .progress-sidebar-table {
            width: 100%;
            font-size: 0.85rem;
        }

        .progress-sidebar-table th,
        .progress-sidebar-table td {
            padding: 8px 5px;
            border-bottom: 1px solid #e5e7eb;
        }

        .progress-sidebar-table th {
            font-weight: 600;
        }

        .progress-sidebar-table tr:last-child td {
            border-bottom: none;
        }

        .compliance-section {
            margin-bottom: 32px;
        }

        .section-banner {
            background: linear-gradient(135deg, #6d5dfc 0%, #8f75ff 100%);
            color: white;
            padding: 24px;
            border-radius: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1.5rem;
            box-shadow: 0 16px 40px rgba(109, 93, 252, 0.3);
        }

        .section-progress {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .section-banner h2 {
            margin: 0;
            font-weight: 700;
            letter-spacing: 0.02em;
        }

        .section-banner p {
            margin: 0;
            opacity: 0.85;
            font-size: 1rem;
            letter-spacing: 0.03em;
        }

        .progress-pill {
            background: rgba(255, 255, 255, 0.22);
            padding: 0.6rem 1.75rem;
            border-radius: 999px;
            font-weight: 600;
            letter-spacing: 0.05em;
            text-transform: uppercase;
        }

        .subsection-list {
            display: grid;
            gap: 1.5rem;
            margin-top: 1.75rem;
        }

        .compliance-card {
            background: #ffffff;
            border-radius: 18px;
            border: 1px solid #e4e9ff;
            box-shadow: 0 12px 32px rgba(79, 70, 229, 0.12);
            overflow: hidden;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .compliance-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 18px 40px rgba(79, 70, 229, 0.18);
        }

        .compliance-card .card-header {
            background: linear-gradient(90deg, #eef2ff 0%, #f7f9ff 100%);
            padding: 1.1rem 1.5rem;
            border-bottom: 1px solid #dbe4ff;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .compliance-card .card-header:hover {
            background: linear-gradient(90deg, #e0e7ff 0%, #eef2ff 100%);
        }

        .compliance-card .card-header[aria-expanded="true"] {
            background: linear-gradient(90deg, #4f46e5 0%, #6366f1 100%);
        }

        .compliance-card .card-header[aria-expanded="true"] .subsection-title,
        .compliance-card .card-header[aria-expanded="true"] .collapse-icon {
            color: white !important;
        }

        .collapse-icon {
            transition: transform 0.2s ease;
            color: #4338ca;
        }

        .card-header[aria-expanded="true"] .collapse-icon {
            transform: rotate(180deg);
        }

        .score-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            display: inline-block;
            transition: all 0.2s ease;
        }

        .score-badge[data-score="0"],
        .score-badge[data-score=""] {
            background: #fee2e2;
            color: #991b1b;
        }

        .score-badge[data-score="1"] {
            background: #fed7aa;
            color: #9a3412;
        }

        .score-badge[data-score="2"] {
            background: #fef3c7;
            color: #92400e;
        }

        .score-badge[data-score="3"] {
            background: #d1fae5;
            color: #065f46;
        }

        .score-badge[data-score="NA"] {
            background: #e5e7eb;
            color: #374151;
        }

        /* Color code card headers based on score */
        .compliance-card[data-score="0"] .card-header:not([aria-expanded="true"]),
        .compliance-card[data-score=""] .card-header:not([aria-expanded="true"]) {
            background: linear-gradient(90deg, #fee2e2 0%, #fecaca 100%);
            border-bottom-color: #fca5a5;
        }

        .compliance-card[data-score="1"] .card-header:not([aria-expanded="true"]) {
            background: linear-gradient(90deg, #fed7aa 0%, #fdba74 100%);
            border-bottom-color: #fb923c;
        }

        .compliance-card[data-score="2"] .card-header:not([aria-expanded="true"]) {
            background: linear-gradient(90deg, #fef3c7 0%, #fde68a 100%);
            border-bottom-color: #fcd34d;
        }

        .compliance-card[data-score="3"] .card-header:not([aria-expanded="true"]) {
            background: linear-gradient(90deg, #d1fae5 0%, #a7f3d0 100%);
            border-bottom-color: #6ee7b7;
        }

        .compliance-card[data-score="NA"] .card-header:not([aria-expanded="true"]) {
            background: linear-gradient(90deg, #f3f4f6 0%, #e5e7eb 100%);
            border-bottom-color: #d1d5db;
        }

        .subsection-title {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 600;
            color: #4338ca;
        }

        .compliance-card .card-body {
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
        }

        .card-description {
            color: #334155;
            line-height: 1.6;
        }

        .deployment-requirements-card {
            background: linear-gradient(145deg, rgba(219, 234, 254, 0.4), rgba(224, 231, 255, 0.8));
            border: 1px solid #bfdbfe;
            border-radius: 16px;
            padding: 1.2rem 1.35rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .deployment-requirements-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }

        .deployment-requirements-title {
            font-weight: 700;
            color: #1d4ed8;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1rem;
        }

        .deployment-requirements-title i {
            font-size: 1.1rem;
        }

        .deployment-requirements-body {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .modality-requirement-block {
            background: #ffffff;
            border-radius: 14px;
            border: 1px solid #e0e7ff;
            box-shadow: 0 12px 24px rgba(99, 102, 241, 0.12);
            padding: 1rem;
            transition: box-shadow 0.2s ease;
        }

        .modality-requirement-block:hover {
            box-shadow: 0 16px 32px rgba(59, 130, 246, 0.18);
        }

        .modality-requirement-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }

        .modality-badge {
            background: rgba(59, 130, 246, 0.18);
            color: #1d4ed8;
            border-radius: 999px;
            padding: 0.4rem 0.85rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.45rem;
        }

        .modality-requirement-block.embedded .modality-badge {
            background: rgba(37, 99, 235, 0.16);
            color: #1d4ed8;
        }

        .modality-requirement-block.coupled .modality-badge {
            background: rgba(245, 158, 11, 0.22);
            color: #92400e;
        }

        .modality-requirement-block.self-sustained .modality-badge {
            background: rgba(22, 163, 74, 0.18);
            color: #065f46;
        }

        .modality-requirement-columns {
            display: grid;
            gap: 1rem;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        }

        .modality-requirement-columns label {
            font-size: 0.78rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: #475569;
            margin-bottom: 0.35rem;
            display: block;
        }

        .deployment-textarea {
            border-radius: 12px;
            border: 1px solid #cbd5f5;
            background: #f8faff;
            min-height: 110px;
            resize: vertical;
            padding: 0.75rem;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .deployment-textarea:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 0.2rem rgba(59, 130, 246, 0.18);
            background: #ffffff;
        }

        .card-fields {
            display: grid;
            gap: 1rem;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        }

        .field-group label {
            font-size: 0.78rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: #64748b;
            margin-bottom: 0.35rem;
            display: block;
        }

        .field-group textarea {
            border-radius: 12px;
            border: 1px solid #d7def8;
            padding: 0.75rem;
            min-height: 96px;
            background-color: #f8faff;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .field-group textarea:focus {
            border-color: #7c3aed;
            box-shadow: 0 0 0 0.2rem rgba(124, 58, 237, 0.15);
        }

        .compliance-card .card-footer {
            padding: 1rem 1.5rem;
            background: #f8fafc;
            border-top: 1px solid #e2e8f0;
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            justify-content: space-between;
            align-items: center;
        }

        .score-select-wrapper label {
            font-weight: 600;
            color: #475569;
            margin-bottom: 0.35rem;
            display: block;
        }

        .compliance-score {
            max-width: 220px;
            border-radius: 999px;
            border: 1px solid #cbd5f5;
            padding: 0.55rem 1rem;
            font-weight: 600;
            color: #334155;
            background-color: #ffffff;
            transition: all 0.3s ease;
        }

        .compliance-score:focus {
            border-color: #7c3aed;
            box-shadow: 0 0 0 0.25rem rgba(124, 58, 237, 0.15);
        }

        .score-select.score-0 {
            background: #fee2e2;
            color: #991b1b;
            border-color: #fecaca;
        }

        .score-select.score-1 {
            background: #fef3c7;
            color: #92400e;
            border-color: #fde68a;
        }

        .score-select.score-2 {
            background: #dcfce7;
            color: #047857;
            border-color: #bbf7d0;
        }

        .score-select.score-3 {
            background: #dbeafe;
            color: #1d4ed8;
            border-color: #bfdbfe;
        }

        .comments-panel {
            margin-top: 2rem;
            background: #f8f9ff;
            border: 1px solid #dde3ff;
            border-radius: 18px;
            padding: 1.25rem;
        }

        .comments-panel textarea {
            min-height: 140px;
            border-radius: 12px;
            border: 1px solid #d7def8;
            background-color: #ffffff;
        }

        .summary-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .file-input {
            display: none;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
            }
        }

        @media (max-width: 1200px) {
            .progress-sidebar {
                display: none;
            }

            .main-content {
                max-height: none;
            }

            .deployment-summary-banner {
                align-items: flex-start;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                height: auto;
                position: relative;
            }

            .deployment-summary-banner {
                flex-direction: column;
                gap: 12px;
            }

            .deployment-summary-pill-group {
                width: 100%;
            }

            .section-banner {
                flex-direction: column;
                align-items: flex-start;
            }

            .modality-card-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .modality-card-icon {
                margin-bottom: 8px;
            }

            .modality-subsection-columns {
                grid-template-columns: 1fr;
            }

            .deployment-requirements-header {
                align-items: flex-start;
                gap: 0.5rem;
                flex-direction: column;
            }

            .modality-requirement-columns {
                grid-template-columns: 1fr;
            }

            .modality-requirement-block {
                padding: 0.85rem;
            }

            .compliance-score {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="app-container"><div class="row g-0">
        <div class="col-lg-2"><div class="sidebar"><h4 class="text-center mb-4" id="sidebarSctTitle">${escapeHTML(headingText)}</h4><ul class="nav flex-column">${sidebarLinks}</ul><div class="mt-4 p-3"><div class="progress-bar-container"><div class="progress-bar bg-success" id="overallProgressBar" style="width:0%"></div></div><p class="mb-1">Overall Completion</p><h5 class="text-center" id="overallProgressText">0%</h5></div></div></div>
        <div class="col-lg-8"><div class="main-content"><div class="author-credit">Author by: <a href="mailto:joduzu@gmail.com">Jorge Durand Zurdo</a></div>${deploymentSummaryBannerHTML}<div class="tab-content">${tabPanes}</div><div class="d-flex justify-content-between mt-4"><div><button class="btn btn-outline-secondary" id="btn-import-excel"><i class="fas fa-upload me-2"></i>Import Excel</button><button class="btn btn-outline-secondary" id="btn-export-json"><i class="fas fa-download me-2"></i>Export JSON</button><button class="btn btn-outline-warning btn-sm" id="btn-save-html" title="Save this tool with all your data as HTML"><i class="fas fa-file-code me-2"></i>Save as HTML</button><button class="btn btn-outline-danger btn-sm" id="btn-clear-data" title="Clear all saved data and reset to defaults"><i class="fas fa-trash me-2"></i>Clear Data</button></div><div><button class="btn btn-outline-primary me-2" id="btn-save"><i class="fas fa-save me-2"></i>Save Draft</button><button class="btn btn-outline-info me-2" id="btn-export-excel"><i class="fas fa-file-excel me-2"></i>Export to Excel</button><button class="btn btn-success" id="btn-submit"><i class="fas fa-check-circle me-2"></i>Submit Assessment</button></div></div><div class="text-end mt-3"><button class="btn btn-report" id="btn-generate-pdf"><i class="fas fa-file-pdf me-2"></i>Generate PDF Report</button></div></div></div>
        <div class="col-lg-2"><div class="progress-sidebar"><h5 class="mb-3">Progress Overview</h5><div class="progress-bar-container mb-3"><div class="progress-bar bg-success" id="sidebarProgressBar" style="width:0%"></div></div><p class="mb-1">Overall Completion</p><h5 class="text-center mb-4" id="sidebarProgressText">0%</h5><table class="progress-sidebar-table"><thead><tr><th>Section</th><th>Status</th><th>%</th></tr></thead><tbody id="progressSidebarBody"></tbody></table></div></div>
    </div></div>
    <input type="file" id="fileInput" class="file-input" accept=".xlsx, .xls">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"><\/script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"><\/script>
    <script>
    const SECTIONS_WITH_WEIGHT = ${JSON.stringify(weightsData)};
    const MODALITY_METADATA = ${modalityMetadataJSON};
    const DEFAULT_MODALITY_STATE = ${defaultModalityStateJSON};
    const SCORE_DESCRIPTORS = {
        '0': { label: 'Not Started', className: 'status-not-started' },
        '1': { label: 'Initial', className: 'status-initial' },
        '2': { label: 'In Progress', className: 'status-in-progress' },
        '3': { label: 'Completed', className: 'status-completed' },
        'NA': { label: 'Not Applicable', className: 'status-na' }
    };
    const DEFAULT_SCT_NAME = ${JSON.stringify(rawSctName)};
    const DEFAULT_SUMMARY_TITLE = 'HID SCT Tool';
    let assessmentData={teamInfo:{},scores:{},evidence:{},gaps:{},actions:{},comments:{},summary:{},deploymentRequirements:{}};
    function safeGetItem(key){
        try {
            if (typeof window !== 'undefined' && window.localStorage) {
                return window.localStorage.getItem(key);
            }
        } catch (error) {
            console.warn('Unable to read localStorage key', key, error);
        }
        return null;
    }
    function safeSetItem(key, value){
        try {
            if (typeof window !== 'undefined' && window.localStorage) {
                window.localStorage.setItem(key, value);
                return true;
            }
        } catch (error) {
            console.warn('Unable to write localStorage key', key, error);
        }
        return false;
    }
    function getFieldValue(id){
        const element = document.getElementById(id);
        return element ? element.value : '';
    }
    function setFieldValue(id, value){
        const element = document.getElementById(id);
        if (element){
            element.value = value;
        }
    }
    function deriveSctTitle(rawValue){
        const trimmed = (rawValue || '').toString().trim();
        if (!trimmed) {
            return DEFAULT_SUMMARY_TITLE;
        }
        return trimmed.toLowerCase().endsWith('sct tool') ? trimmed : trimmed + ' SCT Tool';
    }
    function renderDeploymentSummary(modalityState = DEFAULT_MODALITY_STATE){
        const pillsContainer = document.getElementById('deploymentSummaryPills');
        const titleEl = document.getElementById('deploymentSummaryTitle');
        const sidebarTitle = document.getElementById('sidebarSctTitle');
        const banner = document.getElementById('deploymentSummaryBanner');
        const state = { ...DEFAULT_MODALITY_STATE, ...(modalityState || {}) };
        const activeModalities = MODALITY_METADATA.filter(modality => state[modality.key]);
        if (pillsContainer) {
            pillsContainer.innerHTML = '';
            activeModalities.forEach(modality => {
                const pill = document.createElement('span');
                pill.className = 'deployment-summary-pill ' + (modality.accentClass || '');
                pill.innerHTML = '<i class="fas ' + (modality.icon || 'fa-clipboard') + '"></i> ' + modality.label;
                pillsContainer.appendChild(pill);
            });
        }
        const currentName = (getFieldValue('sctName') || '').trim();
        const storedSctName = assessmentData.teamInfo && typeof assessmentData.teamInfo.sctName === 'string'
            ? assessmentData.teamInfo.sctName
            : '';
        const fallbackTeamName = assessmentData.teamInfo && typeof assessmentData.teamInfo.teamName === 'string'
            ? assessmentData.teamInfo.teamName
            : '';
        const derivedTitle = deriveSctTitle(currentName || storedSctName || fallbackTeamName || DEFAULT_SCT_NAME || '');
        if (titleEl) {
            titleEl.textContent = derivedTitle;
        }
        if (sidebarTitle) {
            sidebarTitle.textContent = derivedTitle;
        }
        if (banner) {
            banner.classList.toggle('d-none', activeModalities.length === 0);
        }
    }
    function toggleModalityDetails(){
        MODALITY_METADATA.forEach(modality => {
            const checkbox = document.getElementById('modality-' + modality.key);
            const card = document.querySelector('.modality-detail-card[data-modality="' + modality.key + '"]');
            if (card) {
                card.classList.toggle('d-none', !(checkbox && checkbox.checked));
            }
            document.querySelectorAll('.modality-requirement-block[data-modality="' + modality.key + '"]').forEach(block => {
                block.classList.toggle('d-none', !(checkbox && checkbox.checked));
            });
        });
    }
    function initializeData(){
        const stored = safeGetItem("hidSCTAssessment");
        if (stored) {
            try {
                const parsed = JSON.parse(stored);
                assessmentData = {
                    teamInfo: parsed.teamInfo || {},
                    scores: parsed.scores || {},
                    evidence: parsed.evidence || {},
                    gaps: parsed.gaps || {},
                    actions: parsed.actions || {},
                    comments: parsed.comments || {},
                    summary: parsed.summary || {},
                    deploymentRequirements: parsed.deploymentRequirements || {}
                };
            } catch (error) {
                console.warn('Failed to parse saved assessment data', error);
                assessmentData = {teamInfo:{ sctName: DEFAULT_SCT_NAME || '', deploymentModalities: { ...DEFAULT_MODALITY_STATE } },scores:{},evidence:{},gaps:{},actions:{},comments:{},summary:{},deploymentRequirements:{}};
            }
        }

        assessmentData.teamInfo = assessmentData.teamInfo || {};
        if (assessmentData.teamInfo.sctName === undefined && DEFAULT_SCT_NAME) {
            assessmentData.teamInfo.sctName = DEFAULT_SCT_NAME;
        }
        if (!assessmentData.teamInfo.deploymentModalities) {
            assessmentData.teamInfo.deploymentModalities = { ...DEFAULT_MODALITY_STATE };
        }

        loadSavedData();
        updateProgress();
    }
    function loadSavedData(){
        assessmentData.teamInfo = assessmentData.teamInfo || {};
        if (assessmentData.teamInfo.sctName === undefined && DEFAULT_SCT_NAME) {
            assessmentData.teamInfo.sctName = DEFAULT_SCT_NAME;
        }
        const modalityState = { ...DEFAULT_MODALITY_STATE, ...(assessmentData.teamInfo.deploymentModalities || {}) };

        MODALITY_METADATA.forEach(modality => {
            const checkbox = document.getElementById('modality-' + modality.key);
            if (checkbox) {
                const isChecked = !!modalityState[modality.key];
                checkbox.checked = isChecked;
                const pill = checkbox.closest('.modality-pill');
                if (pill) {
                    pill.classList.toggle('selected', isChecked);
                }
            }
        });

        toggleModalityDetails();

        assessmentData.teamInfo.deploymentModalities = modalityState;
        assessmentData.deploymentRequirements = assessmentData.deploymentRequirements || {};

        Object.keys(assessmentData.teamInfo).forEach(field => {
            if (field === 'deploymentModalities') return;
            const input = document.getElementById(field);
            if (input) {
                input.value = assessmentData.teamInfo[field];
            }
        });

        document.querySelectorAll('.compliance-card').forEach(card => {
            const select = card.querySelector('.score-select');
            if (!select) return;
            const key = select.dataset.section + '-' + select.dataset.item;
            if (assessmentData.scores && assessmentData.scores[key] !== undefined && assessmentData.scores[key] !== null && assessmentData.scores[key] !== '') {
                select.value = assessmentData.scores[key];
            } else {
                select.value = '0';
            }
            updateScoreBadge(select);
            const evidenceField = card.querySelector('.evidence-input');
            const gapsField = card.querySelector('.gaps-input');
            const actionField = card.querySelector('.action-input');
            if (evidenceField) {
                evidenceField.value = (assessmentData.evidence && assessmentData.evidence[key]) || '';
            }
            if (gapsField) {
                gapsField.value = (assessmentData.gaps && assessmentData.gaps[key]) || '';
            }
            if (actionField) {
                actionField.value = (assessmentData.actions && assessmentData.actions[key]) || '';
            }
        });

        const deploymentData = assessmentData.deploymentRequirements || {};
        document.querySelectorAll('.modality-requirement-block').forEach(block => {
            const section = block.dataset.section;
            const item = block.dataset.item;
            const modality = block.dataset.modality;
            const stored = deploymentData[section] && deploymentData[section][item] && deploymentData[section][item][modality];
            block.querySelectorAll('textarea[data-field]').forEach(textarea => {
                const field = textarea.dataset.field;
                if (stored && Object.prototype.hasOwnProperty.call(stored, field)) {
                    textarea.value = stored[field];
                }
            });
        });

        if (assessmentData.comments) {
            Object.keys(assessmentData.comments).forEach(id => {
                setFieldValue(id, assessmentData.comments[id]);
            });
        }

        if (assessmentData.summary) {
            Object.keys(assessmentData.summary).forEach(id => {
                setFieldValue(id, assessmentData.summary[id]);
            });
        }
        renderDeploymentSummary(modalityState);
    }
    function saveProgress(arg){
        if (arg && typeof arg.preventDefault === 'function') {
            arg.preventDefault();
        }
        let shouldNotify = true;
        if (typeof arg === 'boolean') {
            shouldNotify = arg;
        } else if (arg && typeof arg === 'object' && !('type' in arg) && Object.prototype.hasOwnProperty.call(arg, 'showNotification')) {
            shouldNotify = arg.showNotification !== false;
        }
        const modalityState = { ...DEFAULT_MODALITY_STATE };
        MODALITY_METADATA.forEach(modality => {
            const checkbox = document.getElementById('modality-' + modality.key);
            if (checkbox) {
                modalityState[modality.key] = checkbox.checked;
                const pill = checkbox.closest('.modality-pill');
                if (pill) {
                    pill.classList.toggle('selected', checkbox.checked);
                }
            }
        });

        toggleModalityDetails();

        assessmentData.teamInfo = {
            sctName: getFieldValue('sctName'),
            teamName: getFieldValue('teamName'),
            region: getFieldValue('region'),
            country: getFieldValue('country'),
            mentorName: getFieldValue('mentorName'),
            hqName: getFieldValue('hqName'),
            hqEmail: getFieldValue('hqEmail'),
            hqPhone: getFieldValue('hqPhone'),
            hqPosition: getFieldValue('hqPosition'),
            opsName: getFieldValue('opsName'),
            opsEmail: getFieldValue('opsEmail'),
            opsPhone: getFieldValue('opsPhone'),
            opsPosition: getFieldValue('opsPosition'),
            deploymentModalities: modalityState
        };
        renderDeploymentSummary(modalityState);

        assessmentData.scores = {};
        assessmentData.evidence = {};
        assessmentData.gaps = {};
        assessmentData.actions = {};
        assessmentData.deploymentRequirements = {};

        document.querySelectorAll('.compliance-card').forEach(card => {
            const select = card.querySelector('.score-select');
            if (!select) return;
            const key = select.dataset.section + '-' + select.dataset.item;
            if (select.value) {
                assessmentData.scores[key] = select.value;
            }
            const evidenceField = card.querySelector('.evidence-input');
            const gapsField = card.querySelector('.gaps-input');
            const actionField = card.querySelector('.action-input');
            if (evidenceField) assessmentData.evidence[key] = evidenceField.value || '';
            if (gapsField) assessmentData.gaps[key] = gapsField.value || '';
            if (actionField) assessmentData.actions[key] = actionField.value || '';
        });

        document.querySelectorAll('.modality-requirement-block').forEach(block => {
            const section = block.dataset.section;
            const item = block.dataset.item;
            const modality = block.dataset.modality;
            if (!assessmentData.deploymentRequirements[section]) {
                assessmentData.deploymentRequirements[section] = {};
            }
            if (!assessmentData.deploymentRequirements[section][item]) {
                assessmentData.deploymentRequirements[section][item] = {};
            }
            const record = {};
            block.querySelectorAll('textarea[data-field]').forEach(textarea => {
                const field = textarea.dataset.field;
                record[field] = textarea.value || '';
            });
            assessmentData.deploymentRequirements[section][item][modality] = record;
        });

        assessmentData.comments = {};
        SECTIONS_WITH_WEIGHT.forEach(section => {
            const commentField = document.getElementById(section.section + 'Comments');
            if (commentField) {
                assessmentData.comments[section.section + 'Comments'] = commentField.value || '';
            }
        });

        assessmentData.summary = {
            strengths: getFieldValue('strengths'),
            criticalGaps: getFieldValue('criticalGaps'),
            immediateActions: getFieldValue('immediateActions'),
            shortTermActions: getFieldValue('shortTermActions'),
            mediumTermActions: getFieldValue('mediumTermActions'),
            technicalAssistance: getFieldValue('technicalAssistance'),
            trainingRequirements: getFieldValue('trainingRequirements'),
            resourceRequirements: getFieldValue('resourceRequirements'),
            nextSteps: getFieldValue('nextSteps'),
            completionDate: getFieldValue('completionDate'),
            reviewedBy: getFieldValue('reviewedBy'),
            mentorAssignment: getFieldValue('mentorAssignment')
        };

        safeSetItem('hidSCTAssessment', JSON.stringify(assessmentData));
        if (shouldNotify) {
            showNotification('Progress saved successfully!');
        }
        updateProgress();
        return assessmentData;
    }
    function showNotification(e){const t=document.createElement("div");t.className="notification",t.textContent=e,document.body.appendChild(t),setTimeout(()=>{t.style.animation="fadeOut .3s ease",setTimeout(()=>t.remove(),300)},3e3)}
    function escapeHtmlForPdf(text){
        if (text === null || text === undefined) {
            return '';
        }
        return text.toString().replace(/[&<>"']/g, function(match){
            switch (match) {
                case '&': return '&amp;';
                case '<': return '&lt;';
                case '>': return '&gt;';
                case '"': return '&quot;';
                case "'": return '&#39;';
                default: return match;
            }
        });
    }
    function formatPdfValue(value, fallback = 'Not provided'){
        const trimmed = (value || '').toString().trim();
        if (!trimmed) {
            return '<span class="pdf-empty">' + escapeHtmlForPdf(fallback) + '</span>';
        }
        return escapeHtmlForPdf(trimmed);
    }
    function formatPdfParagraph(value, fallback){
        const trimmed = (value || '').toString().trim();
        if (!trimmed) {
            return fallback ? '<span class="pdf-empty">' + escapeHtmlForPdf(fallback) + '</span>' : '';
        }
        return escapeHtmlForPdf(trimmed).replace(/\\n/g, '<br>');
    }
    function calculateSectionSnapshots(){
        const sectionScores = {};
        SECTIONS_WITH_WEIGHT.forEach(section => {
            sectionScores[section.section] = { name: section.name, weight: section.weight, total: 0, max: 0 };
        });
        Object.entries(assessmentData.scores || {}).forEach(([key, value]) => {
            const [sectionKey] = key.split('-');
            if (!sectionKey || !sectionScores[sectionKey]) {
                return;
            }
            if (value === '' || value === 'NA') {
                return;
            }
            const numeric = parseInt(value, 10);
            if (!Number.isNaN(numeric)) {
                sectionScores[sectionKey].total += numeric;
                sectionScores[sectionKey].max += 3;
            }
        });
        return SECTIONS_WITH_WEIGHT.map(section => {
            const entry = sectionScores[section.section] || { total: 0, max: 0, weight: section.weight, name: section.name };
            const percent = entry.max > 0 ? Math.round((entry.total / entry.max) * 100) : 0;
            let status = 'Not Started';
            let badgeClass = 'status-not-started';
            if (percent >= 100) {
                status = 'Completed';
                badgeClass = 'status-completed';
            } else if (percent > 0) {
                status = 'In Progress';
                badgeClass = 'status-in-progress';
            }
            return {
                key: section.section,
                name: section.name,
                weight: section.weight,
                percent,
                status,
                badgeClass,
                hasProgress: entry.max > 0
            };
        });
    }
    function collectSectionDetails(){
        const sectionDetails = {};
        document.querySelectorAll('.compliance-card').forEach(card => {
            const select = card.querySelector('.score-select');
            if (!select) return;
            const sectionKey = select.dataset.section;
            const itemId = select.dataset.item;
            if (!sectionKey || !itemId) return;
            const descriptor = SCORE_DESCRIPTORS[select.value] || SCORE_DESCRIPTORS['0'];
            const itemKey = sectionKey + '-' + itemId;
            if (!sectionDetails[sectionKey]) {
                sectionDetails[sectionKey] = [];
            }
            const titleElement = card.querySelector('.subsection-title');
            const descriptionElement = card.querySelector('.card-description');
            sectionDetails[sectionKey].push({
                title: titleElement ? titleElement.textContent.trim() : '',
                description: descriptionElement ? descriptionElement.innerText.trim() : '',
                statusLabel: descriptor.label,
                statusClass: descriptor.className,
                evidence: (assessmentData.evidence && assessmentData.evidence[itemKey]) || '',
                gaps: (assessmentData.gaps && assessmentData.gaps[itemKey]) || '',
                actions: (assessmentData.actions && assessmentData.actions[itemKey]) || ''
            });
        });
        return sectionDetails;
    }
    function updateScoreBadge(select){
        const value = select.value;
        select.className = 'form-select score-select compliance-score';
        if (value !== '' && value !== 'NA') {
            select.classList.add('score-' + value);
        }

        // Update the score badge in the card header
        const card = select.closest('.compliance-card');
        if (card) {
            const badge = card.querySelector('.score-badge');
            if (badge) {
                badge.dataset.score = value || '0';

                // Update badge text
                const scoreLabels = {
                    '': 'Not Started',
                    '0': 'Not Started',
                    '1': 'Initial',
                    '2': 'In Progress',
                    '3': 'Completed',
                    'NA': 'N/A'
                };
                badge.textContent = scoreLabels[value] || 'Not Started';
            }

            // Update card data attribute for CSS styling
            card.dataset.score = value || '0';
        }
    }
    function updateProgress(){
        const sectionScores = {};
        SECTIONS_WITH_WEIGHT.forEach(section => {
            sectionScores[section.section] = { score: 0, maxScore: 0, percent: 0 };
        });

        document.querySelectorAll('.score-select').forEach(select => {
            const sectionKey = select.dataset.section;
            if (!sectionKey || !sectionScores[sectionKey]) {
                return;
            }

            if (select.value !== '' && select.value !== 'NA') {
                const numeric = parseInt(select.value, 10);
                if (!Number.isNaN(numeric)) {
                    sectionScores[sectionKey].score += numeric;
                    sectionScores[sectionKey].maxScore += 3;
                }
            }
        });

        let weightedTotal = 0;
        let totalWeight = 0;
        let sectionsWithRecordedScores = 0;

        SECTIONS_WITH_WEIGHT.forEach(section => {
            const sectionData = sectionScores[section.section];
            if (!sectionData) {
                return;
            }

            if (sectionData.maxScore > 0) {
                sectionData.percent = Math.round((sectionData.score / sectionData.maxScore) * 100);
                sectionsWithRecordedScores += 1;
            }

            const banner = document.getElementById(section.section + 'Score');
            if (banner) {
                banner.textContent = sectionData.percent + '% Complete';
            }

            totalWeight += section.weight;
            weightedTotal += (section.weight * sectionData.percent) / 100;
        });

        const overallPercent = totalWeight > 0 ? Math.round((weightedTotal / totalWeight) * 100) : 0;

        const overallProgressBar = document.getElementById('overallProgressBar');
        if (overallProgressBar) {
            overallProgressBar.style.width = overallPercent + '%';
        }
        const overallProgressText = document.getElementById('overallProgressText');
        if (overallProgressText) {
            overallProgressText.textContent = overallPercent + '%';
        }
        const sidebarProgressBar = document.getElementById('sidebarProgressBar');
        if (sidebarProgressBar) {
            sidebarProgressBar.style.width = overallPercent + '%';
        }
        const sidebarProgressText = document.getElementById('sidebarProgressText');
        if (sidebarProgressText) {
            sidebarProgressText.textContent = overallPercent + '%';
        }

        const completedSectionsEl = document.getElementById('completedSections');
        if (completedSectionsEl) {
            completedSectionsEl.textContent = sectionsWithRecordedScores + '/' + SECTIONS_WITH_WEIGHT.length;
        }
        const overallScoreEl = document.getElementById('overallScore');
        if (overallScoreEl) {
            overallScoreEl.textContent = overallPercent + '%';
        }
        const lastUpdatedEl = document.getElementById('lastUpdated');
        if (lastUpdatedEl) {
            lastUpdatedEl.textContent = (new Date).toLocaleDateString();
        }

        const tableBody = document.getElementById('progressTableBody');
        const sidebarBody = document.getElementById('progressSidebarBody');
        if (tableBody) {
            tableBody.innerHTML = '';
        }
        if (sidebarBody) {
            sidebarBody.innerHTML = '';
        }

        let listedWeight = 0;
        let listedWeightedPercent = 0;

        SECTIONS_WITH_WEIGHT.forEach(section => {
            const sectionData = sectionScores[section.section];
            if (!sectionData) {
                return;
            }

            const percent = sectionData.percent || 0;
            const status = percent === 0 ? 'Not Started' : percent < 100 ? 'In Progress' : 'Completed';
            const badgeClass = status === 'Completed' ? 'bg-success' : status === 'In Progress' ? 'bg-warning' : 'bg-secondary';

            listedWeight += section.weight;
            listedWeightedPercent += (section.weight * percent) / 100;

            if (tableBody) {
                tableBody.insertAdjacentHTML(
                    'beforeend',
                    '<tr><td>' + section.name + '</td><td>' + section.weight + '%</td><td><span class="badge ' + badgeClass + '">' + status + '</span></td><td>' + percent + '%</td></tr>'
                );
            }

            if (sidebarBody) {
                const shortName = section.name.split(' ')[0];
                sidebarBody.insertAdjacentHTML(
                    'beforeend',
                    '<tr><td>' + shortName + '</td><td><span class="badge ' + badgeClass + '">' + status + '</span></td><td>' + percent + '%</td></tr>'
                );
            }
        });

        if (tableBody) {
            const totalPercent = listedWeight > 0 ? Math.round((listedWeightedPercent / listedWeight) * 100) : 0;
            tableBody.insertAdjacentHTML(
                'beforeend',
                '<tr class="table-primary fw-bold"><td>TOTAL</td><td>' + listedWeight + '%</td><td></td><td>' + totalPercent + '%</td></tr>'
            );
        }
    }
 async function generatePdfReport(){
    const data = saveProgress(false);
    if (!window.jspdf || !window.jspdf.jsPDF) {
        throw new Error('Missing PDF dependencies');
    }
    
    const snapshots = calculateSectionSnapshots();
    const sectionDetails = collectSectionDetails();
    const totalWeight = snapshots.reduce((sum, section) => sum + section.weight, 0);
    const weightedProgress = snapshots.reduce((sum, section) => sum + (section.percent * section.weight / 100), 0);
    const overallPercent = totalWeight > 0 ? Math.round((weightedProgress / totalWeight) * 100) : 0;
    const sectionsWithProgress = snapshots.filter(section => section.hasProgress).length;
    const generatedDate = new Date();
    const formattedDate = generatedDate.toLocaleDateString(undefined, { year: 'numeric', month: 'long', day: 'numeric' });
    const teamInfo = data && data.teamInfo ? data.teamInfo : {};

    const pdf = new window.jspdf.jsPDF('p', 'mm', 'a4');
    const pageWidth = pdf.internal.pageSize.getWidth();
    const pageHeight = pdf.internal.pageSize.getHeight();
    const margin = 20;
    const contentWidth = pageWidth - (margin * 2);
    let yPos = margin;

    // Funci√≥n auxiliar para agregar nueva p√°gina
    const checkAddPage = (neededHeight) => {
        if (yPos + neededHeight > pageHeight - margin) {
            pdf.addPage();
            yPos = margin;
            return true;
        }
        return false;
    };

    // Funci√≥n para texto con wrap
    const addWrappedText = (text, x, y, maxWidth, lineHeight = 6) => {
        const lines = pdf.splitTextToSize(text, maxWidth);
        lines.forEach((line, index) => {
            if (y + (index * lineHeight) > pageHeight - margin) {
                pdf.addPage();
                y = margin;
            }
            pdf.text(line, x, y + (index * lineHeight));
        });
        return y + (lines.length * lineHeight);
    };

    // PORTADA
    pdf.setFillColor(91, 33, 182);
    pdf.rect(0, 0, pageWidth, 80, 'F');
    
    pdf.setTextColor(255, 255, 255);
    pdf.setFontSize(28);
    pdf.setFont('helvetica', 'bold');
    pdf.text('SCT Report', pageWidth / 2, 35, { align: 'center' });
    
    pdf.setFontSize(14);
    pdf.setFont('helvetica', 'normal');
    pdf.text('Minimum Standards Assessment', pageWidth / 2, 50, { align: 'center' });
    pdf.text('Generated on ' + formattedDate, pageWidth / 2, 65, { align: 'center' });

    yPos = 100;

    // INFORMACI√ìN DEL EQUIPO
    pdf.setTextColor(49, 46, 129);
    pdf.setFontSize(16);
    pdf.setFont('helvetica', 'bold');
    pdf.text('Team Information', margin, yPos);
    yPos += 10;

    const teamInfoItems = [
        ['Team Name', teamInfo.teamName || 'Not provided'],
        ['Region', teamInfo.region || 'Not provided'],
        ['Country', teamInfo.country || 'Not provided'],
        ['Mentor', teamInfo.mentorName || 'Not provided']
    ];

    pdf.setFontSize(10);
    teamInfoItems.forEach(([label, value]) => {
        checkAddPage(20);
        pdf.setFillColor(248, 249, 255);
        pdf.roundedRect(margin, yPos, contentWidth, 15, 3, 3, 'F');
        
        pdf.setTextColor(99, 102, 241);
        pdf.setFont('helvetica', 'bold');
        pdf.text(label.toUpperCase(), margin + 5, yPos + 5);
        
        pdf.setTextColor(31, 41, 55);
        pdf.setFont('helvetica', 'normal');
        pdf.text(value, margin + 5, yPos + 11);
        
        yPos += 18;
    });

    yPos += 10;
    checkAddPage(40);

    // RESUMEN GENERAL
    pdf.setTextColor(49, 46, 129);
    pdf.setFontSize(16);
    pdf.setFont('helvetica', 'bold');
    pdf.text('Overall Progress Summary', margin, yPos);
    yPos += 10;

    // Tarjetas de resumen
    const cardWidth = (contentWidth - 10) / 2;
    
    pdf.setFillColor(129, 140, 248, 0.2 * 255);
    pdf.roundedRect(margin, yPos, cardWidth, 25, 3, 3, 'F');
    pdf.setFontSize(9);
    pdf.setTextColor(67, 56, 202);
    pdf.setFont('helvetica', 'bold');
    pdf.text('OVERALL PROGRESS', margin + 5, yPos + 8);
    pdf.setFontSize(24);
    pdf.setTextColor(31, 27, 75);
    pdf.text(overallPercent + '%', margin + 5, yPos + 20);

    pdf.setFillColor(129, 140, 248, 0.2 * 255);
    pdf.roundedRect(margin + cardWidth + 10, yPos, cardWidth, 25, 3, 3, 'F');
    pdf.setFontSize(9);
    pdf.setTextColor(67, 56, 202);
    pdf.setFont('helvetica', 'bold');
    pdf.text('SECTIONS COMPLETED', margin + cardWidth + 15, yPos + 8);
    pdf.setFontSize(24);
    pdf.setTextColor(31, 27, 75);
    pdf.text(sectionsWithProgress + '/' + snapshots.length, margin + cardWidth + 15, yPos + 20);

    yPos += 35;
    checkAddPage(60);

    // TABLA DE SECCIONES
    pdf.setFontSize(12);
    pdf.setTextColor(49, 46, 129);
    pdf.setFont('helvetica', 'bold');
    pdf.text('Section Progress Details', margin, yPos);
    yPos += 8;

    // Encabezado de tabla
    pdf.setFillColor(238, 242, 255);
    pdf.rect(margin, yPos, contentWidth, 8, 'F');
    pdf.setFontSize(9);
    pdf.setTextColor(55, 48, 163);
    pdf.setFont('helvetica', 'bold');
    
    const colWidths = [contentWidth * 0.45, contentWidth * 0.15, contentWidth * 0.20, contentWidth * 0.20];
    const headers = ['SECTION', 'WEIGHT', 'STATUS', 'PROGRESS'];
    let xOffset = margin;
    headers.forEach((header, i) => {
        pdf.text(header, xOffset + 2, yPos + 5.5);
        xOffset += colWidths[i];
    });
    yPos += 8;

    // Filas de datos
    pdf.setFont('helvetica', 'normal');
    pdf.setTextColor(31, 41, 55);
    pdf.setFontSize(9);

    snapshots.forEach((section, index) => {
        checkAddPage(8);
        
        if (index % 2 === 0) {
            pdf.setFillColor(248, 250, 255);
            pdf.rect(margin, yPos, contentWidth, 8, 'F');
        }

        xOffset = margin;
        
        // Nombre de la secci√≥n
        const sectionName = section.name.length > 30 ? section.name.substring(0, 27) + '...' : section.name;
        pdf.text(sectionName, xOffset + 2, yPos + 5.5);
        xOffset += colWidths[0];

        // Weight
        pdf.text(section.weight + '%', xOffset + 2, yPos + 5.5);
        xOffset += colWidths[1];

        // Status badge
        let badgeColor;
        if (section.status === 'Completed') badgeColor = [134, 239, 172];
        else if (section.status === 'In Progress') badgeColor = [96, 165, 250];
        else badgeColor = [148, 163, 184];
        
        pdf.setFillColor(badgeColor[0], badgeColor[1], badgeColor[2], 0.3 * 255);
        pdf.roundedRect(xOffset + 2, yPos + 1, 25, 6, 2, 2, 'F');
        pdf.setFontSize(7);
        pdf.text(section.status.toUpperCase(), xOffset + 4, yPos + 5);
        pdf.setFontSize(9);
        xOffset += colWidths[2];

        // Progress
        pdf.text(section.percent + '%', xOffset + 2, yPos + 5.5);

        yPos += 8;
    });

    // Fila total
    pdf.setFillColor(237, 233, 254);
    pdf.rect(margin, yPos, contentWidth, 8, 'F');
    pdf.setFont('helvetica', 'bold');
    xOffset = margin;
    pdf.text('TOTAL', xOffset + 2, yPos + 5.5);
    xOffset += colWidths[0];
    pdf.text(totalWeight + '%', xOffset + 2, yPos + 5.5);
    xOffset += colWidths[1] + colWidths[2];
    pdf.text(overallPercent + '%', xOffset + 2, yPos + 5.5);
    yPos += 15;

    // DETALLES DE EVALUACI√ìN
    pdf.addPage();
    yPos = margin;
    
    pdf.setFontSize(16);
    pdf.setTextColor(49, 46, 129);
    pdf.setFont('helvetica', 'bold');
    pdf.text('Detailed Assessment Results', margin, yPos);
    yPos += 12;

    snapshots.forEach(section => {
        const cards = sectionDetails[section.key] || [];
        if (cards.length === 0) return;

        checkAddPage(30);

        // Secci√≥n header
        pdf.setFillColor(245, 247, 255);
        pdf.roundedRect(margin, yPos, contentWidth, 12, 3, 3, 'F');
        pdf.setFontSize(13);
        pdf.setTextColor(49, 46, 129);
        pdf.setFont('helvetica', 'bold');
        pdf.text(section.name, margin + 5, yPos + 8);
        yPos += 17;

        // Cards de cada est√°ndar
        cards.forEach(card => {
            const estimatedHeight = 60;
            checkAddPage(estimatedHeight);

            // Card background
            pdf.setFillColor(255, 255, 255);
            pdf.setDrawColor(226, 232, 240);
            pdf.setLineWidth(0.5);
            const cardStartY = yPos;
            
            // T√≠tulo y status
            pdf.setFontSize(11);
            pdf.setTextColor(31, 41, 55);
            pdf.setFont('helvetica', 'bold');
            const titleLines = pdf.splitTextToSize(card.title || 'Untitled Standard', contentWidth - 40);
            titleLines.forEach((line, i) => {
                pdf.text(line, margin + 5, yPos + 6 + (i * 5));
            });
            
            // Status badge
            let statusColor;
            if (card.statusLabel === 'Completed') statusColor = [134, 239, 172];
            else if (card.statusLabel === 'In Progress') statusColor = [96, 165, 250];
            else if (card.statusLabel === 'Initial') statusColor = [253, 230, 138];
            else statusColor = [148, 163, 184];
            
            pdf.setFillColor(statusColor[0], statusColor[1], statusColor[2], 0.3 * 255);
            pdf.roundedRect(pageWidth - margin - 35, yPos + 2, 30, 6, 2, 2, 'F');
            pdf.setFontSize(7);
            pdf.setFont('helvetica', 'bold');
            pdf.text(card.statusLabel.toUpperCase(), pageWidth - margin - 33, yPos + 5.5);

            yPos += (titleLines.length * 5) + 8;

            // Description
            if (card.description) {
                pdf.setFontSize(9);
                pdf.setTextColor(75, 85, 99);
                pdf.setFont('helvetica', 'normal');
                yPos = addWrappedText(card.description, margin + 5, yPos, contentWidth - 10, 5);
                yPos += 3;
            }

            // Evidence, Gaps, Actions
            const fields = [
                { label: 'EVIDENCE', text: card.evidence || 'No evidence provided', color: [59, 130, 246] },
                { label: 'GAPS', text: card.gaps || 'No gaps identified', color: [245, 158, 11] },
                { label: 'ACTIONS', text: card.actions || 'No actions planned', color: [16, 185, 129] }
            ];

            fields.forEach(field => {
                checkAddPage(15);
                pdf.setFontSize(8);
                pdf.setTextColor(field.color[0], field.color[1], field.color[2]);
                pdf.setFont('helvetica', 'bold');
                pdf.text(field.label, margin + 5, yPos + 4);
                yPos += 6;

                pdf.setFontSize(9);
                pdf.setTextColor(55, 65, 81);
                pdf.setFont('helvetica', 'normal');
                yPos = addWrappedText(field.text, margin + 5, yPos, contentWidth - 10, 4.5);
                yPos += 2;
            });

            // Draw card border
            pdf.roundedRect(margin, cardStartY, contentWidth, yPos - cardStartY, 3, 3, 'S');
            yPos += 8;
        });

        yPos += 5;
    });

    // Guardar PDF
    const dateSuffix = generatedDate.toISOString().split('T')[0];
    pdf.save('HID_SCT_Assessment_Report_' + dateSuffix + '.pdf');
    showNotification('Professional PDF report generated successfully!');
}
    function exportToExcel(){
        saveProgress();
        const workbook = XLSX.utils.book_new();
        const teamInfo = [
            ['Team Information', ''],
            ['Team Name', assessmentData.teamInfo.teamName || ''],
            ['Region', assessmentData.teamInfo.region || ''],
            ['Country', assessmentData.teamInfo.country || ''],
            ['Mentor Name', assessmentData.teamInfo.mentorName || ''],
            [''],
            ['Headquarters Contact', ''],
            ['Name', assessmentData.teamInfo.hqName || ''],
            ['Email', assessmentData.teamInfo.hqEmail || ''],
            ['Phone', assessmentData.teamInfo.hqPhone || ''],
            ['Position', assessmentData.teamInfo.hqPosition || ''],
            [''],
            ['Operations Contact', ''],
            ['Name', assessmentData.teamInfo.opsName || ''],
            ['Email', assessmentData.teamInfo.opsEmail || ''],
            ['Phone', assessmentData.teamInfo.opsPhone || ''],
            ['Position', assessmentData.teamInfo.opsPosition || '']
        ];
        teamInfo.push(['']);
        teamInfo.push(['Supported Deployment Modalities', '']);
        MODALITY_METADATA.forEach(modality => {
            const supported = assessmentData.teamInfo.deploymentModalities && assessmentData.teamInfo.deploymentModalities[modality.key];
            teamInfo.push([modality.label, supported ? 'Yes' : 'No']);
        });
        const teamSheet = XLSX.utils.aoa_to_sheet(teamInfo);
        XLSX.utils.book_append_sheet(workbook, teamSheet, 'Team Info');

        const assessmentRows = [['Standard ID', 'Pillar', 'Standard Statement', 'Score', 'Evidence', 'Gaps', 'Actions', 'Comments', 'Deployment Requirements', 'Deployment Mitigations']];
        document.querySelectorAll('.compliance-card').forEach(card => {
            const select = card.querySelector('.score-select');
            if (!select) return;
            const sectionKey = select.dataset.section;
            const itemId = select.dataset.item;
            const itemKey = sectionKey + '-' + itemId;
            const titleElement = card.querySelector('.subsection-title');
            const descElement = card.querySelector('.card-description');
            const title = titleElement ? titleElement.textContent.trim() : '';
            const description = descElement ? descElement.textContent.trim() : '';
            const statement = description ? title + ' ‚Äî ' + description : title;
            const evidenceField = card.querySelector('.evidence-input');
            const gapsField = card.querySelector('.gaps-input');
            const actionField = card.querySelector('.action-input');
            const evidence = evidenceField ? evidenceField.value : '';
            const gaps = gapsField ? gapsField.value : '';
            const actions = actionField ? actionField.value : '';
            let deploymentRequirementsText = '';
            let deploymentMitigationsText = '';
            const deploymentRecord = assessmentData.deploymentRequirements &&
                assessmentData.deploymentRequirements[sectionKey] &&
                assessmentData.deploymentRequirements[sectionKey][itemId];
            if (deploymentRecord) {
                const requirementParts = [];
                const mitigationParts = [];
                Object.keys(deploymentRecord).forEach(modalityKey => {
                    const entry = deploymentRecord[modalityKey] || {};
                    const meta = MODALITY_METADATA.find(modality => modality.key === modalityKey);
                    const label = meta ? meta.label : modalityKey;
                    if (entry.requirements && entry.requirements.trim() !== '') {
                        requirementParts.push(label + ': ' + entry.requirements.trim());
                    }
                    if (entry.mitigation && entry.mitigation.trim() !== '') {
                        mitigationParts.push(label + ': ' + entry.mitigation.trim());
                    }
                });
                deploymentRequirementsText = requirementParts.join('\\n\\n');
                deploymentMitigationsText = mitigationParts.join('\\n\\n');
            }
            assessmentRows.push([
                itemKey,
                sectionKey,
                statement,
                select.value || '',
                evidence,
                gaps,
                actions,
                (assessmentData.comments && assessmentData.comments[sectionKey + 'Comments']) || '',
                deploymentRequirementsText,
                deploymentMitigationsText
            ]);
        });

        const assessmentSheet = XLSX.utils.aoa_to_sheet(assessmentRows);
        XLSX.utils.book_append_sheet(workbook, assessmentSheet, 'HID SCT Assessment');
        const dateSuffix = (new Date).toISOString().split('T')[0];
        XLSX.writeFile(workbook, 'HID_SCT_Assessment_' + dateSuffix + '.xlsx');
        showNotification('Data exported to Excel successfully!');
    }
    function importFromExcel(event){
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(loadEvent){
            try {
                const workbook = XLSX.read(loadEvent.target.result, { type: "binary" });
                assessmentData = {
                    teamInfo: { sctName: DEFAULT_SCT_NAME || '', deploymentModalities: { ...DEFAULT_MODALITY_STATE } },
                    scores: {},
                    evidence: {},
                    gaps: {},
                    actions: {},
                    comments: {},
                    summary: {},
                    deploymentRequirements: {}
                };

                const sheet = workbook.Sheets["HID SCT Assessment"];
                if (sheet) {
                    const rows = XLSX.utils.sheet_to_json(sheet);
                    for (const row of rows) {
                        const id = row["Standard ID"];
                        if (!id) continue;
                        assessmentData.scores[id] = row.Score;
                        assessmentData.evidence[id] = row.Evidence;
                        assessmentData.gaps[id] = row.Gaps;
                        assessmentData.actions[id] = row.Actions;
                    }
                }

                safeSetItem("hidSCTAssessment", JSON.stringify(assessmentData));
                loadSavedData();
                updateProgress();
                showNotification("Data imported successfully!");
            } catch (error) {
                console.warn('Error importing file', error);
                showNotification("Error importing file.");
            }
        };
        reader.readAsBinaryString(file);
    }
    document.addEventListener("DOMContentLoaded", function () {
        initializeData();

        ['sctName', 'teamName'].forEach(fieldId => {
            const input = document.getElementById(fieldId);
            if (input) {
                input.addEventListener('input', () => {
                    const currentState = { ...DEFAULT_MODALITY_STATE };
                    MODALITY_METADATA.forEach(modality => {
                        const checkbox = document.getElementById('modality-' + modality.key);
                        if (checkbox) {
                            currentState[modality.key] = checkbox.checked;
                        }
                    });
                    renderDeploymentSummary(currentState);
                });
            }
        });

        document.querySelectorAll("input, textarea, select").forEach(element => {
            element.addEventListener("change", saveProgress);
        });

        document.querySelectorAll('.score-select').forEach(select => {
            updateScoreBadge(select);
            select.addEventListener('change', function () {
                updateScoreBadge(select);
            });
        });

        document.getElementById("btn-save").addEventListener("click", saveProgress);
        document.getElementById("btn-export-json").addEventListener("click", () => {
            saveProgress();
            const json = JSON.stringify(assessmentData, null, 2);
            const blob = new Blob([json], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url;
            link.download = "HID_SCT_Assessment_" + (new Date).toISOString().split("T")[0] + ".json";
            link.click();
            URL.revokeObjectURL(url);
        });

        document.getElementById("btn-export-excel").addEventListener("click", exportToExcel);
        document.getElementById("btn-submit").addEventListener("click", () => {
            saveProgress();
            showNotification("Assessment submitted successfully!");
        });

        const pdfButton = document.getElementById("btn-generate-pdf");
        if (pdfButton) {
            const originalHtml = pdfButton.innerHTML;
            pdfButton.addEventListener("click", async () => {
                if (pdfButton.disabled) {
                    return;
                }
                pdfButton.disabled = true;
                pdfButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Generating PDF...';
                try {
                    await generatePdfReport();
                } catch (error) {
                    console.warn('Failed to generate PDF report', error);
                    showNotification('Unable to generate PDF report. Please try again.');
                } finally {
                    pdfButton.disabled = false;
                    pdfButton.innerHTML = originalHtml;
                }
            });
        }

        document.getElementById("btn-import-excel").addEventListener("click", () => {
            document.getElementById("fileInput").click();
        });

        document.getElementById("fileInput").addEventListener("change", importFromExcel);

        document.getElementById("btn-clear-data").addEventListener("click", () => {
            if (confirm('Are you sure you want to clear all saved data? This will reset the tool to its initial state with default values.')) {
                try {
                    localStorage.removeItem('hidSCTAssessment');
                    showNotification('All data cleared successfully. Page will reload.', 'success');
                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                } catch (error) {
                    console.error('Error clearing data:', error);
                    showNotification('Error clearing data: ' + error.message, 'error');
                }
            }
        });

        document.getElementById("btn-save-html").addEventListener("click", () => {
            try {
                // Save current progress first
                saveProgress();

                // Get the current HTML
                const currentHTML = document.documentElement.outerHTML;

                // Create a blob and download
                const blob = new Blob(['<!DOCTYPE html>\\n' + currentHTML], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.href = url;
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').split('T')[0];
                const sctName = assessmentData.teamInfo?.sctName || 'assessment';
                const fileName = \`\${sctName.replace(/[^a-z0-9]/gi, '-')}-tool-\${timestamp}.html\`;
                link.download = fileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);

                showNotification('Tool saved as HTML successfully!', 'success');
            } catch (error) {
                console.error('Error saving HTML:', error);
                showNotification('Error saving HTML: ' + error.message, 'error');
            }
        });

        const navLinks = document.querySelectorAll('.nav-link[data-bs-toggle="tab"]');
        navLinks.forEach(link => {
            link.addEventListener("click", function (event) {
                event.preventDefault();
                navLinks.forEach(item => item.classList.remove("active"));
                link.classList.add("active");
                const target = link.getAttribute("href");
                document.querySelectorAll(".tab-pane").forEach(pane => pane.classList.remove("show", "active"));
                document.querySelector(target).classList.add("show", "active");
            });
        });
    });
    <\/script>
</body>
</html>
`;
        const blob = new Blob([fullHTML], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'custom-assessment-tool.html';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    // ===== SAVE/LOAD MAKER STATE =====

    function saveMakerState() {
        try {
            // Capture current state
            const makerState = {
                toolConfig: TOOL_CONFIG,
                sectionContent: SECTION_CONTENT,
                deploymentOverrides: builderDeploymentOverrides,
                selectedModalities: Array.from(document.querySelectorAll('.deployment-modality-checkbox:checked')).map(cb => cb.dataset.key),
                sctName: document.getElementById('sctName')?.value || '',
                timestamp: new Date().toISOString()
            };

            // Capture all subsection content from the DOM
            Object.keys(TOOL_CONFIG).forEach(sectionKey => {
                const config = TOOL_CONFIG[sectionKey];
                if (config.hasSubsections) {
                    const container = document.getElementById(`subsections-${sectionKey}`);
                    if (container) {
                        const items = Array.from(container.querySelectorAll('.subsection-item'));
                        config.subsections = items.map(item => {
                            const editor = item.querySelector('.editor-content');
                            const titleInput = item.querySelector('.standard-title-input');
                            const itemKey = item.dataset.itemKey;
                            const titleText = titleInput?.value || item.dataset.title || '';
                            const content = editor?.innerHTML || '';

                            return {
                                content,
                                itemKey,
                                titleText
                            };
                        });
                    }
                } else if (config.editableContent) {
                    const editor = document.querySelector(`#accordion-item-${sectionKey} .section-content-editor .editor-content`);
                    if (editor) {
                        SECTION_CONTENT[sectionKey] = editor.innerHTML;
                    }
                }
            });

            // Get the current page HTML
            const currentHTML = document.documentElement.outerHTML;

            // Create a parser to modify the HTML
            const parser = new DOMParser();
            const doc = parser.parseFromString(currentHTML, 'text/html');

            // Inject the state as a script in the saved HTML
            const stateScript = doc.createElement('script');
            stateScript.type = 'application/json';
            stateScript.id = 'maker-saved-state';
            stateScript.textContent = JSON.stringify(makerState, null, 2);
            doc.head.appendChild(stateScript);

            // Serialize back to HTML
            const serializer = new XMLSerializer();
            const savedHTML = '<!DOCTYPE html>\n' + serializer.serializeToString(doc.documentElement);

            // Download the file
            const blob = new Blob([savedHTML], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
            a.download = `sct-maker-state-${timestamp}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showToast('Maker state saved successfully!', 'success');
        } catch (error) {
            console.error('Error saving maker state:', error);
            alert('Error saving maker state: ' + error.message);
        }
    }

    function loadMakerState(file) {
        const reader = new FileReader();

        reader.onload = function(e) {
            try {
                const html = e.target.result;
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');

                // Extract the saved state
                const stateScript = doc.getElementById('maker-saved-state');
                if (!stateScript) {
                    alert('This file does not contain saved maker state.');
                    return;
                }

                const makerState = JSON.parse(stateScript.textContent);

                // Restore TOOL_CONFIG
                Object.keys(TOOL_CONFIG).forEach(key => delete TOOL_CONFIG[key]);
                Object.assign(TOOL_CONFIG, makerState.toolConfig);

                // Restore SECTION_CONTENT
                Object.keys(SECTION_CONTENT).forEach(key => delete SECTION_CONTENT[key]);
                Object.assign(SECTION_CONTENT, makerState.sectionContent);

                // Restore deployment overrides
                Object.keys(builderDeploymentOverrides).forEach(key => delete builderDeploymentOverrides[key]);
                Object.assign(builderDeploymentOverrides, makerState.deploymentOverrides || {});

                // Restore SCT name
                const sctNameInput = document.getElementById('sctName');
                if (sctNameInput && makerState.sctName) {
                    sctNameInput.value = makerState.sctName;
                }

                // Restore selected modalities
                document.querySelectorAll('.deployment-modality-checkbox').forEach(cb => {
                    cb.checked = makerState.selectedModalities?.includes(cb.dataset.key) || false;
                });

                // Re-render the maker UI
                renderMakerUI();
                renderSectionManagementList();

                showToast(`Maker state loaded successfully! (Saved: ${new Date(makerState.timestamp).toLocaleString()})`, 'success');
            } catch (error) {
                console.error('Error loading maker state:', error);
                alert('Error loading maker state: ' + error.message);
            }
        };

        reader.readAsText(file);
    }

    // ===== ENHANCED FEATURES =====

    // Utility Functions
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    function throttle(func, limit) {
        let inThrottle;
        return function(...args) {
            if (!inThrottle) {
                func.apply(this, args);
                inThrottle = true;
                setTimeout(() => inThrottle = false, limit);
            }
        };
    }

    // Toast Notification System
    function showToast(message, type = 'info', duration = 3000) {
        const container = document.getElementById('toast-container');
        if (!container) return;

        const icons = {
            success: 'fa-check-circle',
            error: 'fa-exclamation-circle',
            info: 'fa-info-circle',
            warning: 'fa-exclamation-triangle'
        };

        const toast = document.createElement('div');
        toast.className = `toast-notification ${type}`;
        toast.innerHTML = `
            <i class="fas ${icons[type]} toast-icon"></i>
            <div class="toast-content">${message}</div>
            <button class="toast-close" aria-label="Close">
                <i class="fas fa-times"></i>
            </button>
        `;

        container.appendChild(toast);

        const closeBtn = toast.querySelector('.toast-close');
        closeBtn.addEventListener('click', () => {
            toast.remove();
        });

        if (duration > 0) {
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }
    }

    // Dark Mode Toggle
    function initDarkMode() {
        const darkModeBtn = document.getElementById('btn-dark-mode');
        if (!darkModeBtn) return;

        const savedTheme = localStorage.getItem('sct-theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);
        updateDarkModeIcon(savedTheme);

        darkModeBtn.addEventListener('click', () => {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('sct-theme', newTheme);
            updateDarkModeIcon(newTheme);
            showToast(`${newTheme === 'dark' ? 'Dark' : 'Light'} mode activated`, 'success', 2000);
        });
    }

    function updateDarkModeIcon(theme) {
        const darkModeBtn = document.getElementById('btn-dark-mode');
        if (!darkModeBtn) return;
        const icon = darkModeBtn.querySelector('i');
        icon.className = theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
    }

    // Auto-Save System
    let autoSaveTimeout;
    let lastSaveState = '';

    function initAutoSave() {
        // Load saved draft on startup
        loadDraft();

        // Set up auto-save on input changes
        const container = document.querySelector('.maker-container');
        if (!container) return;

        container.addEventListener('input', debounce(() => {
            saveDraft();
        }, 2000));

        container.addEventListener('change', debounce(() => {
            saveDraft();
        }, 2000));

        // Manual save button
        const saveDraftBtn = document.getElementById('btn-save-draft');
        if (saveDraftBtn) {
            saveDraftBtn.addEventListener('click', () => {
                saveDraft(true);
            });
        }
    }

    function saveDraft(manual = false) {
        const saveIndicator = document.getElementById('save-indicator');
        const saveStatus = document.getElementById('save-status');

        if (saveIndicator && saveStatus) {
            saveIndicator.classList.remove('saved');
            saveIndicator.classList.add('saving');
            saveStatus.textContent = 'Saving...';
        }

        const config = collectBuilderConfig();
        const configString = JSON.stringify(config);

        if (configString === lastSaveState && !manual) {
            return;
        }

        try {
            localStorage.setItem('sct-builder-draft', configString);
            localStorage.setItem('sct-builder-draft-timestamp', new Date().toISOString());
            lastSaveState = configString;

            setTimeout(() => {
                if (saveIndicator && saveStatus) {
                    saveIndicator.classList.remove('saving');
                    saveIndicator.classList.add('saved');
                    const timestamp = new Date().toLocaleTimeString();
                    saveStatus.textContent = `Saved at ${timestamp}`;
                }
                if (manual) {
                    showToast('Draft saved successfully', 'success', 2000);
                }
            }, 500);
        } catch (error) {
            console.error('Failed to save draft:', error);
            if (saveIndicator && saveStatus) {
                saveIndicator.classList.remove('saving');
                saveStatus.textContent = 'Save failed';
            }
            showToast('Failed to save draft', 'error');
        }
    }

    function loadDraft() {
        try {
            const draftString = localStorage.getItem('sct-builder-draft');
            const timestamp = localStorage.getItem('sct-builder-draft-timestamp');

            if (!draftString) return;

            const draft = JSON.parse(draftString);
            const saveIndicator = document.getElementById('save-indicator');
            const saveStatus = document.getElementById('save-status');

            // Restore SCT name
            const sctNameInput = document.getElementById('sctName');
            if (sctNameInput && draft.sctName) {
                sctNameInput.value = draft.sctName;
            }

            // Restore deployment modalities
            if (draft.deploymentModalities) {
                draft.deploymentModalities.forEach(modality => {
                    const checkbox = document.querySelector(`input[value="${modality}"]`);
                    if (checkbox && !checkbox.checked) {
                        checkbox.click();
                    }
                });
            }

            // Restore weights
            if (draft.weights) {
                Object.entries(draft.weights).forEach(([section, weight]) => {
                    const input = document.querySelector(`input[data-section="${section}"]`);
                    if (input) {
                        input.value = weight;
                        input.dispatchEvent(new Event('input', { bubbles: true }));
                    }
                });
            }

            lastSaveState = draftString;

            if (saveIndicator && saveStatus && timestamp) {
                saveIndicator.classList.add('saved');
                const date = new Date(timestamp);
                saveStatus.textContent = `Loaded draft from ${date.toLocaleString()}`;
                showToast('Previous draft loaded', 'info', 2000);
            }
        } catch (error) {
            console.error('Failed to load draft:', error);
        }
    }

    function collectBuilderConfig() {
        const config = {
            sctName: document.getElementById('sctName')?.value || '',
            deploymentModalities: Array.from(document.querySelectorAll('#deployment-modalities-options input:checked')).map(cb => cb.value),
            weights: {}
        };

        document.querySelectorAll('.weight-input').forEach(input => {
            const section = input.dataset.section;
            if (section) {
                config.weights[section] = parseFloat(input.value) || 0;
            }
        });

        return config;
    }

    // Progress Bar Calculator
    function updateProgressBar() {
        const progressBar = document.getElementById('completion-progress');
        const progressFill = document.getElementById('progress-bar-fill');
        const progressText = document.getElementById('progress-text');

        if (!progressBar || !progressFill || !progressText) return;

        const totalFields = document.querySelectorAll('input[type="text"], input[type="number"], textarea, select').length;
        const filledFields = Array.from(document.querySelectorAll('input[type="text"], input[type="number"], textarea, select'))
            .filter(field => field.value && field.value.trim() !== '').length;

        const percentage = totalFields > 0 ? Math.round((filledFields / totalFields) * 100) : 0;

        progressFill.style.width = `${percentage}%`;
        progressText.textContent = `${percentage}% Complete`;

        if (percentage > 0) {
            progressBar.style.display = 'block';
        }
    }

    // Search and Filter
    function initSearch() {
        const searchInput = document.getElementById('search-standards');
        const clearSearchBtn = document.getElementById('btn-clear-search');
        const searchResults = document.getElementById('search-results');

        if (!searchInput || !searchResults) return;

        searchInput.addEventListener('input', debounce((e) => {
            const query = e.target.value.trim();
            if (query.length < 2) {
                searchResults.innerHTML = '';
                return;
            }
            performSearch(query);
        }, 300));

        if (clearSearchBtn) {
            clearSearchBtn.addEventListener('click', () => {
                searchInput.value = '';
                searchResults.innerHTML = '';
                searchInput.focus();
            });
        }
    }

    function performSearch(query) {
        const searchResults = document.getElementById('search-results');
        if (!searchResults) return;

        const results = [];
        const queryLower = query.toLowerCase();

        // Search through all accordion items
        document.querySelectorAll('.accordion-item').forEach(item => {
            const sectionTitle = item.querySelector('.accordion-button')?.textContent || '';
            const sectionContent = item.querySelector('.accordion-body')?.textContent || '';

            if (sectionTitle.toLowerCase().includes(queryLower) || sectionContent.toLowerCase().includes(queryLower)) {
                const context = getSearchContext(sectionContent, queryLower);
                results.push({
                    title: sectionTitle.trim(),
                    context: context,
                    element: item
                });
            }
        });

        displaySearchResults(results, query);
    }

    function getSearchContext(text, query) {
        const index = text.toLowerCase().indexOf(query);
        if (index === -1) return text.substring(0, 100) + '...';

        const start = Math.max(0, index - 50);
        const end = Math.min(text.length, index + query.length + 50);
        let context = text.substring(start, end);

        if (start > 0) context = '...' + context;
        if (end < text.length) context = context + '...';

        return context;
    }

    function displaySearchResults(results, query) {
        const searchResults = document.getElementById('search-results');
        if (!searchResults) return;

        if (results.length === 0) {
            searchResults.innerHTML = '<p class="text-muted">No results found</p>';
            return;
        }

        searchResults.innerHTML = results.map(result => {
            const highlightedContext = highlightText(result.context, query);
            return `
                <div class="search-result-item" data-section="${result.title}">
                    <div class="result-title">${result.title}</div>
                    <div class="result-context">${highlightedContext}</div>
                </div>
            `;
        }).join('');

        // Add click handlers to scroll to sections
        searchResults.querySelectorAll('.search-result-item').forEach((item, index) => {
            item.addEventListener('click', () => {
                results[index].element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                const button = results[index].element.querySelector('.accordion-button');
                if (button && button.classList.contains('collapsed')) {
                    button.click();
                }
            });
        });
    }

    function highlightText(text, query) {
        const regex = new RegExp(`(${query})`, 'gi');
        return text.replace(regex, '<span class="highlight">$1</span>');
    }

    // Template Management
    function initTemplateManagement() {
        const saveTemplateBtn = document.getElementById('btn-save-template');
        const templateNameInput = document.getElementById('template-name-input');

        if (saveTemplateBtn) {
            saveTemplateBtn.addEventListener('click', () => {
                const name = templateNameInput?.value.trim();
                if (!name) {
                    showToast('Please enter a template name', 'warning');
                    return;
                }
                saveTemplate(name);
                if (templateNameInput) templateNameInput.value = '';
            });
        }

        loadTemplatesList();
    }

    function saveTemplate(name) {
        try {
            const config = collectBuilderConfig();
            const templates = JSON.parse(localStorage.getItem('sct-templates') || '[]');

            templates.push({
                name: name,
                date: new Date().toISOString(),
                config: config
            });

            localStorage.setItem('sct-templates', JSON.stringify(templates));
            loadTemplatesList();
            showToast('Template saved successfully', 'success');
        } catch (error) {
            console.error('Failed to save template:', error);
            showToast('Failed to save template', 'error');
        }
    }

    function loadTemplatesList() {
        const templatesList = document.getElementById('templates-list');
        if (!templatesList) return;

        try {
            const templates = JSON.parse(localStorage.getItem('sct-templates') || '[]');

            if (templates.length === 0) {
                templatesList.innerHTML = '<p class="text-muted text-center">No templates saved yet.</p>';
                return;
            }

            templatesList.innerHTML = templates.map((template, index) => {
                const date = new Date(template.date).toLocaleString();
                return `
                    <div class="template-item">
                        <div class="template-info">
                            <div class="template-name">${template.name}</div>
                            <div class="template-date">${date}</div>
                        </div>
                        <div class="template-actions">
                            <button class="btn btn-sm btn-primary" onclick="loadTemplate(${index})">
                                <i class="fas fa-download"></i> Load
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteTemplate(${index})">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        } catch (error) {
            console.error('Failed to load templates list:', error);
        }
    }

    function loadTemplate(index) {
        try {
            const templates = JSON.parse(localStorage.getItem('sct-templates') || '[]');
            const template = templates[index];

            if (!template) return;

            // Load the template configuration
            const config = template.config;

            // Restore SCT name
            const sctNameInput = document.getElementById('sctName');
            if (sctNameInput) {
                sctNameInput.value = config.sctName || '';
            }

            // Restore deployment modalities
            document.querySelectorAll('#deployment-modalities-options input').forEach(cb => {
                cb.checked = false;
            });
            if (config.deploymentModalities) {
                config.deploymentModalities.forEach(modality => {
                    const checkbox = document.querySelector(`input[value="${modality}"]`);
                    if (checkbox) {
                        checkbox.click();
                    }
                });
            }

            // Restore weights
            if (config.weights) {
                Object.entries(config.weights).forEach(([section, weight]) => {
                    const input = document.querySelector(`input[data-section="${section}"]`);
                    if (input) {
                        input.value = weight;
                        input.dispatchEvent(new Event('input', { bubbles: true }));
                    }
                });
            }

            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('templatesModal'));
            if (modal) modal.hide();

            showToast(`Template "${template.name}" loaded successfully`, 'success');
        } catch (error) {
            console.error('Failed to load template:', error);
            showToast('Failed to load template', 'error');
        }
    }

    function deleteTemplate(index) {
        if (!confirm('Are you sure you want to delete this template?')) return;

        try {
            const templates = JSON.parse(localStorage.getItem('sct-templates') || '[]');
            templates.splice(index, 1);
            localStorage.setItem('sct-templates', JSON.stringify(templates));
            loadTemplatesList();
            showToast('Template deleted successfully', 'success');
        } catch (error) {
            console.error('Failed to delete template:', error);
            showToast('Failed to delete template', 'error');
        }
    }

    // Make functions globally accessible
    window.loadTemplate = loadTemplate;
    window.deleteTemplate = deleteTemplate;

    // PDF Export for Builder Configuration
    function initPDFExport() {
        const exportBtn = document.getElementById('btn-export-config');
        if (!exportBtn) return;

        exportBtn.addEventListener('click', () => {
            showExportPreview();
        });

        const confirmExportBtn = document.getElementById('btn-confirm-export');
        if (confirmExportBtn) {
            confirmExportBtn.addEventListener('click', () => {
                exportBuilderConfigToPDF();
            });
        }
    }

    function showExportPreview() {
        const previewContent = document.getElementById('export-preview-content');
        if (!previewContent) return;

        const config = collectBuilderConfig();

        previewContent.innerHTML = `
            <div class="mb-3">
                <strong>SCT Name:</strong> ${config.sctName || 'Not specified'}
            </div>
            <div class="mb-3">
                <strong>Deployment Modalities:</strong> ${config.deploymentModalities.join(', ') || 'None selected'}
            </div>
            <div class="mb-3">
                <strong>Section Weights:</strong>
                <ul>
                    ${Object.entries(config.weights).map(([section, weight]) =>
                        `<li>${section}: ${weight}%</li>`
                    ).join('')}
                </ul>
            </div>
        `;

        const modal = new bootstrap.Modal(document.getElementById('exportPreviewModal'));
        modal.show();
    }

    function exportBuilderConfigToPDF() {
        try {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            const config = collectBuilderConfig();

            // Title
            doc.setFontSize(20);
            doc.text('SCT Tool Builder Configuration', 20, 20);

            // Metadata
            doc.setFontSize(10);
            doc.text(`Generated: ${new Date().toLocaleString()}`, 20, 30);

            // SCT Name
            doc.setFontSize(14);
            doc.text('SCT Name:', 20, 45);
            doc.setFontSize(12);
            doc.text(config.sctName || 'Not specified', 20, 52);

            // Deployment Modalities
            doc.setFontSize(14);
            doc.text('Deployment Modalities:', 20, 65);
            doc.setFontSize(12);
            const modalities = config.deploymentModalities.join(', ') || 'None selected';
            doc.text(modalities, 20, 72);

            // Section Weights
            doc.setFontSize(14);
            doc.text('Section Weights:', 20, 85);
            doc.setFontSize(12);
            let yPos = 92;
            Object.entries(config.weights).forEach(([section, weight]) => {
                doc.text(`${section}: ${weight}%`, 25, yPos);
                yPos += 7;
            });

            doc.save('sct-builder-configuration.pdf');

            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('exportPreviewModal'));
            if (modal) modal.hide();

            showToast('Configuration exported to PDF', 'success');
        } catch (error) {
            console.error('Failed to export PDF:', error);
            showToast('Failed to export PDF', 'error');
        }
    }

    // Keyboard Shortcuts
    function initKeyboardShortcuts() {
        document.addEventListener('keydown', (e) => {
            // Ctrl+S - Save Draft
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                saveDraft(true);
            }

            // Ctrl+D - Toggle Dark Mode
            if (e.ctrlKey && e.key === 'd') {
                e.preventDefault();
                document.getElementById('btn-dark-mode')?.click();
            }

            // Ctrl+F - Focus Search
            if (e.ctrlKey && e.key === 'f') {
                e.preventDefault();
                document.getElementById('search-standards')?.focus();
            }

            // Ctrl+E - Export Config
            if (e.ctrlKey && e.key === 'e') {
                e.preventDefault();
                document.getElementById('btn-export-config')?.click();
            }

            // Ctrl+T - Open Templates
            if (e.ctrlKey && e.key === 't') {
                e.preventDefault();
                document.getElementById('btn-templates')?.click();
            }

            // Ctrl+K - Show Shortcuts
            if (e.ctrlKey && e.key === 'k') {
                e.preventDefault();
                document.getElementById('btn-shortcuts')?.click();
            }
        });
    }

    // Initialize All Enhanced Features
    function initEnhancedFeatures() {
        initDarkMode();
        initAutoSave();
        initSearch();
        initTemplateManagement();
        initPDFExport();
        initKeyboardShortcuts();

        // Update progress bar on any input
        document.addEventListener('input', throttle(() => {
            updateProgressBar();
        }, 1000));

        // Show welcome message
        setTimeout(() => {
            showToast('Welcome! Your progress is auto-saved.', 'info', 4000);
        }, 500);
    }

    document.addEventListener('DOMContentLoaded', function() {
        renderMakerUI();
        renderSectionManagementList();
        initEnhancedFeatures();

        // Save/Load maker state event listeners
        const btnSaveMaker = document.getElementById('btn-save-maker');
        if (btnSaveMaker) {
            btnSaveMaker.addEventListener('click', saveMakerState);
        }

        const btnLoadMaker = document.getElementById('btn-load-maker');
        const makerFileInput = document.getElementById('maker-file-input');
        if (btnLoadMaker && makerFileInput) {
            btnLoadMaker.addEventListener('click', () => {
                makerFileInput.click();
            });

            makerFileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    loadMakerState(file);
                }
                // Reset input so the same file can be loaded again
                e.target.value = '';
            });
        }

        // Check if there's a saved state in the current page on load
        const savedStateScript = document.getElementById('maker-saved-state');
        if (savedStateScript) {
            try {
                const makerState = JSON.parse(savedStateScript.textContent);

                // Ask user if they want to restore
                if (confirm(`Found saved maker state from ${new Date(makerState.timestamp).toLocaleString()}. Do you want to restore it?`)) {
                    // Restore TOOL_CONFIG
                    Object.keys(TOOL_CONFIG).forEach(key => delete TOOL_CONFIG[key]);
                    Object.assign(TOOL_CONFIG, makerState.toolConfig);

                    // Restore SECTION_CONTENT
                    Object.keys(SECTION_CONTENT).forEach(key => delete SECTION_CONTENT[key]);
                    Object.assign(SECTION_CONTENT, makerState.sectionContent);

                    // Restore deployment overrides
                    Object.keys(builderDeploymentOverrides).forEach(key => delete builderDeploymentOverrides[key]);
                    Object.assign(builderDeploymentOverrides, makerState.deploymentOverrides || {});

                    // Restore SCT name
                    const sctNameInput = document.getElementById('sctName');
                    if (sctNameInput && makerState.sctName) {
                        sctNameInput.value = makerState.sctName;
                    }

                    // Restore selected modalities
                    document.querySelectorAll('.deployment-modality-checkbox').forEach(cb => {
                        cb.checked = makerState.selectedModalities?.includes(cb.dataset.key) || false;
                    });

                    // Re-render the maker UI
                    renderMakerUI();
                    renderSectionManagementList();

                    showToast('Maker state restored successfully!', 'success');
                }
            } catch (error) {
                console.error('Error restoring saved state:', error);
            }
        }
    });
    </script>
    
    <div id="template-info" style="display: none;"><h2 class="mb-4">Self-Assessment Checklist for Emergency Medical Teams</h2><div class="card section-card"><div class="card-body"><h5 class="card-title">Minimum Standards for Highly Infectious Disease (HID) Specialized Care Team (SCT) ‚Äì AWD Inpatient</h5><p class="card-text">This self-assessment tool is designed to help HID SCTs evaluate their readiness and capabilities according to the established minimum standards.</p><p class="card-text">Use this digital tool to complete your assessment, track progress, and generate reports for your organization and the coordination mechanism.</p><p class="text-muted">Version 1.0/2025</p></div></div><div class="row mt-4"><div class="col-md-4"><div class="overview-card bg-light"><i class="fas fa-check-circle fa-2x text-success"></i><h5>Completed Sections</h5><div class="card-value" id="completedSections">0/8</div></div></div><div class="col-md-4"><div class="overview-card bg-light"><i class="fas fa-chart-line fa-2x text-primary"></i><h5>Overall Score</h5><div class="card-value" id="overallScore">0%</div></div></div><div class="col-md-4"><div class="overview-card bg-light"><i class="fas fa-clock fa-2x text-warning"></i><h5>Last Updated</h5><div class="card-value" id="lastUpdated">Today</div></div></div></div></div>
    <div id="template-definition" style="display: none;"><h2 class="mb-4">Technical Standards Definition</h2><div class="card section-card"><div class="card-body"><p>HID SCTs are national or international teams deployed at the request of the Ministry of Health (MOH)/ coordination cell of the host country. The HID SCT's modality of deployment (embed, coupled or self-sustained) depends on context and defined capacity/level of care.</p><p>Depending on modality of deployment, some operations support, logistics and WASH elements may be provided by a host facility.</p></div></div></div>
    <div id="template-org-detail" style="display: none;"><h2 class="mb-4">Organizational Details</h2><div class="card section-card"><div class="section-header"><h5>Team Information</h5></div><div class="card-body"><div class="row mb-3"><div class="col-md-6"><label for="teamName" class="form-label">Team Name</label><input type="text" class="form-control" id="teamName"></div><div class="col-md-6"><label for="region" class="form-label">Region</label><input type="text" class="form-control" id="region"></div></div><div class="row mb-3"><div class="col-md-6"><label for="country" class="form-label">Country</label><input type="text" class="form-control" id="country"></div><div class="col-md-6"><label for="mentorName" class="form-label">Mentor Name</label><input type="text" class="form-control" id="mentorName"></div></div></div></div><div class="card section-card"><div class="section-header"><h5>Contact Information</h5></div><div class="card-body"><div class="row mb-3"><div class="col-md-6"><h6>Headquarters Contact</h6><div class="mb-2"><label class="form-label">Name</label><input type="text" class="form-control" id="hqName"></div><div class="mb-2"><label class="form-label">Email</label><input type="email" class="form-control" id="hqEmail"></div><div class="mb-2"><label class="form-label">Phone</label><input type="tel" class="form-control" id="hqPhone"></div><div class="mb-2"><label class="form-label">Position</label><input type="text" class="form-control" id="hqPosition"></div></div><div class="col-md-6"><h6>Operations Contact</h6><div class="mb-2"><label class="form-label">Name</label><input type="text" class="form-control" id="opsName"></div><div class="mb-2"><label class="form-label">Email</label><input type="email" class="form-control" id="opsEmail"></div><div class="mb-2"><label class="form-label">Phone</label><input type="tel" class="form-control" id="opsPhone"></div><div class="mb-2"><label class="form-label">Position</label><input type="text" class="form-control" id="opsPosition"></div></div></div></div></div><div class="card section-card"><div class="section-header"><h5>Progress Overview</h5></div><div class="card-body"><table class="table table-bordered"><thead class="table-light"><tr><th>Section</th><th>Weight</th><th>Status</th><th>% Completed</th></tr></thead><tbody id="progressTableBody"></tbody></table></div></div></div>
    <div id="template-summary" style="display: none;"><h2 class="mb-4">Summary & Action Plan</h2><div class="card section-card"><div class="section-header"><h5>Overall Readiness Assessment</h5></div><div class="card-body"><div class="mb-3"><label for="strengths" class="form-label"><strong>Strengths Identified:</strong></label><textarea class="form-control summary-textarea" id="strengths" placeholder="List the top 3-5 strengths identified..."></textarea></div><div class="mb-3"><label for="criticalGaps" class="form-label"><strong>Critical Gaps Requiring Immediate Action:</strong></label><textarea class="form-control summary-textarea" id="criticalGaps" placeholder="List the critical gaps that need..."></textarea></div><div class="mb-3"><label class="form-label"><strong>Timeline for Addressing Gaps:</strong></label><div class="mb-2"><label class="form-label">Immediate (0-1 month):</label><textarea class="form-control summary-textarea" id="immediateActions"></textarea></div><div class="mb-2"><label class="form-label">Short-term (1-3 months):</label><textarea class="form-control summary-textarea" id="shortTermActions"></textarea></div><div class="mb-2"><label class="form-label">Medium-term (3-6 months):</label><textarea class="form-control summary-textarea" id="mediumTermActions"></textarea></div></div><div class="mb-3"><label class="form-label"><strong>Support Required:</strong></label><div class="mb-2"><label class="form-label">Technical assistance needed:</label><textarea class="form-control summary-textarea" id="technicalAssistance"></textarea></div><div class="mb-2"><label class="form-label">Training requirements:</label><textarea class="form-control summary-textarea" id="trainingRequirements"></textarea></div><div class="mb-2"><label class="form-label">Resource requirements:</label><textarea class="form-control summary-textarea" id="resourceRequirements"></textarea></div></div><div class="mb-3"><label for="nextSteps" class="form-label"><strong>Next Steps:</strong></label><textarea class="form-control summary-textarea" id="nextSteps" placeholder="1. First priority action..."></textarea></div><div class="row"><div class="col-md-6"><label for="completionDate" class="form-label">Date of Completion:</label><input type="date" class="form-control" id="completionDate"></div><div class="col-md-6"><label for="reviewedBy" class="form-label">Reviewed by:</label><input type="text" class="form-control" id="reviewedBy" placeholder="Name and title"></div></div><div class="mt-3"><label for="mentorAssignment" class="form-label">Mentor Assignment:</label><input type="text" class="form-control" id="mentorAssignment" placeholder="Mentor name and contact"></div></div></div></div>

    <!-- Templates Modal -->
    <div class="modal fade" id="templatesModal" tabindex="-1" aria-labelledby="templatesModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="templatesModalLabel">Template Management</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="template-name-input" class="form-label">Save Current Configuration as Template</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="template-name-input" placeholder="Enter template name...">
                            <button class="btn btn-primary" id="btn-save-template">
                                <i class="fas fa-save me-1"></i>Save Template
                            </button>
                        </div>
                    </div>
                    <hr>
                    <h6>Saved Templates</h6>
                    <div id="templates-list" class="mt-3">
                        <p class="text-muted text-center">No templates saved yet.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Keyboard Shortcuts Modal -->
    <div class="modal fade" id="shortcutsModal" tabindex="-1" aria-labelledby="shortcutsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="shortcutsModalLabel">Keyboard Shortcuts</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="keyboard-shortcuts-list">
                        <div class="shortcut-item">
                            <span>Search Standards</span>
                            <span class="shortcut-key">Ctrl+F</span>
                        </div>
                        <div class="shortcut-item">
                            <span>Save Draft</span>
                            <span class="shortcut-key">Ctrl+S</span>
                        </div>
                        <div class="shortcut-item">
                            <span>Toggle Dark Mode</span>
                            <span class="shortcut-key">Ctrl+D</span>
                        </div>
                        <div class="shortcut-item">
                            <span>Export Configuration</span>
                            <span class="shortcut-key">Ctrl+E</span>
                        </div>
                        <div class="shortcut-item">
                            <span>Open Templates</span>
                            <span class="shortcut-key">Ctrl+T</span>
                        </div>
                        <div class="shortcut-item">
                            <span>Show Shortcuts</span>
                            <span class="shortcut-key">Ctrl+K</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Export Preview Modal -->
    <div class="modal fade" id="exportPreviewModal" tabindex="-1" aria-labelledby="exportPreviewModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exportPreviewModalLabel">Export Preview</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <h6>Configuration Summary</h6>
                    <div id="export-preview-content">
                        <!-- Preview content will be dynamically inserted here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="btn-confirm-export">
                        <i class="fas fa-file-pdf me-1"></i>Export PDF
                    </button>
                </div>
            </div>
        </div>
    </div>

</body>
</html>
