<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HID SCT Self-Assessment Tool</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        :root{--primary:#0d6efd;--secondary:#6c757d;--success:#198754;--info:#0dcaf0;--warning:#ffc107;--danger:#dc3545;--light:#f8f9fa;--dark:#212529}
        body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background-color:#f5f7f9;padding:0; margin:0;}
        .app-container{max-width:100%; margin:0 auto;background:white;box-shadow:0 0 15px rgba(0,0,0,.1);border-radius:0;overflow:hidden}
        .sidebar{background-color:#2c3e50;color:white;height:100vh;position:sticky;top:0;padding-top:20px;overflow-y:auto}
        .sidebar .nav-link{color:rgba(255,255,255,.8);border-left:3px solid transparent;padding:10px 15px;margin:5px 0;transition:all .3s}
        .sidebar .nav-link:hover,.sidebar .nav-link.active{color:white;background-color:rgba(255,255,255,.1);border-left-color:var(--info)}
        .sidebar .nav-link i{margin-right:10px;width:20px;text-align:center}
        .main-content{padding:20px;height:100vh;overflow-y:auto}
        .progress-sidebar{background-color:#f8f9fa;height:100vh;position:sticky;top:0;padding:20px 15px;overflow-y:auto;border-left:1px solid #e9ecef}
        .progress-bar-container{background-color:#e9ecef;border-radius:5px;margin-bottom:20px;height:30px}
        .progress-bar{height:100%;border-radius:5px;transition:width .5s ease}
        .section-card{margin-bottom:20px;box-shadow:0 4px 6px rgba(0,0,0,.1);border:none;border-radius:8px}
        .section-header{background-color:#f8f9fa;padding:15px;border-bottom:1px solid #e9ecef;border-radius:8px 8px 0 0}
        .comments-section{background-color:#f8f9fa;padding:15px;border-radius:0 0 8px 8px;border-top:1px solid #e9ecef}
        .overview-card{text-align:center;padding:20px;border-radius:8px;margin-bottom:20px;box-shadow:0 4px 6px rgba(0,0,0,.1)}
        .overview-card .card-value{font-size:2rem;font-weight:bold;margin:10px 0}
        .score-display{font-size:1.2rem;font-weight:bold;color:var(--primary)}
        .assessment-table{width:100%;border-collapse:collapse;margin-bottom:20px;table-layout: fixed;}
        .assessment-table th,.assessment-table td{border:1px solid #dee2e6;padding:12px;text-align:left;vertical-align:top}
        .assessment-table th{background-color:#f8f9fa;font-weight:600}
        /* Improved score styling for better visibility */
        .score-select{font-weight:bold;text-align:center;min-width:120px;}
        .score-0{background:#fee2e2;color:#dc2626 !important;border:1px solid #dc2626}
        .score-1{background:#fed7aa;color:#ea580c !important;border:1px solid #ea580c}
        .score-2{background:#fef3c7;color:#ca8a04 !important;border:1px solid #ca8a04}
        .score-3{background:#d1fae5;color:#059669 !important;border:1px solid #059669}
        .score-NA{background:#f3f4f6;color:#6b7280 !important;border:1px solid #d1d5db}
        /* Improved column widths */
        .assessment-table th:nth-child(1), .assessment-table td:nth-child(1){width:40%;} /* Standard */
        .assessment-table th:nth-child(2), .assessment-table td:nth-child(2){width:12%;} /* Score */
        .assessment-table th:nth-child(3), .assessment-table td:nth-child(3){width:20%;} /* Evidence */
        .assessment-table th:nth-child(4), .assessment-table td:nth-child(4){width:14%;} /* Gaps */
        .assessment-table th:nth-child(5), .assessment-table td:nth-child(5){width:14%;} /* Actions */
        .evidence-input, .gaps-input, .action-input{resize:vertical;min-height:60px;font-size:0.9rem;}
        .notification{position:fixed;top:20px;right:20px;background:linear-gradient(135deg,#4ade80 0%,#22c55e 100%);color:white;padding:15px 25px;border-radius:8px;box-shadow:0 5px 20px rgba(0,0,0,.2);z-index:1000;animation:slideIn .3s ease}
        .progress-sidebar-table{width:100%;font-size:.85rem}
        .progress-sidebar-table th,.progress-sidebar-table td{padding:8px 5px;border-bottom:1px solid #dee2e6}
        .progress-sidebar-table th{font-weight:600}
        .progress-sidebar-table tr:last-child td{border-bottom:none}
        @keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
        @keyframes fadeOut{from{opacity:1}to{opacity:0}}
        .summary-textarea{min-height:100px;resize:vertical}
        .file-input{display:none}
        #config-loader-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #343a40; z-index: 2000; display: flex; align-items: center; justify-content: center; color: white; text-align: center; flex-direction: column; transition: opacity 0.3s ease; }
        #drop-zone { border: 3px dashed #6c757d; border-radius: 20px; padding: 50px; width: 80%; max-width: 600px; transition: background-color 0.2s ease, border-color 0.2s ease; }
        #drop-zone.dragover { background-color: rgba(255, 255, 255, 0.1); border-color: var(--primary); }
        #app-wrapper { display: none; }
        
        /* RESPONSIVE DESIGN */
        @media (max-width: 991.98px) {
            .progress-sidebar { display: none; }
            .main-content, .sidebar { height: auto; position: relative; }
        }
        @media (max-width: 767.98px) {
            .sidebar { border-bottom: 2px solid var(--primary); }
            .assessment-table-container { overflow-x: auto; }
            .assessment-table { width: 800px; /* Force table to be wide */ }
            .assessment-table th, .assessment-table td { padding: 8px; font-size: 0.9rem; }
            .score-select { min-width: 100px; font-size: 0.85rem; }
        }
    </style>
</head>
<body>
    <div id="config-loader-overlay">
        <div id="drop-zone">
            <h1>Herramienta de Autoevaluación</h1>
            <p class="lead mt-3">Arrastra y suelta tu archivo <code>config.json</code> aquí</p>
            <p>o</p>
            <button id="load-config-btn" class="btn btn-primary btn-lg"><i class="fas fa-upload me-2"></i>Selecciona un Archivo</button>
            <input type="file" id="config-file-input" class="file-input" accept=".json">
        </div>
    </div>

    <div id="app-wrapper">
        <div class="app-container">
            <div class="row g-0">
                <div class="col-lg-2"><div class="sidebar"><h4 class="text-center mb-4">HID SCT Assessment</h4><ul class="nav flex-column" id="sidebar-nav-container"></ul><div class="mt-4 p-3"><div class="progress-bar-container"><div class="progress-bar bg-success" id="overallProgressBar" style="width:0%"></div></div><p class="mb-1">Overall Completion</p><h5 class="text-center" id="overallProgressText">0%</h5></div></div></div>
                <div class="col-lg-8"><div class="main-content"><div class="tab-content" id="tab-content-container"></div><div class="d-flex justify-content-between mt-4"><div><button class="btn btn-outline-secondary" id="btn-import-excel"><i class="fas fa-upload me-2"></i>Importar Datos Excel</button><button class="btn btn-outline-secondary" id="btn-export-json"><i class="fas fa-download me-2"></i>Exportar Datos JSON</button></div><div><button class="btn btn-outline-primary me-2" id="btn-save"><i class="fas fa-save me-2"></i>Guardar Borrador</button><button class="btn btn-outline-info me-2" id="btn-export-excel"><i class="fas fa-file-excel me-2"></i>Exportar a Excel</button><button class="btn btn-success" id="btn-submit"><i class="fas fa-check-circle me-2"></i>Enviar Evaluación</button></div></div></div></div>
                <div class="col-lg-2"><div class="progress-sidebar"><h5 class="mb-3">Progress Overview</h5><div class="progress-bar-container mb-3"><div class="progress-bar bg-success" id="sidebarProgressBar" style="width:0%"></div></div><p class="mb-1">Overall Completion</p><h5 class="text-center mb-4" id="sidebarProgressText">0%</h5><table class="table table-bordered"><thead class="table-light"><tr><th>Section</th><th>Weight</th><th>Status</th><th>%</th></tr></thead><tbody id="progressSidebarBody"></tbody></table></div></div>
            </div>
        </div>
        <input type="file" id="data-file-input" class="file-input" accept=".xlsx, .xls">
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    let CONFIG = {};
    let SECTIONS_WITH_WEIGHT = [];
    let assessmentData = { teamInfo:{}, scores:{}, evidence:{}, gaps:{}, actions:{}, comments:{}, summary:{} };

    function initializeApp(config) {
        CONFIG = config;
        SECTIONS_WITH_WEIGHT = Object.entries(CONFIG).filter(([,c]) => c.weight > 0).map(([k,c]) => ({ name: c.title.toUpperCase(), weight: c.weight, section: k }));

        const sidebarNav = document.getElementById('sidebar-nav-container');
        const tabContent = document.getElementById('tab-content-container');
        let sidebarLinks = '', tabPanes = '';

        Object.entries(CONFIG).forEach(([key, configData]) => {
            sidebarLinks += `<li class="nav-item"><a class="nav-link" href="#${key}" data-bs-toggle="tab"><i class="fas ${configData.icon}"></i> ${configData.title}</a></li>`;
            
            let content = '';
            if (configData.hasSubsections) {
                const tableRows = configData.subsections.map(sub => {
                    const subId = sub.replace(/<[^>]*>?/gm, '').toLowerCase().replace(/[^\w\s]/gi, '').replace(/\s+/g, '-').slice(0, 50);
                    return `<tr>
                        <td>${sub}</td>
                        <td>
                            <select class="form-select score-select" data-section="${key}" data-item="${subId}">
                                <option value="0" selected>0 - Not started</option>
                                <option value="1">1 - Initial</option>
                                <option value="2">2 - In progress</option>
                                <option value="3">3 - Completed</option>
                                <option value="NA">N/A</option>
                            </select>
                        </td>
                        <td><textarea class="form-control evidence-input" rows="2" placeholder="Describe evidence..."></textarea></td>
                        <td><textarea class="form-control gaps-input" rows="2" placeholder="Identify gaps..."></textarea></td>
                        <td><textarea class="form-control action-input" rows="2" placeholder="Plan actions..."></textarea></td>
                    </tr>`;
                }).join('');
                content = `<div class="card section-card">
                    <div class="section-header d-flex justify-content-between align-items-center">
                        <h5>${configData.title} Compliance</h5>
                        <div class="score-display" id="${key}Score">0% Complete</div>
                    </div>
                    <div class="assessment-table-container">
                        <table class="assessment-table">
                            <thead>
                                <tr>
                                    <th>Standard</th>
                                    <th>Score</th>
                                    <th>Evidence</th>
                                    <th>Gaps</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>${tableRows}</tbody>
                        </table>
                    </div>
                    <div class="comments-section">
                        <label for="${key}Comments" class="form-label">Mentor Comments & Observations</label>
                        <textarea class="form-control" id="${key}Comments" rows="3" placeholder="Add comments and observations..."></textarea>
                    </div>
                </div>`;
            } else { 
                content = configData.content; 
            }
            tabPanes += `<div class="tab-pane fade" id="${key}">${content}</div>`;
        });

        sidebarNav.innerHTML = sidebarLinks;
        tabContent.innerHTML = tabPanes;
        
        // Activate first tab
        const firstNavLink = sidebarNav.querySelector('.nav-link');
        if (firstNavLink) {
            firstNavLink.classList.add('active');
        }
        const firstTabPane = tabContent.querySelector('.tab-pane');
        if (firstTabPane) {
            firstTabPane.classList.add('show', 'active');
        }

        document.getElementById('config-loader-overlay').style.display = 'none';
        document.getElementById('app-wrapper').style.display = 'block';

        const savedData = localStorage.getItem("hidSCTAssessment");
        if(savedData) {
            // Load existing data
            assessmentData = JSON.parse(savedData);
            loadSavedData();
        } else {
            // Initialize with default "Not started" values for new config
            initializeDefaultScores();
        }
        
        updateProgress();
        addAppEventListeners();
    }
    
    function initializeDefaultScores() {
        // Set all scores to "0" (Not started) by default for new assessments
        document.querySelectorAll(".score-select").forEach(select => {
            select.value = "0";
            updateScoreBadge(select);
        });
        
        // Save the default state
        saveProgress();
    }
    
    function loadSavedData(){
        if(assessmentData.teamInfo){
            Object.keys(assessmentData.teamInfo).forEach(key => {
                const element = document.getElementById(key);
                if(element) {
                    element.value = assessmentData.teamInfo[key];
                }
            });
        }
        
        document.querySelectorAll(".score-select").forEach(select => {
            const key = select.dataset.section + "-" + select.dataset.item;
            if(assessmentData.scores[key]) {
                select.value = assessmentData.scores[key];
                updateScoreBadge(select);
                const row = select.closest("tr");
                if(row) {
                    row.querySelector(".evidence-input").value = assessmentData.evidence[key] || "";
                    row.querySelector(".gaps-input").value = assessmentData.gaps[key] || "";
                    row.querySelector(".action-input").value = assessmentData.actions[key] || "";
                }
            }
        });
        
        if(assessmentData.comments) {
            Object.keys(assessmentData.comments).forEach(key => {
                const element = document.getElementById(key);
                if(element) {
                    element.value = assessmentData.comments[key];
                }
            });
        }
        
        if(assessmentData.summary) {
            const summary = assessmentData.summary;
            Object.keys(summary).forEach(key => {
                const element = document.getElementById(key);
                if(element) {
                    element.value = summary[key];
                }
            });
        }
    }
    
    function saveProgress(){
        assessmentData.teamInfo = {
            teamName: document.getElementById("teamName")?.value,
            region: document.getElementById("region")?.value,
            country: document.getElementById("country")?.value,
            mentorName: document.getElementById("mentorName")?.value,
            hqName: document.getElementById("hqName")?.value,
            hqEmail: document.getElementById("hqEmail")?.value,
            hqPhone: document.getElementById("hqPhone")?.value,
            hqPosition: document.getElementById("hqPosition")?.value,
            opsName: document.getElementById("opsName")?.value,
            opsEmail: document.getElementById("opsEmail")?.value,
            opsPhone: document.getElementById("opsPhone")?.value,
            opsPosition: document.getElementById("opsPosition")?.value
        };
        
        assessmentData.scores = {};
        assessmentData.evidence = {};
        assessmentData.gaps = {};
        assessmentData.actions = {};
        
        document.querySelectorAll(".score-select").forEach(select => {
            const key = select.dataset.section + "-" + select.dataset.item;
            const row = select.closest("tr");
            
            if(select.value) {
                assessmentData.scores[key] = select.value;
            }
            
            const evidenceInput = row.querySelector(".evidence-input");
            const gapsInput = row.querySelector(".gaps-input");
            const actionInput = row.querySelector(".action-input");
            
            if(evidenceInput) assessmentData.evidence[key] = evidenceInput.value;
            if(gapsInput) assessmentData.gaps[key] = gapsInput.value;
            if(actionInput) assessmentData.actions[key] = actionInput.value;
        });
        
        assessmentData.comments = {};
        SECTIONS_WITH_WEIGHT.forEach(section => {
            const commentElement = document.getElementById(section.section + "Comments");
            if(commentElement) {
                assessmentData.comments[section.section + "Comments"] = commentElement.value;
            }
        });
        
        assessmentData.summary = {
            strengths: document.getElementById("strengths")?.value,
            criticalGaps: document.getElementById("criticalGaps")?.value,
            immediateActions: document.getElementById("immediateActions")?.value,
            shortTermActions: document.getElementById("shortTermActions")?.value,
            mediumTermActions: document.getElementById("mediumTermActions")?.value,
            technicalAssistance: document.getElementById("technicalAssistance")?.value,
            trainingRequirements: document.getElementById("trainingRequirements")?.value,
            resourceRequirements: document.getElementById("resourceRequirements")?.value,
            nextSteps: document.getElementById("nextSteps")?.value,
            completionDate: document.getElementById("completionDate")?.value,
            reviewedBy: document.getElementById("reviewedBy")?.value,
            mentorAssignment: document.getElementById("mentorAssignment")?.value
        };
        
        localStorage.setItem("hidSCTAssessment", JSON.stringify(assessmentData));
        showNotification("Progress saved successfully!");
        updateProgress();
    }
    
    function showNotification(message){
        const notification = document.createElement("div");
        notification.className = "notification";
        notification.textContent = message;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.style.animation = "fadeOut .3s ease";
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }
    
    function updateScoreBadge(select){
        const value = select.value;
        // Reset all score classes
        select.classList.remove("score-0", "score-1", "score-2", "score-3", "score-NA");
        
        if(value !== "" && value !== "NA") {
            select.classList.add("score-" + value);
        } else if (value === "NA") {
            select.classList.add("score-NA");
        }
    }
    
    function updateProgress(){
        let totalWeight = 0;
        let weightedScore = 0;
        let overallScore = 0;
        
        const sectionScores = {};
        SECTIONS_WITH_WEIGHT.forEach(section => {
            sectionScores[section.section] = {score: 0, maxScore: 0};
        });
        
        let totalItems = 0;
        let completedItems = 0;
        
        document.querySelectorAll(".score-select").forEach(select => {
            const section = select.dataset.section;
            if(sectionScores[section]) {
                totalItems++;
                if(select.value !== "") {
                    completedItems++;
                    if(select.value !== "NA") {
                        sectionScores[section].score += parseInt(select.value);
                        sectionScores[section].maxScore += 3;
                    }
                }
            }
        });
        
        let overallPercentage = 0;
        SECTIONS_WITH_WEIGHT.forEach(section => {
            const scoreData = sectionScores[section.section];
            let percentage = 0;
            if(scoreData.maxScore > 0) {
                percentage = Math.round(scoreData.score / scoreData.maxScore * 100);
            }
            
            const scoreDisplay = document.getElementById(section.section + "Score");
            if(scoreDisplay) {
                scoreDisplay.textContent = percentage + "% Complete";
            }
            
            totalWeight += section.weight;
            weightedScore += section.weight * percentage / 100;
        });
        
        overallPercentage = totalWeight > 0 ? Math.round(weightedScore / totalWeight * 100) : 0;
        
        const completedSections = document.getElementById("completedSections");
        if(completedSections) {
            completedSections.textContent = Object.values(sectionScores).filter(s => s.maxScore > 0).length + "/" + SECTIONS_WITH_WEIGHT.length;
        }
        
        const overallScoreDisplay = document.getElementById("overallScore");
        if(overallScoreDisplay) {
            overallScoreDisplay.textContent = overallPercentage + "%";
        }
        
        const lastUpdated = document.getElementById("lastUpdated");
        if(lastUpdated) {
            lastUpdated.textContent = (new Date()).toLocaleDateString();
        }
        
        document.getElementById("overallProgressBar").style.width = overallPercentage + "%";
        document.getElementById("overallProgressText").textContent = overallPercentage + "%";
        document.getElementById("sidebarProgressBar").style.width = overallPercentage + "%";
        document.getElementById("sidebarProgressText").textContent = overallPercentage + "%";
        
        const progressTableBody = document.getElementById("progressTableBody");
        const progressSidebarBody = document.getElementById("progressSidebarBody");
        
        if(!progressTableBody || !progressSidebarBody) {
            return;
        }
        
        progressTableBody.innerHTML = "";
        progressSidebarBody.innerHTML = "";
        
        let cumulativeWeight = 0;
        let cumulativeScore = 0;
        
        SECTIONS_WITH_WEIGHT.forEach(section => {
            const scoreData = sectionScores[section.section];
            let percentage = 0;
            if(scoreData.maxScore > 0) {
                percentage = Math.round(scoreData.score / scoreData.maxScore * 100);
            }
            
            let status = "Not Started";
            let statusClass = "bg-secondary";
            
            if(percentage === 100) {
                status = "Completed";
                statusClass = "bg-success";
            } else if(percentage > 0) {
                status = "In Progress";
                statusClass = "bg-warning";
            }
            
            cumulativeWeight += section.weight;
            cumulativeScore += section.weight * percentage / 100;
            
            progressTableBody.innerHTML += `<tr><td>${section.name}</td><td>${section.weight}%</td><td><span class="badge ${statusClass}">${status}</span></td><td>${percentage}%</td></tr>`;
            progressSidebarBody.innerHTML += `<tr><td>${section.name.split(" ")[0]}</td><td><span class="badge ${statusClass}">${status}</span></td><td>${percentage}%</td></tr>`;
        });
        
        const totalPercentage = cumulativeWeight > 0 ? Math.round(cumulativeScore / cumulativeWeight * 100) : 0;
        progressTableBody.innerHTML += `<tr class="table-primary fw-bold"><td>TOTAL</td><td>${cumulativeWeight}%</td><td></td><td>${totalPercentage}%</td></tr>`;
    }
    
    function exportToExcel(){
        saveProgress();
        const workbook = XLSX.utils.book_new();
        
        // Team Info Sheet
        const teamInfoData = [
            ["Team Information", ""],
            ["Team Name", assessmentData.teamInfo.teamName || ""],
            ["Region", assessmentData.teamInfo.region || ""],
            ["Country", assessmentData.teamInfo.country || ""],
            ["Mentor Name", assessmentData.teamInfo.mentorName || ""],
            [""],
            ["Headquarters Contact", ""],
            ["Name", assessmentData.teamInfo.hqName || ""],
            ["Email", assessmentData.teamInfo.hqEmail || ""],
            ["Phone", assessmentData.teamInfo.hqPhone || ""],
            ["Position", assessmentData.teamInfo.hqPosition || ""],
            [""],
            ["Operations Contact", ""],
            ["Name", assessmentData.teamInfo.opsName || ""],
            ["Email", assessmentData.teamInfo.opsEmail || ""],
            ["Phone", assessmentData.teamInfo.opsPhone || ""],
            ["Position", assessmentData.teamInfo.opsPosition || ""]
        ];
        
        const teamInfoSheet = XLSX.utils.aoa_to_sheet(teamInfoData);
        XLSX.utils.book_append_sheet(workbook, teamInfoSheet, "Team Info");
        
        // Assessment Data Sheet
        const assessmentDataArray = [["Standard ID", "Pillar", "Standard Statement", "Score", "Evidence", "Gaps", "Actions", "Comments"]];
        
        document.querySelectorAll(".score-select").forEach(select => {
            const row = select.closest("tr");
            const standardStatement = row.cells[0].textContent;
            const pillar = select.dataset.section;
            const standardId = select.dataset.section + "-" + select.dataset.item;
            
            assessmentDataArray.push([
                standardId,
                pillar,
                standardStatement,
                select.value || "",
                row.querySelector(".evidence-input")?.value || "",
                row.querySelector(".gaps-input")?.value || "",
                row.querySelector(".action-input")?.value || "",
                assessmentData.comments[pillar + "Comments"] || ""
            ]);
        });
        
        const assessmentSheet = XLSX.utils.aoa_to_sheet(assessmentDataArray);
        XLSX.utils.book_append_sheet(workbook, assessmentSheet, "HID SCT Assessment");
        
        // Summary Sheet
        const summaryData = [
            ["Assessment Summary", ""],
            ["Strengths", assessmentData.summary.strengths || ""],
            ["Critical Gaps", assessmentData.summary.criticalGaps || ""],
            ["Immediate Actions", assessmentData.summary.immediateActions || ""],
            ["Short Term Actions", assessmentData.summary.shortTermActions || ""],
            ["Medium Term Actions", assessmentData.summary.mediumTermActions || ""],
            ["Technical Assistance", assessmentData.summary.technicalAssistance || ""],
            ["Training Requirements", assessmentData.summary.trainingRequirements || ""],
            ["Resource Requirements", assessmentData.summary.resourceRequirements || ""],
            ["Next Steps", assessmentData.summary.nextSteps || ""],
            ["Completion Date", assessmentData.summary.completionDate || ""],
            ["Reviewed By", assessmentData.summary.reviewedBy || ""],
            ["Mentor Assignment", assessmentData.summary.mentorAssignment || ""]
        ];
        
        const summarySheet = XLSX.utils.aoa_to_sheet(summaryData);
        XLSX.utils.book_append_sheet(workbook, summarySheet, "Summary");
        
        XLSX.writeFile(workbook, "HID_SCT_Assessment_" + (new Date()).toISOString().split("T")[0] + ".xlsx");
        showNotification("Data exported to Excel successfully!");
    }
    
    function importFromExcel(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const workbook = XLSX.read(e.target.result, {type: 'binary'});
                
                // Reset assessment data
                assessmentData = {teamInfo: {}, scores: {}, evidence: {}, gaps: {}, actions: {}, comments: {}, summary: {}};
                
                // Parse Assessment sheet
                const assessmentSheet = workbook.Sheets['HID SCT Assessment'];
                if (assessmentSheet) {
                    const assessmentDataArray = XLSX.utils.sheet_to_json(assessmentSheet, {header: 1});
                    
                    // Skip header row and process data
                    for (let i = 1; i < assessmentDataArray.length; i++) {
                        const row = assessmentDataArray[i];
                        if (row && row.length >= 8) {
                            const standardId = row[0];
                            assessmentData.scores[standardId] = row[3] || '';
                            assessmentData.evidence[standardId] = row[4] || '';
                            assessmentData.gaps[standardId] = row[5] || '';
                            assessmentData.actions[standardId] = row[6] || '';
                            
                            // Handle comments for the section
                            const section = row[1];
                            if (section && row[7]) {
                                assessmentData.comments[section + 'Comments'] = row[7];
                            }
                        }
                    }
                }
                
                localStorage.setItem('hidSCTAssessment', JSON.stringify(assessmentData));
                loadSavedData();
                updateProgress();
                showNotification('Data imported successfully!');
                
            } catch (error) {
                console.error('Error importing Excel file:', error);
                showNotification('Error importing file. Please check the file format.');
            }
        };
        reader.readAsBinaryString(file);
    }
    
    function addAppEventListeners(){
        // Add event listeners to all form elements
        document.querySelectorAll("input, textarea, select").forEach(element => {
            element.addEventListener("change", saveProgress);
        });
        
        // Score select change handler
        document.addEventListener('change', function(e) {
            if (e.target.classList.contains('score-select')) {
                updateScoreBadge(e.target);
            }
        });
        
        // Button event listeners
        document.getElementById("btn-save").addEventListener("click", saveProgress);
        
        document.getElementById("btn-export-json").addEventListener("click", () => {
            saveProgress();
            const dataStr = JSON.stringify(assessmentData, null, 2);
            const dataBlob = new Blob([dataStr], {type: "application/json"});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement("a");
            link.href = url;
            link.download = "HID_SCT_Assessment_" + (new Date()).toISOString().split("T")[0] + ".json";
            link.click();
            URL.revokeObjectURL(url);
        });
        
        document.getElementById("btn-export-excel").addEventListener("click", exportToExcel);
        
        document.getElementById("btn-submit").addEventListener("click", () => {
            saveProgress();
            showNotification("Assessment submitted successfully!");
        });
        
        document.getElementById("btn-import-excel").addEventListener("click", () => {
            document.getElementById("data-file-input").click();
        });
        
        document.getElementById("data-file-input").addEventListener("change", function(event) {
            importFromExcel(event);
            // Reset the input to allow importing the same file again
            event.target.value = '';
        });
        
        // Tab navigation
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', function() {
                document.querySelectorAll('.nav-link').forEach(nav => nav.classList.remove('active'));
                this.classList.add('active');
            });
        });
    }
    
    // Main entry point for the entire page
    document.addEventListener("DOMContentLoaded", () => {
        const dropZone = document.getElementById('drop-zone');
        const configFileInput = document.getElementById('config-file-input');
        
        document.getElementById('load-config-btn').addEventListener('click', () => configFileInput.click());
        
        dropZone.addEventListener('dragover', (e) => { 
            e.preventDefault(); 
            dropZone.classList.add('dragover'); 
        });
        
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
        
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            if (e.dataTransfer.files.length > 0) {
                handleConfigFile(e.dataTransfer.files[0]);
            }
        });
        
        configFileInput.addEventListener('change', (event) => {
            if (event.target.files.length > 0) {
                handleConfigFile(event.target.files[0]);
            }
        });

        function handleConfigFile(file) {
            if (file && (file.type === 'application/json' || file.name.endsWith('.json'))) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const config = JSON.parse(e.target.result);
                        initializeApp(config);
                    } catch (error) {
                        alert('Error: El archivo de configuración no es un JSON válido.');
                    }
                };
                reader.readAsText(file);
            } else {
                alert('Por favor, selecciona o arrastra un archivo .json válido.');
            }
        }
    });
    </script>
</body>
</html>